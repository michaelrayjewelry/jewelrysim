<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>JEWELFORGE ‚Äî 3-Cycle Intelligence Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --gold:#c9a84c;--gold-l:#e8c97a;--gold-d:#8a6e30;--gold-x:#4a3a18;
  --bg:#060606;--s1:#0d0d0d;--s2:#141414;--s3:#1c1c1c;
  --txt:#e8e4dc;--dim:#8a8680;--faint:#3a3a38;--xfaint:#1e1e1e;
  --grn:#4caf7d;--red:#b5332a;--blu:#4a7fa8;--purp:#7b6fa8;
  --bdr:rgba(201,168,76,0.14);
}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--txt);font-family:'Rajdhani',sans-serif;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.02'/%3E%3C/svg%3E");pointer-events:none;z-index:9999;opacity:.6}

/* NAV */
nav{position:fixed;top:0;left:0;right:0;z-index:500;background:rgba(6,6,6,.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;padding:.9rem 2rem;gap:1rem;flex-wrap:wrap}
.nav-logo{font-family:'Cormorant Garamond',serif;font-size:1.05rem;letter-spacing:.38em;color:var(--gold);font-weight:300;flex-shrink:0}
.nav-tabs{display:flex;gap:2px}
.nav-tab{padding:.4rem 1rem;font-size:.65rem;letter-spacing:.2em;text-transform:uppercase;border:1px solid transparent;color:var(--faint);cursor:pointer;transition:all .2s;background:none;font-family:'Rajdhani',sans-serif}
.nav-tab:hover{color:var(--dim)}
.nav-tab.active{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,.05)}
.nav-tab.done{border-color:var(--gold-d);color:var(--gold-d)}
.nav-epoch{font-size:.65rem;letter-spacing:.2em;color:var(--faint);text-transform:uppercase}
.nav-epoch span{color:var(--gold);font-family:'Cormorant Garamond',serif;font-size:.9rem}

/* SCREENS */
main{padding-top:64px}
.screen{display:none;min-height:calc(100vh - 64px);padding:2.5rem 2rem;max-width:1140px;margin:0 auto}
.screen.active{display:block}

/* TYPOGRAPHY */
.eyebrow{font-size:.62rem;letter-spacing:.42em;color:var(--gold-d);text-transform:uppercase;margin-bottom:.7rem}
.h1{font-family:'Cormorant Garamond',serif;font-size:clamp(1.8rem,3.5vw,2.8rem);font-weight:300;line-height:1.1;margin-bottom:.4rem}
.h1 em{font-style:italic;color:var(--gold)}
.h2{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:400;margin-bottom:.8rem}
.h2 em{font-style:italic;color:var(--gold)}
.rule{width:36px;height:1px;background:var(--gold);margin:1rem 0 1.8rem}
.sub{color:var(--dim);font-size:.9rem;line-height:1.75;max-width:580px;margin-bottom:2rem}
.label{font-size:.6rem;letter-spacing:.3em;color:var(--gold-d);text-transform:uppercase;margin-bottom:.5rem}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.7rem 1.6rem;font-family:'Rajdhani',sans-serif;font-size:.75rem;font-weight:600;letter-spacing:.2em;text-transform:uppercase;border:1px solid var(--gold);color:var(--gold);background:transparent;cursor:pointer;transition:all .25s}
.btn:hover{background:rgba(201,168,76,.1)}
.btn-primary{background:var(--gold);color:var(--bg);border-color:var(--gold)}
.btn-primary:hover{background:var(--gold-l)}
.btn-ghost{border-color:var(--faint);color:var(--dim)}
.btn-ghost:hover{border-color:var(--dim);color:var(--txt)}
.btn:disabled{opacity:.4;cursor:not-allowed;pointer-events:none}
.btn-sm{padding:.4rem 1rem;font-size:.65rem}

/* ‚ïê‚ïê‚ïê SCREEN 1: BUILDER ‚ïê‚ïê‚ïê */
.builder-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem}
@media(max-width:720px){.builder-grid{grid-template-columns:1fr}}
.bsec{background:var(--s1);border:1px solid var(--bdr);padding:1.5rem}
.bsec h4{font-size:.6rem;letter-spacing:.32em;color:var(--gold-d);text-transform:uppercase;margin-bottom:1.1rem;padding-bottom:.6rem;border-bottom:1px solid var(--bdr)}
.field{margin-bottom:1.2rem}
.field label{display:block;font-size:.7rem;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;margin-bottom:.4rem}
.field input,.field textarea,.field select{width:100%;background:var(--s2);border:1px solid var(--faint);color:var(--txt);padding:.6rem .85rem;font-family:'Rajdhani',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;-webkit-appearance:none}
.field input:focus,.field textarea:focus,.field select:focus{border-color:var(--gold-d)}
.field textarea{resize:vertical;min-height:64px;line-height:1.6}
.field select option{background:var(--s2)}
.sr{display:flex;align-items:center;gap:.7rem;margin-bottom:.9rem}
.sr label{font-size:.75rem;color:var(--dim);flex:1}
.sr .sv{font-family:'Cormorant Garamond',serif;font-size:1rem;color:var(--gold);width:28px;text-align:right;flex-shrink:0}
input[type=range]{flex:1;-webkit-appearance:none;height:2px;background:var(--faint);outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;background:var(--gold);cursor:pointer}
.chips{display:flex;flex-wrap:wrap;gap:.35rem}
.chip{padding:.25rem .65rem;font-size:.62rem;letter-spacing:.1em;text-transform:uppercase;border:1px solid var(--faint);color:var(--faint);cursor:pointer;transition:all .2s;user-select:none}
.chip:hover{border-color:var(--dim);color:var(--dim)}
.chip.on{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,.06)}
.auto-link{font-size:.62rem;letter-spacing:.15em;color:var(--gold-d);text-decoration:underline;background:none;border:none;cursor:pointer;font-family:'Rajdhani',sans-serif}
.auto-link:hover{color:var(--gold)}
.preview-box{background:var(--s1);border:1px solid var(--bdr);padding:1.5rem;margin-top:1.5rem}
.prow{display:flex;align-items:baseline;gap:.8rem;margin-bottom:.45rem}
.plabel{font-size:.62rem;letter-spacing:.2em;color:var(--faint);text-transform:uppercase;width:86px;flex-shrink:0}
.pval{font-family:'Cormorant Garamond',serif;font-size:1.05rem;color:var(--txt)}
.dna-strip{display:flex;gap:3px;margin-top:.8rem;height:16px}
.dna-b{flex:1;transition:all .3s}

/* ‚ïê‚ïê‚ïê SCREEN 2: SIMULATOR ‚ïê‚ïê‚ïê */
.sim-topbar{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:1.8rem;gap:1rem;flex-wrap:wrap}
.cycle-indicator{display:flex;gap:8px;align-items:center}
.ci-dot{width:28px;height:28px;border:1px solid var(--faint);display:flex;align-items:center;justify-content:center;font-size:.6rem;letter-spacing:.1em;color:var(--faint);transition:all .4s;cursor:default}
.ci-dot.active{border-color:var(--gold);color:var(--gold);background:rgba(201,168,76,.08)}
.ci-dot.done{border-color:var(--grn);color:var(--grn);background:rgba(76,175,125,.06)}
.prog-bar{height:2px;background:var(--faint);margin-bottom:1.5rem;overflow:hidden}
.prog-fill{height:100%;background:linear-gradient(90deg,var(--gold-d),var(--gold));transition:width .6s ease;width:0%}
.phase-rail{display:flex;border:1px solid var(--bdr);margin-bottom:1.5rem;overflow-x:auto}
.pnode{flex:1;min-width:80px;padding:.7rem .4rem;text-align:center;background:var(--s1);border-right:1px solid var(--bdr);transition:all .3s}
.pnode:last-child{border-right:none}
.pnode.active{background:var(--s2);border-bottom:2px solid var(--gold)}
.pnode.done{background:rgba(76,175,125,.04);border-bottom:2px solid var(--grn)}
.pnode .pni{font-size:1rem;display:block;margin-bottom:.2rem}
.pnode .pnl{font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--faint)}
.pnode.active .pnl{color:var(--gold)}
.pnode.done .pnl{color:var(--grn)}
.sim-body{display:grid;grid-template-columns:220px 1fr;gap:1.5rem;min-height:360px}
@media(max-width:720px){.sim-body{grid-template-columns:1fr}}
.agents-col{background:var(--s1);border:1px solid var(--bdr);padding:1.2rem}
.agents-col h5{font-size:.58rem;letter-spacing:.3em;color:var(--gold-d);text-transform:uppercase;margin-bottom:1rem}
.arow{display:flex;align-items:center;gap:.6rem;padding:.5rem 0;border-bottom:1px solid var(--xfaint);transition:background .3s}
.arow:last-child{border-bottom:none}
.arow.highlight{background:rgba(201,168,76,.04)}
.av{width:26px;height:26px;border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;font-size:.85rem;flex-shrink:0}
.ai{flex:1;min-width:0}
.ai .an{font-size:.8rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ai .as{font-size:.68rem;color:var(--dim);margin-top:.05rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.acr{font-family:'Cormorant Garamond',serif;font-size:.95rem;color:var(--gold);flex-shrink:0;font-size:.82rem}
.log-col{background:var(--s1);border:1px solid var(--bdr);padding:1.2rem;display:flex;flex-direction:column}
.log-col h5{font-size:.58rem;letter-spacing:.3em;color:var(--gold-d);text-transform:uppercase;margin-bottom:1rem}
.log{flex:1;overflow-y:auto;max-height:320px;display:flex;flex-direction:column;gap:.35rem}
.log::-webkit-scrollbar{width:2px}
.log::-webkit-scrollbar-thumb{background:var(--gold-d)}
.le{font-size:.78rem;color:var(--dim);line-height:1.55;padding:.35rem .5rem;border-left:2px solid transparent;animation:slideIn .3s ease both}
.le.cv{border-left-color:var(--gold-d)}
.le.rp{border-left-color:var(--blu)}
.le.ds{border-left-color:var(--grn)}
.le.vt{border-left-color:var(--purp)}
.le.rs{border-left-color:var(--gold);color:var(--txt);font-weight:600}
.le .lt{font-size:.6rem;color:var(--faint);display:block;margin-bottom:.1rem}
.designs-wrap{margin-top:1.5rem}
.designs-wrap .dw-hdr{font-size:.58rem;letter-spacing:.35em;color:var(--gold-d);text-transform:uppercase;margin-bottom:.8rem}
.dgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1px;background:var(--bdr);border:1px solid var(--bdr)}
.dcard{background:var(--s1);transition:background .2s;overflow:hidden}
.dcard:hover{background:var(--s2)}
.dcard.winner-card{background:rgba(201,168,76,.06)}
/* inline card image */
.dcard-img-wrap{position:relative;width:100%;aspect-ratio:1;overflow:hidden;background:var(--s3);border-bottom:1px solid var(--bdr)}
.dcard-img{width:100%;height:100%;object-fit:cover;display:block;opacity:0;transition:opacity .7s ease}
.dcard-img.loaded{opacity:1}
.dcard-img-loader{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.4rem;background:linear-gradient(135deg,var(--s3) 0%,var(--s2) 50%,var(--s3) 100%);background-size:200% 200%;animation:shimmer2 2.5s ease infinite}
.dcard-img-loader.hidden{display:none}
.dcard-img-loader .di-gem{font-size:1.3rem;animation:pulse 1.5s infinite}
.dcard-img-loader .di-pct{font-family:'Cormorant Garamond',serif;font-size:.75rem;color:var(--gold-d);margin-top:.1rem}
.dcard-body{padding:.9rem}
@keyframes shimmer2{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
.dgem{font-size:1.4rem;text-align:center;margin-bottom:.4rem}
.dname{font-family:'Cormorant Garamond',serif;font-size:.9rem;text-align:center;margin-bottom:.15rem}
.dagent{font-size:.56rem;letter-spacing:.1em;color:var(--faint);text-transform:uppercase;text-align:center;margin-bottom:.5rem}
.dbar{display:flex;align-items:center;gap:.35rem;margin-bottom:.25rem}
.dbar-l{font-size:.58rem;color:var(--faint);width:24px}
.dbar-t{flex:1;height:2px;background:var(--faint)}
.dbar-f{height:100%;background:linear-gradient(90deg,var(--gold-d),var(--gold));transition:width .8s ease;width:0%}
.dcred{font-family:'Cormorant Garamond',serif;color:var(--gold);font-size:1rem;text-align:center;margin-top:.5rem}
.win-badge{font-size:.56rem;letter-spacing:.18em;color:var(--gold);border:1px solid var(--gold-d);padding:.12rem .4rem;display:block;text-align:center;text-transform:uppercase;margin-bottom:.3rem}
.sim-ctrl{display:flex;align-items:center;gap:.8rem;margin-top:1.2rem;flex-wrap:wrap}
.spd{display:flex;align-items:center;gap:.4rem;font-size:.62rem;letter-spacing:.15em;color:var(--dim);text-transform:uppercase}
.spd-btn{padding:.28rem .65rem;font-size:.62rem;border:1px solid var(--faint);color:var(--faint);background:none;cursor:pointer;font-family:'Rajdhani',sans-serif;transition:all .2s}
.spd-btn.on{border-color:var(--gold);color:var(--gold)}

/* ‚ïê‚ïê‚ïê DEPLOY PANEL ‚ïê‚ïê‚ïê */
.deploy-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bdr);border:1px solid var(--bdr);margin-top:1.5rem}
@media(max-width:720px){.deploy-grid{grid-template-columns:repeat(2,1fr)}}
.deploy-slot{background:var(--s1);padding:1.5rem;text-align:center;transition:all .4s}
.deploy-slot.deployed{background:rgba(201,168,76,.04);border-bottom:2px solid var(--gold)}
.deploy-slot.standby{opacity:.7}
.deploy-slot.standby:hover{opacity:1;background:var(--s2)}
.ds-emoji{font-size:1.8rem;margin-bottom:.5rem;transition:all .4s}
.ds-name{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--txt);margin-bottom:.15rem}
.ds-arch{font-size:.6rem;letter-spacing:.15em;color:var(--gold-d);text-transform:uppercase;margin-bottom:.5rem}
.ds-phil{font-size:.72rem;color:var(--dim);font-style:italic;margin-bottom:.4rem;line-height:1.5}
.ds-tags{font-size:.58rem;letter-spacing:.1em;color:var(--faint);text-transform:uppercase;margin-bottom:.8rem}
.ds-status{font-size:.62rem;letter-spacing:.2em;color:var(--gold);text-transform:uppercase;margin-top:.5rem}
.deploy-counter{font-size:.7rem;letter-spacing:.2em;color:var(--dim);text-transform:uppercase;margin-bottom:1rem}
@keyframes deployPulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
.deploy-slot.just-deployed .ds-emoji{animation:deployPulse .5s ease}

/* ‚ïê‚ïê‚ïê ROSTER PANEL ‚ïê‚ïê‚ïê */
.roster-row{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:1.2rem}
.roster-card{display:flex;align-items:center;gap:.5rem;background:var(--s1);border:1px solid var(--gold-d);padding:.4rem .8rem;animation:slideIn .3s ease both}
.rc-emoji{font-size:1.1rem}
.rc-info{min-width:0}
.rc-name{font-family:'Cormorant Garamond',serif;font-size:.85rem;color:var(--gold);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.rc-arch{font-size:.55rem;letter-spacing:.1em;color:var(--faint);text-transform:uppercase}

/* cycle-complete banner */
.cycle-complete{display:none;border:1px solid var(--gold-d);background:rgba(201,168,76,.04);padding:1.5rem;margin-top:1.5rem;animation:slideIn .5s ease}
.cycle-complete.show{display:block}
.cc-title{font-family:'Cormorant Garamond',serif;font-size:1.6rem;color:var(--gold);margin-bottom:.5rem}
.cc-sub{font-size:.85rem;color:var(--dim);margin-bottom:1.2rem}
.cc-winner{display:inline-flex;align-items:center;gap:.8rem;background:var(--s2);border:1px solid var(--bdr);padding:.8rem 1.2rem;margin-bottom:1.2rem}
.cc-winner-gem{font-size:1.5rem}
.cc-winner-name{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--gold)}
.cc-winner-by{font-size:.65rem;letter-spacing:.15em;color:var(--dim);text-transform:uppercase}
.cc-actions{display:flex;gap:.8rem;flex-wrap:wrap}

/* ‚ïê‚ïê‚ïê SCREEN 3: REPORTS ‚ïê‚ïê‚ïê */
.reports-layout{display:grid;grid-template-columns:200px 1fr;gap:1.5rem;min-height:70vh}
@media(max-width:720px){.reports-layout{grid-template-columns:1fr}}
.report-nav{background:var(--s1);border:1px solid var(--bdr);padding:1.2rem}
.report-nav h5{font-size:.58rem;letter-spacing:.3em;color:var(--gold-d);text-transform:uppercase;margin-bottom:1rem}
.rn-item{padding:.7rem .8rem;cursor:pointer;border:1px solid transparent;transition:all .2s;margin-bottom:2px}
.rn-item:hover{background:var(--s2)}
.rn-item.active{border-color:var(--gold-d);background:var(--s2)}
.rni-num{font-family:'Cormorant Garamond',serif;font-size:1.2rem;color:var(--gold);line-height:1}
.rni-label{font-size:.6rem;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;margin-top:.15rem}
.rni-winner{font-size:.65rem;color:var(--faint);margin-top:.2rem;font-style:italic}
.rn-empty{font-size:.72rem;color:var(--faint);font-style:italic;padding:.5rem 0}
.report-view{background:var(--s1);border:1px solid var(--bdr);padding:2rem;overflow-y:auto;max-height:80vh}
.report-placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;height:300px;color:var(--faint)}
.rp-icon{font-size:2.5rem;margin-bottom:1rem;opacity:.4}
.rp-msg{font-size:.8rem;letter-spacing:.2em;text-transform:uppercase}

/* REPORT DOCUMENT */
.rdoc{font-family:'Rajdhani',sans-serif}
.rdoc-header{border-bottom:1px solid var(--gold-d);padding-bottom:1.2rem;margin-bottom:1.5rem}
.rdoc-title{font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:300;color:var(--gold);margin-bottom:.3rem}
.rdoc-meta{font-size:.65rem;letter-spacing:.2em;color:var(--dim);text-transform:uppercase}
.rsec{margin-bottom:2rem}
.rsec-hdr{font-size:.62rem;letter-spacing:.35em;color:var(--gold-d);text-transform:uppercase;border-bottom:1px solid var(--bdr);padding-bottom:.4rem;margin-bottom:1rem}
.rtable{width:100%;border-collapse:collapse;font-size:.78rem}
.rtable th{font-size:.58rem;letter-spacing:.2em;text-transform:uppercase;color:var(--gold-d);border-bottom:1px solid var(--bdr);padding:.5rem .7rem;text-align:left;background:var(--s2)}
.rtable td{padding:.55rem .7rem;border-bottom:1px solid var(--xfaint);color:var(--dim);vertical-align:top;line-height:1.5}
.rtable tr:last-child td{border-bottom:none}
.rtable tr:hover td{background:rgba(201,168,76,.02)}
.rtable .highlight-row td{color:var(--txt)}
.rtable .gold{color:var(--gold);font-family:'Cormorant Garamond',serif;font-size:.9rem}
.rtable .grn{color:var(--grn)}
.rtable .red{color:var(--red)}
.trend-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--bdr);margin-bottom:1rem}
@media(max-width:600px){.trend-grid{grid-template-columns:1fr}}
.tcard{background:var(--s2);padding:1rem}
.tcard-label{font-size:.58rem;letter-spacing:.25em;color:var(--gold-d);text-transform:uppercase;margin-bottom:.5rem}
.tcard-val{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--txt)}
.tcard-val.up{color:var(--grn)}
.tcard-val.down{color:var(--red)}
.tcard-sub{font-size:.72rem;color:var(--faint);margin-top:.2rem}
.fi-box{background:rgba(201,168,76,.04);border:1px solid var(--gold-d);padding:1.2rem;margin-top:.5rem}
.fi-title{font-size:.6rem;letter-spacing:.3em;color:var(--gold);text-transform:uppercase;margin-bottom:.8rem}
.fi-item{display:flex;gap:.7rem;margin-bottom:.6rem;font-size:.8rem;color:var(--dim);line-height:1.55}
.fi-item::before{content:'‚óÜ';color:var(--gold-d);font-size:.5rem;margin-top:.35rem;flex-shrink:0}
.prompt-box{background:var(--s3);border:1px solid var(--faint);padding:.7rem;font-size:.72rem;color:var(--grn);font-family:'Courier New',monospace;line-height:1.6;margin-top:.25rem}
.strat-badge{display:inline-block;font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;padding:.15rem .5rem;border:1px solid}
.strat-exploit{border-color:var(--gold-d);color:var(--gold-d)}
.strat-explore{border-color:var(--blu);color:var(--blu)}
.strat-mutate{border-color:var(--purp);color:var(--purp)}
.exec-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(--bdr);border:1px solid var(--bdr);margin-bottom:1.5rem}
@media(max-width:600px){.exec-stats{grid-template-columns:repeat(2,1fr)}}
.es-item{background:var(--s2);padding:.9rem;text-align:center}
.es-val{font-family:'Cormorant Garamond',serif;font-size:1.5rem;color:var(--gold)}
.es-lbl{font-size:.58rem;letter-spacing:.2em;color:var(--faint);text-transform:uppercase;margin-top:.2rem}

/* ‚ïê‚ïê‚ïê IMAGE GALLERY ‚ïê‚ïê‚ïê */
.top3-gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bdr);border:1px solid var(--bdr);margin:1.2rem 0}
@media(max-width:640px){.top3-gallery{grid-template-columns:1fr}}
.top3-card{background:var(--s2);display:flex;flex-direction:column}
.top3-card.gold-card{background:rgba(201,168,76,.06);border-bottom:2px solid var(--gold)}
.top3-img-wrap{position:relative;width:100%;aspect-ratio:.85;overflow:hidden;background:var(--s3)}
.top3-img{width:100%;height:100%;object-fit:cover;display:block;transition:opacity .6s ease;opacity:0}
.top3-img.loaded{opacity:1}
@keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}
.top3-img-loader{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.6rem;background:linear-gradient(90deg,var(--s3) 25%,var(--s2) 50%,var(--s3) 75%);background-size:400px 100%;animation:shimmer 2s infinite linear}
.top3-img-loader .gem{font-size:1.6rem;animation:pulse 1.5s infinite}
.top3-img-loader .lbl{font-size:.58rem;letter-spacing:.25em;color:var(--faint);text-transform:uppercase}
.top3-img-loader .pct{font-family:'Cormorant Garamond',serif;font-size:.9rem;color:var(--gold-d)}
.top3-img-loader.hidden{display:none}
.top3-meta{padding:1rem}
.top3-rank{font-size:.6rem;letter-spacing:.25em;color:var(--gold-d);text-transform:uppercase;margin-bottom:.3rem}
.top3-rank.first{color:var(--gold)}
.top3-name{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--txt);margin-bottom:.2rem}
.top3-by{font-size:.62rem;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;margin-bottom:.6rem}
.top3-creds{font-family:'Cormorant Garamond',serif;font-size:1.2rem;color:var(--gold)}
.top3-creds-lbl{font-size:.58rem;color:var(--faint);letter-spacing:.15em;text-transform:uppercase}
.top3-strat{display:inline-block;font-size:.56rem;letter-spacing:.12em;text-transform:uppercase;padding:.1rem .4rem;border:1px solid;margin-top:.4rem}
.img-gen-status{font-size:.7rem;color:var(--dim);letter-spacing:.1em;margin-bottom:.8rem;display:flex;align-items:center;gap:.5rem}
.img-gen-status .dot{width:6px;height:6px;background:var(--gold);border-radius:50%;animation:pulse 1s infinite;flex-shrink:0}
.img-gen-status .dot.done{background:var(--grn);animation:none}

/* Report image strip */
.rdoc-top3{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bdr);margin-bottom:1.5rem}
@media(max-width:580px){.rdoc-top3{grid-template-columns:1fr}}
.rdoc-imgcard{background:var(--s2)}
.rdoc-imgcard.rank1{border-top:2px solid var(--gold)}
.rdoc-imgcard.rank2{border-top:2px solid var(--dim)}
.rdoc-imgcard.rank3{border-top:2px solid var(--faint)}
.rdoc-img-wrap{width:100%;aspect-ratio:.85;overflow:hidden;background:var(--s3);position:relative}
.rdoc-img{width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .5s}
.rdoc-img.loaded{opacity:1}
.rdoc-img-placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:2rem;background:var(--s3)}
.rdoc-img-placeholder.hidden{display:none}
.rdoc-card-meta{padding:.8rem}
.rdoc-rank-badge{font-size:.58rem;letter-spacing:.22em;color:var(--faint);text-transform:uppercase;margin-bottom:.25rem}
.rdoc-rank-badge.r1{color:var(--gold)}
.rdoc-design-name{font-family:'Cormorant Garamond',serif;font-size:.95rem;color:var(--txt)}
.rdoc-design-by{font-size:.6rem;color:var(--dim);margin-top:.1rem}
.rdoc-design-creds{font-family:'Cormorant Garamond',serif;font-size:1rem;color:var(--gold);margin-top:.3rem}

/* ‚îÄ‚îÄ KPI STRIP ‚îÄ‚îÄ */
.kpi-strip{display:grid;grid-template-columns:repeat(6,1fr);gap:1px;background:var(--bdr);border:1px solid var(--bdr);margin-bottom:1.5rem}
@media(max-width:700px){.kpi-strip{grid-template-columns:repeat(3,1fr)}}
.kpi-cell{background:var(--s2);padding:.8rem .6rem;text-align:center}
.kpi-val{font-family:'Cormorant Garamond',serif;font-size:1.35rem;color:var(--gold);line-height:1}
.kpi-val.up{color:var(--grn)}
.kpi-val.down{color:var(--red)}
.kpi-val.neu{color:var(--txt)}
.kpi-lbl{font-size:.54rem;letter-spacing:.18em;color:var(--faint);text-transform:uppercase;margin-top:.3rem}

/* ‚îÄ‚îÄ CORR BARS ‚îÄ‚îÄ */
.corr-panel{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bdr);margin-bottom:1rem}
.corr-card{background:var(--s2);padding:1rem}
.corr-dim{font-size:.58rem;letter-spacing:.22em;color:var(--gold-d);text-transform:uppercase;margin-bottom:.6rem}
.corr-bar-track{height:6px;background:var(--faint);border-radius:3px;overflow:hidden;margin-bottom:.4rem}
.corr-bar-fill{height:100%;border-radius:3px;transition:width .8s ease}
.corr-bar-fill.aes{background:linear-gradient(90deg,var(--gold-d),var(--gold))}
.corr-bar-fill.nov{background:linear-gradient(90deg,#4a7fa8,#7bb8d4)}
.corr-bar-fill.pro{background:linear-gradient(90deg,#4caf7d,#7be0a8)}
.corr-r{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--txt)}
.corr-note{font-size:.65rem;color:var(--faint);margin-top:.2rem}
.corr-winner-badge{display:inline-block;font-size:.55rem;letter-spacing:.15em;color:var(--gold);border:1px solid var(--gold-d);padding:.1rem .4rem;text-transform:uppercase;margin-top:.3rem}

/* ‚îÄ‚îÄ STRATEGY BATTLE ‚îÄ‚îÄ */
.strat-battle{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bdr);margin-bottom:1rem}
.sb-card{background:var(--s2);padding:1rem;position:relative}
.sb-card.sb-winner{background:rgba(201,168,76,.06)}
.sb-label{font-size:.58rem;letter-spacing:.2em;text-transform:uppercase;margin-bottom:.5rem}
.sb-creds{font-family:'Cormorant Garamond',serif;font-size:1.4rem;margin-bottom:.2rem}
.sb-sub{font-size:.65rem;color:var(--faint)}
.sb-win-flag{position:absolute;top:.6rem;right:.6rem;font-size:.52rem;letter-spacing:.12em;color:var(--gold);border:1px solid var(--gold-d);padding:.1rem .35rem;text-transform:uppercase}

/* ‚îÄ‚îÄ CATEGORY HEAT MAP ‚îÄ‚îÄ */
.cat-heat{width:100%;border-collapse:collapse;font-size:.78rem;margin-bottom:.5rem}
.cat-heat th{font-size:.56rem;letter-spacing:.18em;text-transform:uppercase;color:var(--gold-d);border-bottom:1px solid var(--bdr);padding:.5rem .7rem;text-align:left;background:var(--s2)}
.cat-heat td{padding:.55rem .7rem;border-bottom:1px solid var(--xfaint);color:var(--dim);vertical-align:middle}
.cat-heat tr:hover td{background:rgba(201,168,76,.02)}
.mini-bar{display:inline-block;height:4px;border-radius:2px;vertical-align:middle;margin-right:.4rem}

/* ‚îÄ‚îÄ AGENT LEADERBOARD ‚îÄ‚îÄ */
.agent-lb{width:100%;border-collapse:collapse;font-size:.78rem}
.agent-lb th{font-size:.56rem;letter-spacing:.18em;text-transform:uppercase;color:var(--gold-d);border-bottom:1px solid var(--bdr);padding:.5rem .7rem;background:var(--s2)}
.agent-lb td{padding:.55rem .7rem;border-bottom:1px solid var(--xfaint);color:var(--dim);vertical-align:middle}
.agent-lb tr:first-child td{color:var(--txt)}
.agent-lb .rank-num{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--faint);text-align:center}
.agent-lb .rank-num.r1{color:var(--gold)}
.agent-lb .rep-delta{font-size:.72rem}
.agent-lb .rep-up{color:var(--grn)}
.agent-lb .rep-dn{color:var(--red)}
.agent-lb .you-badge{font-size:.5rem;letter-spacing:.1em;color:var(--gold);border:1px solid var(--gold-d);padding:.05rem .3rem;margin-left:.3rem;text-transform:uppercase;vertical-align:middle}

/* ‚îÄ‚îÄ VOTE FLOW ‚îÄ‚îÄ */
.vflow-table{width:100%;border-collapse:collapse;font-size:.72rem}
.vflow-table th{font-size:.54rem;letter-spacing:.16em;text-transform:uppercase;color:var(--gold-d);border-bottom:1px solid var(--bdr);padding:.45rem .6rem;background:var(--s2)}
.vflow-table td{padding:.45rem .6rem;border-bottom:1px solid var(--xfaint);color:var(--dim);vertical-align:top}
.vflow-table tr:hover td{background:rgba(201,168,76,.02)}
.vf-alloc{display:inline-block;background:rgba(201,168,76,.08);border:1px solid var(--gold-x);padding:.1rem .4rem;font-size:.65rem;margin:.05rem .1rem .05rem 0;white-space:nowrap}
.vf-self{background:rgba(181,51,42,.08);border-color:rgba(181,51,42,.3);color:var(--red)}
.vote-insight{background:var(--s2);border:1px solid var(--bdr);padding:.8rem 1rem;font-size:.78rem;color:var(--dim);line-height:1.65;margin-top:.8rem}
.vote-insight b{color:var(--txt)}

/* ‚îÄ‚îÄ TREND VELOCITY ‚îÄ‚îÄ */
.trend-vel{display:flex;align-items:center;gap:1rem;margin-bottom:1rem}
.vel-meter{flex:1;height:8px;background:var(--faint);border-radius:4px;overflow:hidden}
.vel-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--gold-d),var(--gold-l));transition:width 1s ease}
.vel-score{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--gold);flex-shrink:0;width:44px;text-align:right}
.vel-label{font-size:.6rem;letter-spacing:.18em;color:var(--faint);text-transform:uppercase;flex-shrink:0;width:60px}
.trend-4grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1px;background:var(--bdr)}
@media(max-width:500px){.trend-4grid{grid-template-columns:1fr}}

/* ‚îÄ‚îÄ EPOCH ARC (Cycle 3 only) ‚îÄ‚îÄ */
.epoch-arc{border:1px solid var(--gold-d);background:rgba(201,168,76,.03);padding:1.5rem;margin-bottom:1rem}
.epoch-arc-title{font-family:'Cormorant Garamond',serif;font-size:1.2rem;color:var(--gold);margin-bottom:1rem}
.epoch-timeline{display:grid;grid-template-columns:repeat(3,1fr);gap:0;background:var(--bdr)}
.et-node{background:var(--s2);padding:1rem;text-align:center;position:relative}
.et-node::after{content:'‚Üí';position:absolute;right:-10px;top:50%;transform:translateY(-50%);color:var(--gold-d);font-size:.9rem;z-index:1}
.et-node:last-child::after{display:none}
.et-cycle{font-size:.55rem;letter-spacing:.25em;color:var(--gold-d);text-transform:uppercase;margin-bottom:.4rem}
.et-winner{font-family:'Cormorant Garamond',serif;font-size:.9rem;color:var(--txt);margin-bottom:.2rem}
.et-trend{font-size:.65rem;color:var(--dim)}
.et-creds{font-family:'Cormorant Garamond',serif;font-size:1.1rem;color:var(--gold);margin-top:.3rem}
.epoch-insight{font-size:.82rem;color:var(--dim);line-height:1.75;margin-top:1.2rem;padding-top:1rem;border-top:1px solid var(--bdr)}
.epoch-insight b{color:var(--txt)}

/* ANIMATIONS */
@keyframes slideIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
.fade{animation:fadeIn .4s ease both}
.pulse{animation:pulse 1.5s infinite}

/* ‚ïê‚ïê‚ïê HOME / API KEY SCREEN ‚ïê‚ïê‚ïê */
.home-hero{text-align:center;padding:3rem 0 2rem}
.home-hero .h1{margin-bottom:.6rem}
.home-hero .sub{margin:0 auto 2rem;text-align:center}
.mode-toggle{display:flex;gap:0;border:1px solid var(--bdr);margin:0 auto 2rem;max-width:380px}
.mode-btn{flex:1;padding:.75rem 1rem;font-family:'Rajdhani',sans-serif;font-size:.68rem;font-weight:600;letter-spacing:.18em;text-transform:uppercase;background:var(--s1);color:var(--faint);border:none;cursor:pointer;transition:all .25s}
.mode-btn.active{background:rgba(201,168,76,.1);color:var(--gold);border-bottom:2px solid var(--gold)}
.api-panel{background:var(--s1);border:1px solid var(--bdr);padding:1.8rem;max-width:520px;margin:0 auto 2rem;display:none}
.api-panel.show{display:block}
.api-panel h4{font-size:.6rem;letter-spacing:.32em;color:var(--gold-d);text-transform:uppercase;margin-bottom:1.1rem;padding-bottom:.6rem;border-bottom:1px solid var(--bdr)}
.api-field{margin-bottom:1.2rem}
.api-field label{display:block;font-size:.7rem;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;margin-bottom:.4rem}
.api-field input{width:100%;background:var(--s2);border:1px solid var(--faint);color:var(--txt);padding:.6rem .85rem;font-family:'Rajdhani',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s}
.api-field input:focus{border-color:var(--gold-d)}
.api-field .api-hint{font-size:.65rem;color:var(--faint);margin-top:.3rem;line-height:1.5}
.api-status{display:flex;align-items:center;gap:.5rem;font-size:.7rem;color:var(--dim);margin-top:.5rem}
.api-status .dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.api-status .dot.ok{background:var(--grn)}
.api-status .dot.warn{background:var(--gold)}
.api-status .dot.off{background:var(--faint)}
.sim-mode-badge{display:inline-flex;align-items:center;gap:.4rem;font-size:.58rem;letter-spacing:.18em;text-transform:uppercase;padding:.25rem .65rem;border:1px solid;margin-left:.8rem}
.sim-mode-badge.live{border-color:var(--grn);color:var(--grn);background:rgba(76,175,125,.06)}
.sim-mode-badge.sim{border-color:var(--faint);color:var(--faint)}

/* ‚ïê‚ïê‚ïê GENOME EVOLUTION CARDS ‚ïê‚ïê‚ïê */
.genome-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--bdr);border:1px solid var(--bdr);margin-bottom:1rem}
@media(max-width:700px){.genome-grid{grid-template-columns:repeat(2,1fr)}}
.genome-card{background:var(--s2);padding:1rem}
.genome-card-hdr{display:flex;align-items:center;gap:.5rem;margin-bottom:.7rem}
.genome-card-hdr .gc-emoji{font-size:1.1rem}
.genome-card-hdr .gc-name{font-family:'Cormorant Garamond',serif;font-size:.92rem;color:var(--txt)}
.genome-card-hdr .gc-badge{font-size:.5rem;letter-spacing:.1em;color:var(--gold);border:1px solid var(--gold-d);padding:.05rem .3rem;text-transform:uppercase;margin-left:auto}
.genome-delta{display:flex;align-items:center;gap:.4rem;margin-bottom:.35rem;font-size:.72rem;color:var(--dim)}
.genome-delta .gd-label{width:68px;flex-shrink:0;font-size:.62rem;letter-spacing:.08em;color:var(--faint);text-transform:uppercase}
.genome-delta .gd-bar{flex:1;height:3px;background:var(--faint);border-radius:2px;overflow:hidden;position:relative}
.genome-delta .gd-fill{height:100%;border-radius:2px;transition:width .8s ease}
.genome-delta .gd-arrow{font-size:.65rem;width:20px;text-align:center;flex-shrink:0}
.genome-delta .gd-arrow.up{color:var(--grn)}
.genome-delta .gd-arrow.down{color:var(--red)}
.genome-delta .gd-arrow.flat{color:var(--faint)}
.genome-tags{display:flex;flex-wrap:wrap;gap:.2rem;margin-top:.5rem}
.genome-tags .gt{font-size:.55rem;letter-spacing:.08em;text-transform:uppercase;padding:.1rem .35rem;border:1px solid var(--faint);color:var(--faint)}
.genome-tags .gt.new{border-color:var(--grn);color:var(--grn)}
.genome-tags .gt.lost{border-color:var(--red);color:var(--red);text-decoration:line-through}
.gc-belief{font-size:.65rem;color:var(--dim);margin-top:.5rem;font-style:italic;line-height:1.5}
.gc-belief b{color:var(--txt);font-style:normal}
.gc-summary{font-size:.62rem;color:var(--faint);margin-top:.4rem;line-height:1.5;padding-top:.4rem;border-top:1px solid var(--xfaint)}
.gc-result-badge{display:inline-block;font-size:.5rem;letter-spacing:.1em;text-transform:uppercase;padding:.08rem .3rem;margin-left:.3rem}
.gc-result-badge.win{border:1px solid var(--gold);color:var(--gold)}
.gc-result-badge.loss{border:1px solid var(--red);color:var(--red)}

/* ‚ïê‚ïê‚ïê DIALOGUE BUBBLES ‚ïê‚ïê‚ïê */
.dialogue-thread{background:var(--s2);border:1px solid var(--bdr);padding:1rem;margin:.6rem 0;border-radius:2px}
.dialogue-thread .dt-hdr{font-size:.58rem;letter-spacing:.25em;color:var(--gold-d);text-transform:uppercase;margin-bottom:.6rem}
.dialogue-msg{display:flex;gap:.5rem;margin-bottom:.5rem;animation:slideIn .3s ease both}
.dialogue-msg .dm-avatar{width:22px;height:22px;border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;font-size:.75rem;flex-shrink:0}
.dialogue-msg .dm-body{flex:1;font-size:.76rem;color:var(--dim);line-height:1.55;background:var(--s1);padding:.4rem .6rem;border:1px solid var(--xfaint)}
.dialogue-msg .dm-body b{color:var(--txt)}
</style>
</head>
<body>

<nav>
  <div class="nav-logo">JewelForge</div>
  <div class="nav-tabs">
    <button class="nav-tab active" id="nt0" onclick="goTo(0)">Home</button>
    <button class="nav-tab" id="nt1" onclick="goTo(1)">‚ë† Build Agent</button>
    <button class="nav-tab" id="nt2" onclick="goTo(2)">‚ë° Run Cycles</button>
    <button class="nav-tab" id="nt3" onclick="goTo(3)">‚ë¢ Intelligence Reports</button>
  </div>
  <div class="nav-epoch">Epoch: <span id="nav-epoch-txt">0 / 3</span> cycles</div>
</nav>

<main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 0: HOME / API KEYS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen-0">
  <div class="home-hero">
    <div class="eyebrow">Intelligence Engine</div>
    <h1 class="h1">Welcome to <em>JewelForge</em></h1>
    <div class="rule" style="margin:1rem auto 1.8rem"></div>
    <p class="sub">Configure your simulation mode below. In <b>Live AI Mode</b>, agents use real LLM calls ‚Äî their full genome, conversation history, and prior intelligence reports are compiled into every prompt. In <b>Simulation Mode</b>, the engine runs pre-scripted narratives with deterministic outcomes.</p>
  </div>

  <div class="mode-toggle">
    <button class="mode-btn active" id="mode-sim" onclick="setMode('sim')">Simulation Mode</button>
    <button class="mode-btn" id="mode-live" onclick="setMode('live')">Live AI Mode</button>
  </div>

  <div class="api-panel" id="api-panel">
    <h4>API Configuration</h4>
    <div class="api-field">
      <label>Anthropic API Key &nbsp;<span style="color:var(--gold-d);font-size:.55rem;letter-spacing:.08em">‚Äî Language &amp; Intelligence</span></label>
      <input type="password" id="api-anthropic" placeholder="sk-ant-..." oninput="checkApiKeys()">
      <div class="api-hint">Powers all agent dialogue, cross-pollination, synthesis, and design reasoning via Claude</div>
    </div>
    <div class="api-field">
      <label>Higgsfield API Key &nbsp;<span style="color:var(--gold-d);font-size:.55rem;letter-spacing:.08em">‚Äî Image Generation</span></label>
      <input type="password" id="api-higgsfield" placeholder="KEY_ID:KEY_SECRET" oninput="checkApiKeys()">
      <div class="api-hint">Generates jewelry renders from agent design prompts via Higgsfield SOUL / Flux models</div>
    </div>
    <div class="api-status" id="api-status">
      <div class="dot off" id="api-dot"></div>
      <span id="api-status-text">Enter API keys to enable Live AI Mode</span>
    </div>
    <div style="text-align:center;margin-top:1.2rem;display:flex;align-items:center;justify-content:center;gap:1.2rem">
      <button class="btn btn-primary btn-sm" id="api-submit-btn" onclick="submitApiKeys()" disabled>Submit API Keys</button>
      <button class="auto-link" id="api-clear-btn" onclick="clearSavedKeys()" style="display:none;font-size:.65rem;color:var(--faint)">Clear Saved Keys</button>
    </div>
  </div>

  <div style="text-align:center">
    <button class="btn btn-primary" id="home-start-btn" onclick="startFromHome()">Begin Agent Configuration ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 1: BUILDER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-1">
  <div style="display:flex;align-items:baseline;justify-content:space-between;flex-wrap:wrap;gap:.5rem">
    <div class="eyebrow">Agent Configuration</div>
    <div class="eyebrow" id="agent-counter" style="color:var(--gold)">Agent 1 of 6 &nbsp;<span id="agent-emoji">üéØ</span></div>
  </div>
  <h1 class="h1" id="builder-title">Design your <em>autonomous agent.</em></h1>
  <div class="rule"></div>
  <p class="sub" id="builder-sub">Configure identity, aesthetic biases, and risk genome. These traits shape every decision your agent makes across all 3 cycles ‚Äî and evolve based on what it learns.</p>

  <div id="roster-wrap" style="display:none">
    <div class="label">Deployed Agents</div>
    <div id="agent-roster" class="roster-row"></div>
  </div>

  <div class="builder-grid">
    <div>
      <div class="bsec">
        <h4>Identity &nbsp;<button class="auto-link" onclick="autoGen()">‚ú¶ Auto-Generate</button></h4>
        <div class="field"><label>Agent Name</label><input id="b-name" placeholder="e.g. Maren Vex" oninput="updatePreview()"></div>
        <div class="field">
          <label>Archetype</label>
          <select id="b-arch" onchange="updatePreview()">
            <option value="">‚Äî Select ‚Äî</option>
            <option>Avant-Garde Purist</option><option>High Jewelry Romantic</option>
            <option>Industrial Innovator</option><option>Market Strategist</option>
            <option>Minimalist Architect</option><option>Heritage Revivalist</option>
            <option>Street Luxury Provocateur</option><option>Nature Mystic</option>
          </select>
        </div>
        <div class="field"><label>Design Philosophy</label><textarea id="b-phil" placeholder="What drives your agent's design decisions‚Ä¶" oninput="updatePreview()"></textarea></div>
      </div>
      <div class="bsec" style="margin-top:1px">
        <h4>Style Tags &nbsp;<span style="color:var(--faint);font-weight:300;font-size:.65rem">up to 5</span></h4>
        <div class="chips" id="style-chips">
          <div class="chip" onclick="toggleChip(this,'sc')">minimal</div><div class="chip" onclick="toggleChip(this,'sc')">maximalist</div>
          <div class="chip" onclick="toggleChip(this,'sc')">architectural</div><div class="chip" onclick="toggleChip(this,'sc')">organic</div>
          <div class="chip" onclick="toggleChip(this,'sc')">brutalist</div><div class="chip" onclick="toggleChip(this,'sc')">haute-joaillerie</div>
          <div class="chip" onclick="toggleChip(this,'sc')">floral</div><div class="chip" onclick="toggleChip(this,'sc')">geometric</div>
          <div class="chip" onclick="toggleChip(this,'sc')">industrial</div><div class="chip" onclick="toggleChip(this,'sc')">avant-garde</div>
          <div class="chip" onclick="toggleChip(this,'sc')">vintage</div><div class="chip" onclick="toggleChip(this,'sc')">sculptural</div>
          <div class="chip" onclick="toggleChip(this,'sc')">negative-space</div><div class="chip" onclick="toggleChip(this,'sc')">editorial</div>
        </div>
      </div>
      <div class="bsec" style="margin-top:1px">
        <h4>Market Focus</h4>
        <div class="chips" id="mkt-chips">
          <div class="chip" onclick="toggleChip(this,'mc')">bridal</div><div class="chip" onclick="toggleChip(this,'mc')">mens</div>
          <div class="chip" onclick="toggleChip(this,'mc')">high jewelry</div><div class="chip" onclick="toggleChip(this,'mc')">everyday</div>
          <div class="chip" onclick="toggleChip(this,'mc')">collectible</div><div class="chip" onclick="toggleChip(this,'mc')">avant-garde</div>
        </div>
      </div>
    </div>

    <div>
      <div class="bsec">
        <h4>Style Genome</h4>
        <div class="sr"><label>Minimalism</label><input type="range" min="0" max="100" value="50" id="s-min" oninput="sv(this,'sv-min');updatePreview()"><span class="sv" id="sv-min">50</span></div>
        <div class="sr"><label>Novelty Drive</label><input type="range" min="0" max="100" value="50" id="s-nov" oninput="sv(this,'sv-nov');updatePreview()"><span class="sv" id="sv-nov">50</span></div>
        <div class="sr"><label>Ornamentation</label><input type="range" min="0" max="100" value="50" id="s-orn" oninput="sv(this,'sv-orn');updatePreview()"><span class="sv" id="sv-orn">50</span></div>
        <div class="sr"><label>Market Fit Priority</label><input type="range" min="0" max="100" value="50" id="s-mkt" oninput="sv(this,'sv-mkt');updatePreview()"><span class="sv" id="sv-mkt">50</span></div>
        <div class="sr"><label>Symmetry Preference</label><input type="range" min="0" max="100" value="60" id="s-sym" oninput="sv(this,'sv-sym');updatePreview()"><span class="sv" id="sv-sym">60</span></div>
      </div>
      <div class="bsec" style="margin-top:1px">
        <h4>Material Genome</h4>
        <div class="sr"><label>Platinum Bias</label><input type="range" min="0" max="100" value="50" id="s-plt" oninput="sv(this,'sv-plt');updatePreview()"><span class="sv" id="sv-plt">50</span></div>
        <div class="sr"><label>Colored Stone Use</label><input type="range" min="0" max="100" value="40" id="s-col" oninput="sv(this,'sv-col');updatePreview()"><span class="sv" id="sv-col">40</span></div>
        <div class="sr"><label>Diamond Preference</label><input type="range" min="0" max="100" value="60" id="s-dia" oninput="sv(this,'sv-dia');updatePreview()"><span class="sv" id="sv-dia">60</span></div>
        <div class="sr"><label>Mixed / Accent Metals</label><input type="range" min="0" max="100" value="30" id="s-mix" oninput="sv(this,'sv-mix');updatePreview()"><span class="sv" id="sv-mix">30</span></div>
      </div>
      <div class="bsec" style="margin-top:1px">
        <h4>Risk Genome</h4>
        <div class="sr"><label>Exploration ‚Üî Exploitation</label><input type="range" min="0" max="100" value="50" id="s-rsk" oninput="sv(this,'sv-rsk');updatePreview()"><span class="sv" id="sv-rsk">50</span></div>
        <div style="display:flex;justify-content:space-between;font-size:.6rem;color:var(--faint);margin-bottom:.8rem;margin-top:-.4rem;"><span>Conservative</span><span>Aggressive</span></div>
        <div class="sr"><label>Margin Sensitivity</label><input type="range" min="0" max="100" value="65" id="s-mrg" oninput="sv(this,'sv-mrg');updatePreview()"><span class="sv" id="sv-mrg">65</span></div>
        <div class="sr"><label>Complexity Budget</label><input type="range" min="0" max="100" value="55" id="s-cmp" oninput="sv(this,'sv-cmp');updatePreview()"><span class="sv" id="sv-cmp">55</span></div>
      </div>
    </div>
  </div>

  <div class="preview-box">
    <div class="label">Live Agent Preview</div>
    <div class="prow"><span class="plabel">Identity</span><span class="pval" id="pv-id">‚Äî</span></div>
    <div class="prow"><span class="plabel">Style Tags</span><span class="pval" style="font-size:.82rem;color:var(--dim)" id="pv-tags">‚Äî</span></div>
    <div class="prow"><span class="plabel">Strategy Bias</span><span class="pval" id="pv-strat">‚Äî</span></div>
    <div class="prow"><span class="plabel">Market Focus</span><span class="pval" id="pv-mkt">‚Äî</span></div>
    <div class="label" style="margin-top:.8rem">Style DNA</div>
    <div class="dna-strip" id="pv-dna"></div>
  </div>

  <div style="display:flex;gap:.8rem;margin-top:1.5rem;flex-wrap:wrap">
    <button class="btn btn-primary" id="deploy-btn" onclick="deployCurrentAgent()">Deploy Agent 1 ‚Üí Configure Next</button>
    <button class="btn btn-ghost" onclick="autoGen()">‚ú¶ Auto-Generate</button>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 2: SIMULATOR
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-2">
  <div id="deploy-panel" style="display:none"></div>
  <div id="sim-main">
  <div class="sim-topbar">
    <div>
      <div class="eyebrow">Cycle Simulator</div>
      <h2 class="h1">Cycle <em id="sim-cycle-num">01</em> &nbsp;<span style="font-family:'Rajdhani',sans-serif;font-size:1rem;color:var(--faint)">of 3</span><span class="sim-mode-badge sim" id="mode-badge">SIM</span></h2>
    </div>
    <div style="text-align:right">
      <div style="font-size:.58rem;letter-spacing:.25em;color:var(--faint);text-transform:uppercase;margin-bottom:.4rem">Epoch Progress</div>
      <div class="cycle-indicator" id="ci">
        <div class="ci-dot" id="cid-1">C1</div>
        <div style="width:20px;height:1px;background:var(--faint)"></div>
        <div class="ci-dot" id="cid-2">C2</div>
        <div style="width:20px;height:1px;background:var(--faint)"></div>
        <div class="ci-dot" id="cid-3">C3</div>
      </div>
    </div>
  </div>

  <div class="prog-bar"><div class="prog-fill" id="prog"></div></div>

  <div class="phase-rail">
    <div class="pnode active" id="ph0"><span class="pni">üí¨</span><span class="pnl">Cross-Pollination</span></div>
    <div class="pnode" id="ph1"><span class="pni">üß†</span><span class="pnl">Synthesis</span></div>
    <div class="pnode" id="ph2"><span class="pni">üíé</span><span class="pnl">Generation</span></div>
    <div class="pnode" id="ph3"><span class="pni">‚öñÔ∏è</span><span class="pnl">Voting</span></div>
    <div class="pnode" id="ph4"><span class="pni">üìà</span><span class="pnl">Evolution</span></div>
  </div>

  <div class="sim-body">
    <div class="agents-col">
      <h5>Active Agents</h5>
      <div id="agents-col-body"></div>
    </div>
    <div class="log-col">
      <h5>Cycle Activity</h5>
      <div class="log" id="act-log"></div>
    </div>
  </div>

  <div class="designs-wrap" id="designs-wrap" style="display:none">
    <div class="dw-hdr">Submitted Designs ‚Äî Cycle <span id="dw-cycle">01</span></div>
    <div class="dgrid" id="dgrid"></div>
  </div>

  <div class="cycle-complete" id="cc-panel">
    <div class="cc-title">Cycle <span id="cc-num">01</span> Complete</div>
    <div class="cc-sub" id="cc-sub">Consensus reached. Intelligence report generated.</div>

    <div style="margin-bottom:1rem">
      <div class="eyebrow" style="margin-bottom:.3rem">Top 3 Designs ‚Äî AI-Generated Images</div>
      <div style="font-size:.75rem;color:var(--faint);margin-bottom:.7rem;line-height:1.5">Images rendered from each agent's final image generation prompt via Flux AI. Images load sequentially to avoid rate limits ‚Äî allow 15‚Äì30 seconds per image.</div>
      <div class="img-gen-status" id="img-gen-status">
        <div class="dot" id="img-dot"></div>
        <span id="img-gen-label">Generating images from agent prompts‚Ä¶</span>
      </div>
      <div class="top3-gallery" id="top3-gallery"></div>
    </div>

    <div class="cc-actions">
      <button class="btn btn-primary" id="cc-next-btn">‚ñ∂ Begin Cycle 2</button>
      <button class="btn" onclick="viewReport(currentCycle-1)">üìÑ View Cycle Report</button>
    </div>
  </div>

  <div class="sim-ctrl">
    <button class="btn btn-primary" id="phase-btn" onclick="nextPhase()">‚ñ∂ Start Cross-Pollination</button>
    <div class="spd">Speed:
      <button class="spd-btn on" onclick="setSpd(1,this)">1√ó</button>
      <button class="spd-btn" onclick="setSpd(2,this)">2√ó</button>
      <button class="spd-btn" onclick="setSpd(5,this)">5√ó</button>
    </div>
  </div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 3: REPORTS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-3">
  <div class="eyebrow">Intelligence Archive</div>
  <h1 class="h1">Cycle <em>Intelligence Reports</em></h1>
  <div class="rule"></div>
  <p class="sub" id="reports-sub">Reports are generated after each cycle and fed back into agent decision-making. Run cycles to populate this archive.</p>

  <div class="reports-layout">
    <div class="report-nav">
      <h5>Completed Cycles</h5>
      <div id="report-nav-list"><div class="rn-empty">No cycles complete yet.</div></div>
    </div>
    <div class="report-view" id="report-view-area">
      <div class="report-placeholder">
        <div class="rp-icon">üìä</div>
        <div class="rp-msg">Select a cycle report</div>
      </div>
    </div>
  </div>

  <div style="margin-top:1.5rem;display:flex;gap:.8rem;flex-wrap:wrap">
    <button class="btn btn-ghost" onclick="goTo(2)">‚Üê Back to Simulator</button>
    <button class="btn btn-ghost btn-sm" id="dl-all-btn" style="display:none" onclick="exportAllReports()">‚¨á Export All Reports</button>
  </div>
</div>

</main>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CONSTANTS & DATA
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let speed = 1;
let currentPhase = -1;
let currentCycle = 1;
let cycleReports = [];
let agentStates = [];
let activeDesigns = [];
let configuredAgents = [];
let currentAgentNum = 1;
const AGENT_EMOJIS = ['üéØ','üåô','‚ú®','üî©','üíõ','üåø'];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MODE & API KEY MANAGEMENT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let simMode = 'sim'; // 'sim' or 'live'
let apiKeys = { anthropic: '', higgsfield: '' };
let apiKeysCommitted = false; // true once user clicks Submit

// Genome snapshots per cycle for before‚Üíafter deltas
let genomeSnapshots = []; // array of arrays: genomeSnapshots[cycleIdx] = [{...agentGenome}]

function setMode(mode) {
  simMode = mode;
  document.getElementById('mode-sim').classList.toggle('active', mode==='sim');
  document.getElementById('mode-live').classList.toggle('active', mode==='live');
  document.getElementById('api-panel').classList.toggle('show', mode==='live');
  checkApiKeys();
}

function checkApiKeys() {
  const antVal = (document.getElementById('api-anthropic')?.value || '').trim();
  const hfVal = (document.getElementById('api-higgsfield')?.value || '').trim();
  const dot = document.getElementById('api-dot');
  const txt = document.getElementById('api-status-text');
  const startBtn = document.getElementById('home-start-btn');
  const submitBtn = document.getElementById('api-submit-btn');
  if (simMode === 'sim') {
    if (dot) dot.className = 'dot off';
    if (txt) txt.textContent = 'Simulation mode ‚Äî no API keys needed';
    if (startBtn) startBtn.disabled = false;
    if (submitBtn) submitBtn.disabled = true;
    return;
  }
  // Enable submit button when at least Claude key is provided
  const hasAnt = antVal.length > 0;
  const hasHf = hfVal.length > 0;
  if (submitBtn) submitBtn.disabled = !hasAnt;
  if (apiKeysCommitted) {
    if (dot) dot.className = 'dot ok';
    if (txt) txt.textContent = 'API keys committed ‚úì' + (apiKeys.higgsfield ? ' ‚Äî Claude + Higgsfield active' : ' ‚Äî Claude active (images: free tier)');
    if (startBtn) startBtn.disabled = false;
  } else if (hasAnt) {
    if (dot) dot.className = 'dot warn';
    if (txt) txt.textContent = 'Claude key entered' + (hasHf ? ' + Higgsfield key entered' : '') + ' ‚Äî press Submit to lock in';
    if (startBtn) startBtn.disabled = true;
  } else {
    if (dot) dot.className = 'dot warn';
    if (txt) txt.textContent = 'Enter at least your Anthropic (Claude) API key';
    if (startBtn) startBtn.disabled = true;
  }
}

function submitApiKeys() {
  const antVal = (document.getElementById('api-anthropic')?.value || '').trim();
  const hfVal = (document.getElementById('api-higgsfield')?.value || '').trim();
  if (!antVal) return;
  apiKeys.anthropic = antVal;
  apiKeys.higgsfield = hfVal;
  apiKeysCommitted = true;
  // Persist to localStorage so keys survive page reloads
  try {
    localStorage.setItem('jf_key_ant', antVal);
    if (hfVal) localStorage.setItem('jf_key_hf', hfVal);
  } catch(e) { /* storage unavailable */ }
  lockApiInputs();
}

function lockApiInputs() {
  const antInput = document.getElementById('api-anthropic');
  const hfInput = document.getElementById('api-higgsfield');
  if (antInput) { antInput.disabled = true; antInput.style.opacity = '.6'; }
  if (hfInput) { hfInput.disabled = true; hfInput.style.opacity = '.6'; }
  const submitBtn = document.getElementById('api-submit-btn');
  if (submitBtn) { submitBtn.textContent = 'Keys Committed ‚úì'; submitBtn.disabled = true; submitBtn.style.borderColor = 'var(--grn)'; submitBtn.style.color = 'var(--grn)'; }
  const clearBtn = document.getElementById('api-clear-btn');
  if (clearBtn) clearBtn.style.display = 'inline';
  checkApiKeys();
}

function clearSavedKeys() {
  try { localStorage.removeItem('jf_key_ant'); localStorage.removeItem('jf_key_hf'); } catch(e) {}
  apiKeys.anthropic = '';
  apiKeys.higgsfield = '';
  apiKeysCommitted = false;
  const antInput = document.getElementById('api-anthropic');
  const hfInput = document.getElementById('api-higgsfield');
  if (antInput) { antInput.value = ''; antInput.disabled = false; antInput.style.opacity = ''; }
  if (hfInput) { hfInput.value = ''; hfInput.disabled = false; hfInput.style.opacity = ''; }
  const submitBtn = document.getElementById('api-submit-btn');
  if (submitBtn) { submitBtn.textContent = 'Submit API Keys'; submitBtn.style.borderColor = ''; submitBtn.style.color = ''; }
  const clearBtn = document.getElementById('api-clear-btn');
  if (clearBtn) clearBtn.style.display = 'none';
  checkApiKeys();
}

// Restore saved API keys from localStorage on page load
function loadSavedKeys() {
  try {
    const savedAnt = localStorage.getItem('jf_key_ant') || '';
    const savedHf = localStorage.getItem('jf_key_hf') || '';
    if (!savedAnt) return;
    const antInput = document.getElementById('api-anthropic');
    const hfInput = document.getElementById('api-higgsfield');
    if (antInput) antInput.value = savedAnt;
    if (hfInput && savedHf) hfInput.value = savedHf;
    // Auto-switch to Live AI mode and commit
    setMode('live');
    apiKeys.anthropic = savedAnt;
    apiKeys.higgsfield = savedHf;
    apiKeysCommitted = true;
    lockApiInputs();
  } catch(e) { /* storage unavailable */ }
}
document.addEventListener('DOMContentLoaded', loadSavedKeys);

function startFromHome() {
  goTo(1);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   agentGenomeStr() ‚Äî Compile full agent DNA into prompt string
   Injects identity, style genome, material genome, risk genome,
   evolution history, and current beliefs into every LLM prompt.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function agentGenomeStr(agent) {
  const g = agent;
  const tags = (g.styleTags || []).join(', ') || 'none';
  const riskLabel = g.risk > 65 ? 'Explorer (High Novelty)' : g.risk < 35 ? 'Refiner (Exploit Lane)' : 'Balanced (Mutate)';
  const mktFocus = g.marketFocus || 'general';

  let genome = `AGENT IDENTITY:
  Name: ${g.name}
  Archetype: ${g.arch}
  Philosophy: "${g.philosophy}"
  Style Tags: [${tags}]
  Market Focus: ${mktFocus}

STYLE GENOME:
  Minimalism: ${g.minimalism ?? g.min ?? 50}/100
  Novelty Drive: ${g.novelty}/100
  Ornamentation: ${g.ornamentation ?? g.orn ?? 50}/100
  Market Fit Priority: ${g.marketFit}/100
  Symmetry Preference: ${g.symmetry ?? g.sym ?? 60}/100

MATERIAL GENOME:
  Platinum Bias: ${g.platBias}/100
  Colored Stone Use: ${g.coloredStone ?? g.col ?? 40}/100
  Diamond Preference: ${g.diamond ?? g.dia ?? 60}/100
  Mixed/Accent Metals: ${g.mixedMetal ?? g.mix ?? 30}/100

RISK GENOME:
  Exploration‚ÜîExploitation: ${g.risk}/100 (${riskLabel})
  Margin Sensitivity: ${g.marginSens ?? g.mrg ?? 65}/100
  Complexity Budget: ${g.complexBudget ?? g.cmp ?? 55}/100

CURRENT STATE:
  Credits: ${g.credits}
  Reputation: ${g.reputation}
  Status: ${g.status}`;

  // Append evolution history if available
  if (g.evolutionHistory && g.evolutionHistory.length > 0) {
    genome += `\n\nEVOLUTION HISTORY:`;
    g.evolutionHistory.forEach(evo => {
      genome += `\n  Cycle ${evo.cycle}: ${evo.summary}`;
      if (evo.genomeShifts) {
        Object.entries(evo.genomeShifts).forEach(([k, v]) => {
          if (v !== 0) genome += `\n    ${k}: ${v > 0 ? '+' : ''}${v}`;
        });
      }
    });
  }

  // Append conversation memory
  if (g.conversationMemory && g.conversationMemory.length > 0) {
    genome += `\n\nCONVERSATION MEMORY (prior cycles):`;
    g.conversationMemory.forEach(mem => {
      genome += `\n  [Cycle ${mem.cycle}] ${mem.partner}: "${mem.excerpt}"`;
    });
  }

  return genome;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   priorReportCtx() ‚Äî Compile all prior intelligence reports
   into context string for LLM prompts. Includes winners,
   trend data, forward intelligence, and agent performance.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function priorReportCtx(agentIdx) {
  if (cycleReports.length === 0) return 'No prior intelligence reports available. This is the first cycle ‚Äî begin cold.';

  let ctx = `INTELLIGENCE REPORT DATABASE (${cycleReports.length} cycle${cycleReports.length>1?'s':''} completed):\n`;

  cycleReports.forEach(r => {
    ctx += `\n‚ïê‚ïê‚ïê CYCLE ${r.cycle} REPORT ‚ïê‚ïê‚ïê\n`;
    ctx += `Winner: "${r.winner.name}" by ${r.winner.agentName} (${r.winner.credits.toLocaleString()}‚¨°, ${r.winnerShare}% vote share)\n`;
    ctx += `Total Credits Circulated: ${r.totalCredits.toLocaleString()}‚¨°\n`;
    ctx += `Avg Scores: Aesthetic ${r.avgAesthetic}/100, Novelty ${r.avgNovelty}/100, Profit ${r.avgProfit}/100\n`;
    ctx += `Top Vote Predictor: ${r.topCorr} (r=${r['corr'+r.topCorr.slice(0,3).replace(/^(.)/, m=>m.toUpperCase())]||'?'})\n`;
    ctx += `Gini Concentration: ${r.gini}\n`;
    ctx += `Novelty Premium: ${r.novSlope > 0 ? '+' : ''}${r.novSlope}‚¨° per novelty point above average\n`;

    ctx += `\nTrend Consensus:\n`;
    ctx += `  Emerging: ${(r.trendData?.emerging||[]).join(', ')}\n`;
    ctx += `  Declining: ${(r.trendData?.declining||[]).join(', ')}\n`;
    ctx += `  Saturation: ${r.trendData?.saturation||'‚Äî'}\n`;
    ctx += `  Treasury Signal: ${r.trendData?.treasury||'‚Äî'}\n`;
    ctx += `  Velocity: ${r.trendData?.velocityScore||'‚Äî'}/100\n`;

    ctx += `\nForward Intelligence:\n`;
    (r.trendData?.fi||[]).forEach(f => { ctx += `  ‚Ä¢ ${f}\n`; });

    // Agent-specific performance
    const myPerf = (r.agentPerf||[]).find(a => a.id === agentIdx);
    if (myPerf) {
      ctx += `\nYOUR PERFORMANCE (Cycle ${r.cycle}):\n`;
      ctx += `  Design: "${myPerf.designName}" ¬∑ Strategy: ${myPerf.strategy} ¬∑ Rank: #${myPerf.rank}\n`;
      ctx += `  Earned: ${myPerf.earned.toLocaleString()}‚¨° ¬∑ Spent: ${myPerf.spent.toLocaleString()}‚¨° ¬∑ ROI: ${myPerf.roi}√ó\n`;
      ctx += `  Reputation: ${myPerf.reputation} (${myPerf.repDelta >= 0 ? '+' : ''}${myPerf.repDelta})\n`;
    }

    ctx += `\nAll Designs (ranked):\n`;
    [...r.designs].sort((a,b)=>a.rank-b.rank).forEach(d => {
      ctx += `  #${d.rank} "${d.name}" by ${d.agentName} ‚Äî ${d.strategy.toUpperCase()} ‚Äî ${d.cat} ‚Äî ${d.credits.toLocaleString()}‚¨° ‚Äî AES:${d.aesthetic} NOV:${d.novelty} PRO:${d.profit}\n`;
    });

    ctx += `\nStrategy Performance: ${Object.entries(r.stratPerf||{}).map(([k,v])=>`${k.toUpperCase()}: ${v.avgCreds.toLocaleString()}‚¨° avg (${v.count} designs)`).join(' | ')}\n`;
  });

  // Multi-cycle trend analysis
  if (cycleReports.length >= 2) {
    ctx += `\n‚ïê‚ïê‚ïê MULTI-CYCLE TREND ANALYSIS ‚ïê‚ïê‚ïê\n`;
    const winners = cycleReports.map(r => `C${r.cycle}: "${r.winner.name}" (${(r.trendData?.emerging||[])[0]||'‚Äî'})`);
    ctx += `Winners: ${winners.join(' ‚Üí ')}\n`;
    const novTrend = cycleReports.map(r => `C${r.cycle}: ${r.novSlope > 0 ? '+' : ''}${r.novSlope}‚¨°/pt`);
    ctx += `Novelty Premium Trend: ${novTrend.join(' ‚Üí ')}\n`;
    const satTrend = cycleReports.map(r => `C${r.cycle}: ${r.trendData?.saturation||'‚Äî'}`);
    ctx += `Saturation Trend: ${satTrend.join(' ‚Üí ')}\n`;
  }

  return ctx;
}

// 3 cycles of pre-defined designs with narrative coherence:
// C1 winner: Agent 1 "Floating Geometric Circle Drop" ‚Äî minimal wins
// C2 winner: Agent 0 "Marquise Cathedral Arch" ‚Äî exploits C1 trend
// C3 winner: Agent 5 "Root & Branch Gold Sculpture" ‚Äî organic emerges as minimal saturates
const CYCLE_DESIGNS = [
  [ // CYCLE 1
    { name:'Platinum Oval Bezel Negative-Space',  cat:'Ring',     emoji:'‚¨°', agentIdx:0, strategy:'explore', aesthetic:71, novelty:78, profit:68,
      prompt:'Platinum solitaire ring, 2.0ct oval diamond bezel-set, open negative-space band, architectural silhouette, studio photography, neutral gray background, soft diffuse lighting, 4K render' },
    { name:'Floating Geometric Circle Drop',      cat:'Earrings', emoji:'üåë', agentIdx:1, strategy:'explore', aesthetic:85, novelty:82, profit:74,
      prompt:'Platinum drop earrings, floating geometric circles, minimal negative-space composition, rose-cut diamond accents, contemporary jewelry photography, gray gradient background, precise studio lighting, photorealistic' },
    { name:'Rose Gold Sapphire Cascade',    cat:'Pendant',  emoji:'‚ú®', agentIdx:2, strategy:'exploit', aesthetic:79, novelty:52, profit:72,
      prompt:'18k rose gold pendant, sapphire and diamond cascade, micro-pav√© halo surround, floral motif, high jewelry editorial, dark velvet background, dramatic highlight lighting, photorealistic render' },
    { name:'Titanium Hex-Link Industrial',       cat:'Bracelet', emoji:'üî∑', agentIdx:3, strategy:'explore', aesthetic:67, novelty:90, profit:50,
      prompt:'Titanium and 18k yellow gold bracelet, hexagonal geometric links, industrial mixed-metal design, asymmetric barrel clasp, technical product photography, white background, sharp precision lighting' },
    { name:'Classic Pav√© Halo Cathedral',       cat:'Ring',     emoji:'üíç', agentIdx:4, strategy:'exploit', aesthetic:77, novelty:40, profit:88,
      prompt:'14k white gold engagement ring, 1.8ct round brilliant center stone, classic micro-pav√© halo, cathedral shank, bridal photography, pure white seamless background, soft glamour lighting, commercial grade' },
    { name:'Blackened Gold Thorn Sculpt',      cat:'Ring',     emoji:'üåπ', agentIdx:5, strategy:'explore', aesthetic:73, novelty:80, profit:46,
      prompt:'18k blackened gold ring, sculptural thorn motif band, avant-garde wearable art, matte finish with high-polish accent edges, editorial photography, deep charcoal background, single dramatic light source' },
  ],
  [ // CYCLE 2 ‚Äî agents reference C1 report, minimal trend exploited
    { name:'Marquise Cathedral Arch',  cat:'Ring',     emoji:'‚¨°', agentIdx:0, strategy:'exploit', aesthetic:88, novelty:79, profit:74,
      prompt:'Platinum ring, 2.2ct marquise diamond, architectural cathedral negative-space arch setting, open structural band, blueprint-aesthetic engineering, neutral gray background, technical precision lighting, 4K product photography' },
    { name:'Bezel Groove Negative-Space',      cat:'Ring',     emoji:'üåë', agentIdx:1, strategy:'exploit', aesthetic:82, novelty:68, profit:77,
      prompt:'Platinum minimal ring, bezel-set 1.4ct round brilliant, flush band with precise groove detail, intentional negative-space composition, minimalist product photography, pure gray background, diffuse even lighting' },
    { name:'Yellow Gold Sapphire Canopy', cat:'Pendant',  emoji:'üíô', agentIdx:2, strategy:'exploit', aesthetic:81, novelty:54, profit:76,
      prompt:'18k yellow gold pendant, cushion-cut blue sapphire canopy setting, pav√© diamond surround, organic draping form, luxury jewelry campaign, black velvet background, dramatic highlight rim lighting' },
    { name:'Platinum-Titanium Arc Hybrid',       cat:'Ring',     emoji:'‚ö°', agentIdx:3, strategy:'mutate',  aesthetic:74, novelty:88, profit:55,
      prompt:'Platinum and titanium ring, circular bezel diamond, industrial-minimal hybrid design, integrated negative-space arc, structural asymmetry, contemporary jewelry photography, steel-gray gradient background' },
    { name:'Oval Open-Shank Channel',     cat:'Ring',     emoji:'üíé', agentIdx:4, strategy:'exploit', aesthetic:80, novelty:52, profit:91,
      prompt:'14k white gold ring, 1.5ct oval diamond, architectural open-shank channel setting, market-optimized proportions, bridal editorial photography, white seamless background, soft box lighting, commercial clarity' },
    { name:'Silver Bone-Form Sculptural',  cat:'Bracelet', emoji:'ü¶¥', agentIdx:5, strategy:'mutate',  aesthetic:76, novelty:85, profit:52,
      prompt:'Sterling silver sculptural bracelet, bone-form organic link structure, oxidized blackened detail in recesses, avant-garde wearable sculpture, editorial fashion photography, high-contrast dark background, fashion lighting' },
  ],
  [ // CYCLE 3 ‚Äî minimal saturation detected, organic breakout emerges
    { name:'Emerald-Cut Double Cathedral', cat:'Ring',     emoji:'‚¨°', agentIdx:0, strategy:'exploit', aesthetic:84, novelty:72, profit:71,
      prompt:'Platinum ring, 2.4ct emerald-cut diamond, extreme negative-space double-cathedral arch, structural statement piece, luxury editorial photography, dark studio background, dramatic single-point lighting, fine jewelry' },
    { name:'Floating Diamond Arc',     cat:'Pendant',  emoji:'üåë', agentIdx:1, strategy:'mutate',  aesthetic:80, novelty:74, profit:72,
      prompt:'Platinum arc pendant, single floating 0.8ct diamond point, dramatic negative-space composition, architectural jewelry design, precise product photography, soft gray gradient background, technical rim lighting' },
    { name:'Champagne Pearl Organic Cluster',  cat:'Pendant',  emoji:'üå∏', agentIdx:2, strategy:'explore', aesthetic:83, novelty:76, profit:73,
      prompt:'18k yellow gold organic pendant, irregular champagne pearl and diamond cluster, sculptural flowing natural form, wearable art, high jewelry campaign, dark forest-green velvet background, natural diffuse lighting' },
    { name:'Gold Shard in Platinum Band',     cat:'Ring',     emoji:'üî•', agentIdx:3, strategy:'mutate',  aesthetic:79, novelty:91, profit:56,
      prompt:'Mixed metal ring, 18k yellow gold organic shard set into platinum band, irregular natural geometry, textured hammer surfaces, art jewelry photography, raw concrete background, natural side lighting' },
    { name:'Root & Branch Gold Sculpture',       cat:'Bracelet', emoji:'üåø', agentIdx:5, strategy:'explore', aesthetic:91, novelty:89, profit:67,
      prompt:'18k yellow gold sculptural bracelet, root and branch organic form, champagne diamond accents at nodes, wearable sculpture, luxury editorial photography, warm earth-tone linen background, natural window light, fine jewelry' },
    { name:'Cushion Diamond Minimalist Shank',   cat:'Ring',     emoji:'üíõ', agentIdx:4, strategy:'exploit', aesthetic:78, novelty:45, profit:92,
      prompt:'14k white gold ring, perfectly proportioned 1.8ct cushion diamond, clean minimalist shank, commercial jewelry photography, white background, ring perfectly in focus, soft box lighting, market-optimized render' },
  ],
];

// Voting data: who gets how many credits from whom per cycle
// [voter_agentIdx][design_idx] = credits
const VOTE_MATRICES = [
  // C1: Floating Geometric Circle Drop (idx 1) wins ‚Äî each row sums to 10000
  [[0,4200,2100,800,1200,1700],[4800,0,2000,600,1400,1200],[3200,3800,0,500,2100,400],[3100,3600,2200,0,800,300],[2800,3100,2800,300,0,1000],[3000,3800,1900,400,900,0]],
  // C2: Marquise Cathedral Arch (idx 0) wins ‚Äî each row sums to 10000
  [[0,3600,2800,1100,2500,0],[5100,0,1900,700,2300,0],[4200,1800,0,900,3100,0],[3800,2400,1600,0,2200,0],[5100,2100,2300,500,0,0],[2500,2900,2100,600,1900,0]],
  // C3: Root & Branch Gold Sculpture (idx 4) wins ‚Äî each row sums to 10000
  [[1700,1500,2000,1000,3200,600],[1600,1400,2000,800,3700,500],[1400,1700,1300,700,4300,600],[2200,1400,1800,1000,3200,400],[2400,2000,3200,800,0,1600],[1400,1200,1500,700,5200,0]],
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   BUILDER UI
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function sv(el, id){ document.getElementById(id).textContent = el.value; }

function toggleChip(el, group) {
  if(group==='sc') {
    const sel = document.querySelectorAll('#style-chips .chip.on');
    if(!el.classList.contains('on') && sel.length >= 5) return;
  } else {
    document.querySelectorAll('#mkt-chips .chip').forEach(c=>c.classList.remove('on'));
  }
  el.classList.toggle('on');
  updatePreview();
}

function updatePreview() {
  const name = document.getElementById('b-name').value||'‚Äî';
  const arch = document.getElementById('b-arch').value||'‚Äî';
  document.getElementById('pv-id').textContent = name + (arch!=='‚Äî'?' ¬∑ '+arch:'');
  const tags = [...document.querySelectorAll('#style-chips .chip.on')].map(c=>c.textContent).join(', ')||'‚Äî';
  document.getElementById('pv-tags').textContent = tags;
  const rsk = parseInt(document.getElementById('s-rsk').value);
  document.getElementById('pv-strat').textContent = rsk>65?'Explorer (High Novelty)':rsk<35?'Refiner (Exploit Lane)':'Balanced (Mutate)';
  const mkt = document.querySelector('#mkt-chips .chip.on');
  document.getElementById('pv-mkt').textContent = mkt?mkt.textContent:'‚Äî';
  renderDNA();
}

function renderDNA() {
  const ids = ['s-min','s-nov','s-orn','s-mkt','s-plt','s-col','s-dia','s-rsk','s-mrg'];
  const cols = ['#c9a84c','#8a6e30','#e8c97a','#c9a84c','#8a6e30','#b5332a','#c9a84c','#4caf7d','#7b6fa8'];
  document.getElementById('pv-dna').innerHTML = ids.map((id,i)=>{
    const v=parseInt(document.getElementById(id).value);
    return `<div class="dna-b" style="background:${cols[i]};opacity:${.1+(v/100)*.85}"></div>`;
  }).join('');
}

// Fallback pools used only in Sim mode
const FALLBACK_NAMES = ['Maren Vex','Zara Mbeki','Dmitri Volkov','Hana Mori','S√∏ren Bach','Inez Varela','Kai Soto','Lena Roth','Yuki Endo','Rami Naji','Priya Das','Olga Falk'];
const FALLBACK_ARCHS = ['Avant-Garde Purist','Industrial Innovator','Heritage Revivalist','Nature Mystic','Market Strategist','Street Luxury Provocateur','Neo-Classical Engineer','Material Alchemist','Biomorphic Sculptor','Pattern Theorist','Wearable Art Radical','Precision Minimalist'];
const FALLBACK_PHILS = [
  'Form is the message. Structure before ornament.',
  'Push the material until it argues back.',
  'The old masters had it right. I refine, not reinvent.',
  'Nature\'s geometry is more perfect than any CAD model.',
  'Beauty without demand is just decoration.',
  'Jewelry should feel dangerous to wear.',
  'Every millimeter earns its place or gets cut.',
  'Mix what shouldn\'t mix. That\'s where magic lives.',
  'Growth patterns hold the blueprint for perfect jewelry.',
  'The math underneath beauty is what I design.',
  'If it\'s comfortable, it\'s not pushing hard enough.',
  'One line, one stone, one perfect gesture.',
];

async function autoGen() {
  // First, randomize the genome sliders
  ['s-min','s-nov','s-orn','s-mkt','s-sym','s-plt','s-col','s-dia','s-mix','s-rsk','s-mrg','s-cmp'].forEach(id=>{
    const el=document.getElementById(id); const v=Math.floor(Math.random()*70)+15; el.value=v;
    const sid='sv-'+id.replace('s-',''); const se=document.getElementById(sid); if(se) se.textContent=v;
  });

  // Pick random style tags and market focus
  const allChips = [...document.querySelectorAll('#style-chips .chip')];
  allChips.forEach(c=>c.classList.remove('on'));
  const shuffled = allChips.sort(()=>Math.random()-0.5).slice(0, Math.floor(Math.random()*3)+2);
  shuffled.forEach(c=>c.classList.add('on'));
  const mChips = [...document.querySelectorAll('#mkt-chips .chip')];
  mChips.forEach(c=>c.classList.remove('on'));
  mChips[Math.floor(Math.random()*mChips.length)].classList.add('on');

  // Read current slider values for the prompt
  const sliders = {
    minimalism: document.getElementById('s-min').value,
    novelty: document.getElementById('s-nov').value,
    ornamentation: document.getElementById('s-orn').value,
    marketFit: document.getElementById('s-mkt').value,
    symmetry: document.getElementById('s-sym').value,
    platBias: document.getElementById('s-plt').value,
    coloredStone: document.getElementById('s-col').value,
    diamond: document.getElementById('s-dia').value,
    mixedMetal: document.getElementById('s-mix').value,
    risk: document.getElementById('s-rsk').value,
    marginSens: document.getElementById('s-mrg').value,
    complexBudget: document.getElementById('s-cmp').value,
  };
  const tags = [...document.querySelectorAll('#style-chips .chip.on')].map(c=>c.textContent).join(', ');
  const market = document.querySelector('#mkt-chips .chip.on')?.textContent || 'general';

  // Try Claude-generated identity if API available
  if (apiKeysCommitted && apiKeys.anthropic) {
    const btn = document.querySelector('.auto-link');
    if (btn) btn.textContent = '‚è≥ Generating‚Ä¶';
    try {
      const genome = `Minimalism:${sliders.minimalism} Novelty:${sliders.novelty} Ornamentation:${sliders.ornamentation} MarketFit:${sliders.marketFit} Symmetry:${sliders.symmetry} PlatinumBias:${sliders.platBias} ColoredStone:${sliders.coloredStone} Diamond:${sliders.diamond} MixedMetal:${sliders.mixedMetal} Risk:${sliders.risk} MarginSensitivity:${sliders.marginSens} ComplexityBudget:${sliders.complexBudget} StyleTags:[${tags}] Market:${market}`;

      const resp = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-api-key': apiKeys.anthropic,
          'anthropic-version': '2023-06-01',
          'anthropic-dangerous-direct-browser-access': 'true'
        },
        body: JSON.stringify({
          model: 'claude-haiku-4-5-20251001',
          max_tokens: 150,
          system: 'You generate unique jewelry designer identities for an AI simulation. Output EXACTLY 3 lines, nothing else:\nLine 1: A unique designer name (first + last, any ethnicity)\nLine 2: A 2-3 word archetype title\nLine 3: A design philosophy quote (one sentence, under 12 words)',
          messages: [{ role: 'user', content: `Generate a designer identity that matches this genome:\n${genome}\n\nThe personality should clearly reflect these specific slider values. High minimalism = clean/structural. High ornamentation = ornate/detailed. High risk = experimental. Low risk = conservative. High platinum bias = cold metals. High colored stone = colorful. Etc.\n\nOutput 3 lines: Name, Archetype, Philosophy.` }]
        })
      });
      const data = await resp.json();
      const text = data.content?.[0]?.text?.trim();
      if (text) {
        const lines = text.split('\n').map(l=>l.trim()).filter(l=>l);
        if (lines.length >= 3) {
          document.getElementById('b-name').value = lines[0].replace(/^(Name:\s*|1[\.\)]\s*)/i,'');
          document.getElementById('b-arch').value = lines[1].replace(/^(Archetype:\s*|2[\.\)]\s*)/i,'');
          document.getElementById('b-phil').value = lines[2].replace(/^(Philosophy:\s*|Quote:\s*|3[\.\)]\s*|"|')/i,'').replace(/["']$/,'');
          if (btn) btn.textContent = '‚ú¶ Auto-Generate';
          updatePreview();
          return;
        }
      }
    } catch(e) { console.warn('Claude auto-gen failed:', e); }
    if (btn) btn.textContent = '‚ú¶ Auto-Generate';
  }

  // Sim mode fallback ‚Äî pick from pool
  const i = Math.floor(Math.random()*FALLBACK_NAMES.length);
  document.getElementById('b-name').value = FALLBACK_NAMES[i];
  document.getElementById('b-arch').value = FALLBACK_ARCHS[i]||'';
  document.getElementById('b-phil').value = FALLBACK_PHILS[i];
  updatePreview();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SIM INITIALIZATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function deployCurrentAgent() {
  if(!document.getElementById('b-name').value) await autoGen();
  const idx = currentAgentNum - 1;
  const agent = {
    id: idx,
    name: document.getElementById('b-name').value || 'Agent ' + currentAgentNum,
    emoji: AGENT_EMOJIS[idx],
    arch: document.getElementById('b-arch').value || 'Designer',
    risk: parseInt(document.getElementById('s-rsk').value),
    novelty: parseInt(document.getElementById('s-nov').value),
    minimalism: parseInt(document.getElementById('s-min').value),
    ornamentation: parseInt(document.getElementById('s-orn').value),
    marketFit: parseInt(document.getElementById('s-mkt').value),
    symmetry: parseInt(document.getElementById('s-sym').value),
    platBias: parseInt(document.getElementById('s-plt').value),
    coloredStone: parseInt(document.getElementById('s-col').value),
    diamond: parseInt(document.getElementById('s-dia').value),
    mixedMetal: parseInt(document.getElementById('s-mix').value),
    marginSens: parseInt(document.getElementById('s-mrg').value),
    complexBudget: parseInt(document.getElementById('s-cmp').value),
    styleTags: [...document.querySelectorAll('#style-chips .chip.on')].map(c=>c.textContent),
    marketFocus: document.querySelector('#mkt-chips .chip.on')?.textContent || 'general',
    philosophy: document.getElementById('b-phil').value || '',
    isUser: currentAgentNum === 1,
    credits: 10000,
    reputation: currentAgentNum === 1 ? 50 : Math.floor(Math.random()*30)+45,
    status: 'Idle',
    bio: '',
    evolutionHistory: [],
    conversationMemory: [],
    dominantBelief: '',
    trustBuilt: 0,
  };

  // Generate bio from genome via Claude (or fallback)
  const btn = document.getElementById('deploy-btn');
  if (simMode === 'live' && apiKeys.anthropic) {
    btn.disabled = true;
    btn.textContent = `‚è≥ Analyzing ${agent.name}'s DNA‚Ä¶`;
  }
  await generateAgentBio(agent);
  if (btn) btn.disabled = false;

  configuredAgents.push(agent);
  renderRoster();

  if(currentAgentNum >= 6) {
    startSimulation();
  } else {
    currentAgentNum++;
    resetBuilderForNext();
  }
}

function resetBuilderForNext() {
  // Update counter
  document.getElementById('agent-counter').innerHTML = 'Agent ' + currentAgentNum + ' of 6 &nbsp;<span id="agent-emoji">' + AGENT_EMOJIS[currentAgentNum-1] + '</span>';
  document.getElementById('builder-title').innerHTML = currentAgentNum === 1
    ? 'Design your <em>autonomous agent.</em>'
    : 'Configure <em>competitor #' + (currentAgentNum-1) + '</em>';
  document.getElementById('builder-sub').textContent = currentAgentNum === 1
    ? 'Configure identity, aesthetic biases, and risk genome. These traits shape every decision your agent makes across all 3 cycles ‚Äî and evolve based on what it learns.'
    : 'This agent will compete in the arena against your deployed agents. Customize or auto-generate.';

  // Clear and auto-generate for speed
  document.getElementById('b-name').value = '';
  document.getElementById('b-arch').value = '';
  document.getElementById('b-phil').value = '';
  document.querySelectorAll('#style-chips .chip').forEach(c=>c.classList.remove('on'));
  document.querySelectorAll('#mkt-chips .chip').forEach(c=>c.classList.remove('on'));
  autoGen();

  // Update button
  const btn = document.getElementById('deploy-btn');
  if(currentAgentNum < 6) {
    btn.textContent = 'Deploy Agent ' + currentAgentNum + ' \u2192 Configure Next';
  } else {
    btn.textContent = 'Deploy Agent 6 \u2192 Begin Epoch';
  }
}

function renderRoster() {
  const wrap = document.getElementById('roster-wrap');
  const el = document.getElementById('agent-roster');
  if(!el) return;
  wrap.style.display = 'block';
  el.innerHTML = configuredAgents.map(a => `
    <div class="roster-card">
      <div class="rc-emoji">${a.emoji}</div>
      <div class="rc-info">
        <div class="rc-name">${a.name}${a.isUser?' (YOU)':''}</div>
        <div class="rc-arch">${a.arch}</div>
      </div>
    </div>
  `).join('');
}

function startSimulation() {
  agentStates = configuredAgents.map(a => ({...a, evolutionHistory: [], conversationMemory: [], dominantBelief: '', trustBuilt: 0}));
  CYCLE_DESIGNS.forEach(cycle => cycle.forEach(d => { if(d.agentIdx===0) d._agentName = agentStates[0].name; }));
  currentCycle = 1;
  cycleReports = [];
  activeDesigns = [];
  genomeSnapshots = [];
  // Snapshot initial genome state
  genomeSnapshots.push(agentStates.map(a => snapshotGenome(a)));
  document.getElementById('deploy-panel').style.display = 'none';
  document.getElementById('sim-main').style.display = 'block';
  // Update mode badge
  const badge = document.getElementById('mode-badge');
  if (badge) {
    badge.textContent = simMode === 'live' ? 'LIVE AI' : 'SIM';
    badge.className = simMode === 'live' ? 'sim-mode-badge live' : 'sim-mode-badge sim';
  }
  resetSim();
  goTo(2);
}

function snapshotGenome(agent) {
  return {
    id: agent.id, name: agent.name, emoji: agent.emoji,
    minimalism: agent.minimalism ?? 50,
    novelty: agent.novelty ?? 50,
    ornamentation: agent.ornamentation ?? 50,
    marketFit: agent.marketFit ?? 50,
    symmetry: agent.symmetry ?? 60,
    platBias: agent.platBias ?? 50,
    coloredStone: agent.coloredStone ?? 40,
    diamond: agent.diamond ?? 60,
    mixedMetal: agent.mixedMetal ?? 30,
    risk: agent.risk ?? 50,
    marginSens: agent.marginSens ?? 65,
    complexBudget: agent.complexBudget ?? 55,
    styleTags: [...(agent.styleTags || [])],
    reputation: agent.reputation,
    credits: agent.credits,
  };
}

function resetSim() {
  currentPhase = -1;  // CRITICAL: reset phase counter for new cycle
  document.getElementById('act-log').innerHTML = '';
  document.getElementById('designs-wrap').style.display = 'none';
  document.getElementById('dgrid').innerHTML = '';
  document.getElementById('cc-panel').className = 'cycle-complete';
  resetPhaseRail();
  setProgress(0);
  document.getElementById('sim-cycle-num').textContent = String(currentCycle).padStart(2,'0');
  document.getElementById('dw-cycle').textContent = String(currentCycle).padStart(2,'0');
  updateCycleIndicator();
  renderAgentsList();
  const btn = document.getElementById('phase-btn');
  btn.style.display = '';
  btn.style.removeProperty('display');
  btn.textContent = '‚ñ∂ Start Cross-Pollination';
  btn.disabled = false;
  btn.onclick = nextPhase;
}

function resetPhaseRail() {
  for(let i=0;i<5;i++){
    const n=document.getElementById('ph'+i);
    n.className='pnode'+(i===0?' active':'');
  }
}

function setPhaseActive(p) {
  for(let i=0;i<5;i++){
    const n=document.getElementById('ph'+i);
    if(i<p) n.className='pnode done';
    else if(i===p) n.className='pnode active';
    else n.className='pnode';
  }
}

function setProgress(pct){ document.getElementById('prog').style.width=pct+'%'; }

function updateCycleIndicator() {
  for(let i=1;i<=3;i++){
    const el=document.getElementById('cid-'+i);
    if(i<currentCycle) el.className='ci-dot done';
    else if(i===currentCycle) el.className='ci-dot active';
    else el.className='ci-dot';
  }
  document.getElementById('nav-epoch-txt').textContent = (currentCycle-1)+' / 3';
}

function renderAgentsList() {
  document.getElementById('agents-col-body').innerHTML = agentStates.map(a=>`
    <div class="arow ${a.isUser?'highlight':''}" id="ar-${a.id}">
      <div class="av">${a.emoji}</div>
      <div class="ai">
        <div class="an">${a.name}${a.isUser?' <span style="font-size:.55rem;color:var(--gold-d);border:1px solid var(--gold-d);padding:.05rem .3rem">YOU</span>':''}</div>
        <div class="as" id="as-${a.id}">${a.status}</div>
      </div>
      <div class="acr" id="ac-${a.id}">${a.credits.toLocaleString()}‚¨°</div>
    </div>
  `).join('');
}

function setAgentStatus(id, s){ const e=document.getElementById('as-'+id); if(e) e.textContent=s; }
function setAgentCreds(id, v){ const e=document.getElementById('ac-'+id); if(e) e.textContent=v.toLocaleString()+'‚¨°'; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PHASE ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function addLog(text, type='', delay=0) {
  setTimeout(()=>{
    const log = document.getElementById('act-log');
    const d = document.createElement('div');
    const now = new Date();
    const t = now.toTimeString().slice(0,8);
    d.className = `le ${type}`;
    d.innerHTML = `<span class="lt">${t} ¬∑ Cycle ${currentCycle}</span>${text}`;
    log.appendChild(d);
    log.scrollTop = log.scrollHeight;
  }, delay/speed);
}

let phaseDelay = 0;
function D(ms){ return ms; }

async function nextPhase() {
  currentPhase++;
  if(currentPhase >= 5) return;
  setPhaseActive(currentPhase);
  document.getElementById('phase-btn').disabled = true;
  document.getElementById('phase-btn').textContent = '‚è≥ Running phase‚Ä¶';

  const scripts = PHASE_SCRIPTS[currentCycle-1] || PHASE_SCRIPTS[0];
  const script = scripts[currentPhase];
  const finishDelay = await script(); // support async phase scripts

  setTimeout(()=>{
    document.getElementById('phase-btn').disabled = false;
    if(currentPhase === 4) {
      document.getElementById('phase-btn').style.display='none';
      showCycleComplete();
    } else {
      const labels = ['‚ñ∂ Proceed to Synthesis','‚ñ∂ Generate Designs','‚ñ∂ Begin Agent Voting','‚ñ∂ Apply Evolution'];
      document.getElementById('phase-btn').textContent = labels[currentPhase]||'‚ñ∂ Next Phase';
    }
  }, finishDelay/speed);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   GENOME EVOLUTION ENGINE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function evolveAgentGenomes(cycleNum, sortedDesigns) {
  const winner = sortedDesigns[0];
  const loser = sortedDesigns[sortedDesigns.length - 1];

  // Deterministic genome shifts based on cycle outcome
  const EVOLUTION_RULES = {
    1: {  // C1: minimal wins ‚Äî shift toward minimal
      winner: { minimalism: +8, novelty: +5, risk: -5 },
      loser:  { novelty: +10, risk: +8, marginSens: +6 },
      others: { minimalism: +4, ornamentation: -3, novelty: +2 },
      beliefs: {
        0: 'Negative-space architecture is the market signal',
        1: 'Floating geometry captures attention ‚Äî I proved it',
        2: 'Ornate still has a place, but I need to read the room',
        3: 'Industrial alone doesn\'t win ‚Äî need to hybridize',
        4: 'Bridal margin is safe, but minimal won on aesthetics',
        5: 'My sculptural approach needs better margin math',
      }
    },
    2: {  // C2: architectural minimal peaks ‚Äî exploitation
      winner: { minimalism: +6, symmetry: -4, risk: -8 },
      loser:  { novelty: +12, marginSens: +8, ornamentation: +5 },
      others: { risk: +5, novelty: +4, minimalism: -3 },
      beliefs: {
        0: 'Cathedral architecture is peak ‚Äî push it one more cycle',
        1: 'Second place on refinement ‚Äî I need a bolder pivot',
        2: 'Yellow gold shift paid off. Organic is the untapped gap',
        3: 'Industrial-minimal hybrid scored better ‚Äî keep mutating',
        4: 'Market arch almost won ‚Äî margins rule long-term',
        5: 'Two cycles of minimal domination ‚Äî the contrarian play is organic',
      }
    },
    3: {  // C3: organic breakout ‚Äî minimal saturates
      winner: { novelty: +10, ornamentation: +6, risk: +5, minimalism: -8 },
      loser:  { minimalism: -5, novelty: +8, marketFit: +5 },
      others: { novelty: +5, ornamentation: +3, minimalism: -4 },
      beliefs: {
        0: 'I over-exploited minimal. The trend exhausted under my feet',
        1: 'Pivot to pendant saved me from minimal saturation',
        2: 'Champagne Pearl Organic Cluster found the romantic-organic sweet spot',
        3: 'Organic shard was the right direction ‚Äî mixed metal is the future',
        4: 'Margin stability works long-term but never wins the epoch',
        5: 'Root & Branch proved that nature\'s geometry beats digital precision',
      }
    }
  };

  const rules = EVOLUTION_RULES[cycleNum];
  if (!rules) return;

  agentStates.forEach((agent, idx) => {
    const isWinner = idx === winner.agentIdx;
    const isLoser = idx === loser.agentIdx;
    const shifts = isWinner ? rules.winner : isLoser ? rules.loser : rules.others;
    const genomeShifts = {};

    Object.entries(shifts).forEach(([key, delta]) => {
      if (agent[key] !== undefined) {
        const oldVal = agent[key];
        agent[key] = Math.max(0, Math.min(100, agent[key] + delta));
        genomeShifts[key] = agent[key] - oldVal;
      }
    });

    // Update beliefs and trust
    agent.dominantBelief = rules.beliefs[idx] || 'Adapting to market signals';
    agent.trustBuilt = Math.min(100, (agent.trustBuilt || 0) + (isWinner ? 15 : isLoser ? -5 : 5));

    // Store evolution history
    const myDesign = sortedDesigns.find(d => d.agentIdx === idx);
    agent.evolutionHistory.push({
      cycle: cycleNum,
      summary: isWinner
        ? `Won with "${myDesign?.name||'‚Äî'}" (${myDesign?.credits?.toLocaleString()||0}‚¨°). Genome reinforced.`
        : isLoser
        ? `Last place with "${myDesign?.name||'‚Äî'}". Mutation pressure applied.`
        : `Ranked #${myDesign?.rank||'?'} with "${myDesign?.name||'‚Äî'}". Adaptive shifts applied.`,
      genomeShifts,
      rank: myDesign?.rank || 0,
      designName: myDesign?.name || '‚Äî',
    });

    // Store conversation memory from this cycle's cross-pollination
    if (cycleNum === 1) {
      agent.conversationMemory.push(
        { cycle: 1, partner: agentStates[(idx + 1) % 6].name, excerpt: 'First cycle cold start ‚Äî exploring identity' }
      );
    } else {
      const partnerIdx = (idx + 1) % 6;
      agent.conversationMemory.push(
        { cycle: cycleNum, partner: agentStates[partnerIdx].name, excerpt: `Referenced C${cycleNum-1} winner and trend data in design dialogue` }
      );
    }
  });

  // Take post-evolution snapshot
  genomeSnapshots.push(agentStates.map(a => snapshotGenome(a)));
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE AI MODE ‚Äî LLM CALLS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function llmCall(systemPrompt, userPrompt, agent) {
  if (simMode !== 'live' || !apiKeys.anthropic) return null;

  const ag = agent || agentStates[0];
  const genomeCtx = agentGenomeStr(ag);
  const reportCtx = priorReportCtx(ag.id || 0);
  const bioCtx = ag.bio ? `\nPERSONALITY BIO:\n${ag.bio}\n` : '';
  const fullSystem = `You are ${ag.name || 'an AI agent'}, a jewelry design AI in the JewelForge simulation.\n\n${bioCtx}\n${genomeCtx}\n\n${reportCtx}\n\n${systemPrompt}`;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKeys.anthropic,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 300,
        system: fullSystem,
        messages: [{ role: 'user', content: userPrompt }]
      })
    });
    const data = await resp.json();
    return data.content?.[0]?.text || null;
  } catch(e) { console.warn('Claude call failed:', e); }

  return null;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   AGENT BIO GENERATION (Claude)
   Called at deploy time ‚Äî converts raw genome DNA
   into a short natural-language personality profile.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function generateAgentBio(agent) {
  // Always produce a sim-mode fallback bio from the genome
  const fallback = buildFallbackBio(agent);
  if (simMode !== 'live' || !apiKeys.anthropic) { agent.bio = fallback; return; }

  const genome = agentGenomeStr(agent);
  const prompt = `Below is the raw DNA genome of a jewelry design AI agent. Write a short personality bio (2-3 sentences, ~40 words) in third person that captures who this agent IS ‚Äî their design instincts, aesthetic identity, risk posture, and market philosophy. Make it vivid and specific. Do NOT list numbers or repeat the genome format. Just the bio paragraph, nothing else.

${genome}`;

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKeys.anthropic,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 120,
        system: 'You are a concise creative writer for a luxury jewelry AI simulation. Output ONLY the bio paragraph ‚Äî no labels, no quotes, no preamble.',
        messages: [{ role: 'user', content: prompt }]
      })
    });
    const data = await resp.json();
    const bio = data.content?.[0]?.text?.trim();
    agent.bio = bio || fallback;
  } catch(e) {
    console.warn('Bio generation failed for', agent.name, e);
    agent.bio = fallback;
  }
}

function buildFallbackBio(agent) {
  const style = agent.minimalism > 60 ? 'minimalist' : agent.ornamentation > 60 ? 'ornate' : 'balanced';
  const riskWord = agent.risk > 65 ? 'bold explorer' : agent.risk < 35 ? 'disciplined refiner' : 'adaptive strategist';
  const matPref = agent.platBias > 60 ? 'platinum-forward' : agent.mixedMetal > 60 ? 'mixed-metal experimentalist' : agent.diamond > 65 ? 'diamond-centric' : 'material-versatile';
  const market = agent.marginSens > 65 ? 'margin-conscious' : 'design-first';
  return `${agent.name} is a ${style}, ${matPref} ${riskWord} with a ${market} market philosophy. Specializes in ${agent.marketFocus || 'general'} with ${(agent.styleTags||[]).slice(0,3).join(', ') || 'eclectic'} sensibilities.`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   logAgentBios ‚Äî display each agent's AI-generated bio
   at the start of every cross-pollination round
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function logAgentBios(baseDelay) {
  addLog(`<b>[AGENT DOSSIERS ‚Äî Personality Profiles]</b>`, 'rp', baseDelay);
  agentStates.forEach((a, i) => {
    const bio = a.bio || buildFallbackBio(a);
    addLog(`${a.emoji} <b>${a.name}</b> ‚Äî <i>${bio}</i>`, 'rp', baseDelay + 200 + i * 250);
  });
  return baseDelay + 200 + agentStates.length * 250 + 200; // return delay after all bios
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE AI CROSS-POLLINATION
   Each agent talks to 3 other agents via Claude.
   Conversations are logged and stored in conversationMemory.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const CROSS_PAIRS = [[0,1],[2,4],[3,5],[0,3],[1,2],[4,5]]; // 6 pairs = each agent talks to 3 others

async function runLiveCrossPollination(cycleNum, afterBiosDelay) {
  let delay = afterBiosDelay;
  agentStates.forEach((a,i)=>{ setTimeout(()=>setAgentStatus(a.id,'Conversing‚Ä¶'), delay/speed); });
  addLog(`Live AI cross-pollination ‚Äî each agent consults 3 partners via Claude‚Ä¶`, 'rs', delay);
  delay += 400;

  for (const [iA, iB] of CROSS_PAIRS) {
    const agentA = agentStates[iA];
    const agentB = agentStates[iB];

    // Agent A opens
    const openPrompt = cycleNum === 1
      ? `This is cycle 1 ‚Äî no prior data. Introduce your design direction for this cycle in 1-2 sentences. Reference your personality, style genome, and market instincts. Be specific about materials, forms, and strategy.`
      : `Cycle ${cycleNum}. Review the intelligence reports from prior cycles. In 1-2 sentences, share your design direction ‚Äî what you're keeping, what you're changing, and why. Reference specific data from prior cycle reports.`;

    const msgA = await llmCall(
      `You are in a cross-pollination dialogue with ${agentB.name}. Speak in first person, 1-2 sentences only. Be specific about jewelry design ‚Äî materials, forms, market positioning.`,
      openPrompt,
      agentA
    );

    const lineA = msgA || getFallbackLine(agentA, cycleNum, 'open');
    addLog(`<b>${agentA.name}</b> ‚Üí <b>${agentB.name}</b>: "${lineA}"`, 'cv', delay);
    delay += 600;

    // Agent B responds
    const replyPrompt = `Your partner ${agentA.name} said: "${lineA}". Respond in 1-2 sentences. React to their direction ‚Äî agree, challenge, or build on it. Reference your own design instincts and genome.`;

    const msgB = await llmCall(
      `You are in a cross-pollination dialogue with ${agentA.name}. Speak in first person, 1-2 sentences only. Be specific about jewelry design ‚Äî materials, forms, market positioning.`,
      replyPrompt,
      agentB
    );

    const lineB = msgB || getFallbackLine(agentB, cycleNum, 'reply');
    addLog(`<b>${agentB.name}</b>: "${lineB}"`, 'cv', delay);
    delay += 600;

    // Store conversation memory for both agents
    agentA.conversationMemory.push({ cycle: cycleNum, partner: agentB.name, excerpt: lineB.slice(0, 120) });
    agentB.conversationMemory.push({ cycle: cycleNum, partner: agentA.name, excerpt: lineA.slice(0, 120) });
  }

  addLog(`All 6 agents complete ${CROSS_PAIRS.length} cross-pollination exchanges. Memory updated.`, 'rs', delay);
  delay += 300;
  setProgress(20);
  return delay;
}

function getFallbackLine(agent, cycle, role) {
  const style = agent.minimalism > 60 ? 'minimal, structural' : agent.ornamentation > 60 ? 'ornate, detailed' : 'balanced';
  const risk = agent.risk > 65 ? 'pushing boundaries' : agent.risk < 35 ? 'refining proven forms' : 'adapting';
  if (role === 'open') return `Cycle ${cycle} ‚Äî I'm going ${style}. ${risk}. Let's see how the market responds.`;
  return `Interesting. My genome says ${style} too ‚Äî but I'm ${risk} this round.`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE AI SYNTHESIS
   Each agent generates their design blueprint via Claude.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function runLiveSynthesis(cycleNum) {
  let delay = 200;
  agentStates.forEach(a=>setAgentStatus(a.id,'Synthesizing‚Ä¶'));
  addLog(`Synthesis phase: agents compile cross-pollination dialogues + genome into design blueprint via Claude.`,'',delay);
  delay += 400;

  const strategies = ['EXPLOIT', 'EXPLORE', 'MUTATE'];

  for (let i = 0; i < agentStates.length; i++) {
    const agent = agentStates[i];
    const synthPrompt = `Based on your genome, personality bio, conversation memory from cross-pollination, and any prior intelligence reports ‚Äî produce your design blueprint for Cycle ${cycleNum}.
Output EXACTLY this format (one line):
Strategy: [EXPLOIT or EXPLORE or MUTATE] ¬∑ [Category: Ring/Pendant/Earrings/Bracelet] ¬∑ [Brief design description, 8-12 words] ¬∑ Complexity: [1-10]/10 ¬∑ Est. margin: [40-90]%`;

    const synthResp = await llmCall(
      `You are generating a design blueprint. Output ONLY the single-line blueprint in the exact format requested. No preamble, no explanation.`,
      synthPrompt,
      agent
    );

    if (synthResp) {
      addLog(`<b>${agent.name}</b> ‚Äî ${synthResp.slice(0, 200)}`, '', delay);
    } else {
      const strat = strategies[agent.risk > 65 ? 1 : agent.risk < 35 ? 0 : 2];
      addLog(`<b>${agent.name}</b> ‚Äî Strategy: <b>${strat}</b> ¬∑ Blueprint compiled from genome + dialogue memory.`, '', delay);
    }
    delay += 500;
  }

  addLog(`All blueprints hashed. Validation gates passed.`, 'rs', delay);
  setProgress(40);
  return delay + 400;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE AI DESIGN GENERATION (Phase 2)
   Each agent produces a design via Claude based on
   their genome, bio, cross-pollination dialogue, and prior reports.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function runLiveGeneration(cycleNum) {
  setProgress(45);
  document.getElementById('designs-wrap').style.display='block';
  agentStates.forEach(a=>setAgentStatus(a.id,'Designing‚Ä¶'));
  addLog(`Live AI generation ‚Äî each agent designing via Claude (Cycle ${cycleNum})‚Ä¶`, 'rs', 100);

  const designs = [];
  const categories = ['Ring','Pendant','Earrings','Bracelet'];
  const designEmojis = ['‚¨°','üåë','‚ú®','üî∑','üíç','üåπ','üíô','‚ö°','üíé','ü¶¥','üå∏','üî•','üåø','üíõ','‚≠ê','üî∂'];

  for (let i = 0; i < agentStates.length; i++) {
    const agent = agentStates[i];
    const convMem = (agent.conversationMemory || []).filter(m => m.cycle === cycleNum).map(m => `${m.partner}: "${m.excerpt}"`).join('\n');

    const designPrompt = `You are ${agent.name}, designing for Cycle ${cycleNum}.

Your cross-pollination conversations this cycle:
${convMem || 'No conversations recorded.'}

Based on your genome, personality bio, conversations, and any prior intelligence reports, create ONE jewelry design.

Output EXACTLY this JSON (no markdown, no backticks, just raw JSON):
{"name":"[descriptive design name, 3-6 words describing materials and form]","cat":"[Ring or Pendant or Earrings or Bracelet]","strategy":"[exploit or explore or mutate]","aesthetic":[40-95],"novelty":[30-95],"profit":[35-95],"prompt":"[detailed image generation prompt: metal type, stone type, setting style, design form, photography style, background, lighting ‚Äî 30-50 words]"}`;

    const resp = await llmCall(
      'You are generating a jewelry design. Output ONLY valid JSON with the exact fields requested. No explanation, no markdown.',
      designPrompt, agent
    );

    let design = null;
    if (resp) {
      try {
        const cleaned = resp.replace(/```json?\s*/g,'').replace(/```/g,'').trim();
        design = JSON.parse(cleaned);
      } catch(e) { console.warn('Design JSON parse failed for', agent.name, resp); }
    }

    if (!design || !design.name || !design.prompt) {
      // Fallback: use sim-mode design if available
      const fallback = CYCLE_DESIGNS[cycleNum-1]?.[i];
      design = fallback ? {...fallback} : {
        name: `${agent.name}'s Cycle ${cycleNum} Design`,
        cat: categories[i % 4],
        strategy: agent.risk > 65 ? 'explore' : agent.risk < 35 ? 'exploit' : 'mutate',
        aesthetic: 50 + Math.floor(Math.random()*30),
        novelty: 40 + Math.floor(Math.random()*40),
        profit: 45 + Math.floor(Math.random()*35),
        prompt: `fine jewelry ${categories[i%4].toLowerCase()}, ${agent.philosophy || 'elegant design'}, studio photography, neutral background, professional lighting`
      };
    }

    if (!categories.includes(design.cat)) design.cat = categories[0];
    if (!['exploit','explore','mutate'].includes(design.strategy)) design.strategy = 'explore';
    design.aesthetic = Math.max(20, Math.min(98, parseInt(design.aesthetic)||60));
    design.novelty   = Math.max(20, Math.min(98, parseInt(design.novelty)||50));
    design.profit    = Math.max(20, Math.min(98, parseInt(design.profit)||55));

    design.agentIdx = agent.id;
    design.agentName = agent.name;
    design.emoji = designEmojis[i + (cycleNum-1)*6] || '‚¨°';
    design.credits = 0;

    designs.push(design);
    addLog(`<b>${agent.name}</b> submits: <i>"${design.name}"</i> ‚Äî ${design.cat} ¬∑ ${design.strategy.toUpperCase()}`, 'ds', 300 + i*400);
    setTimeout(()=>renderDesignCard(design, i), (400 + i*400)/speed);
  }

  activeDesigns = designs;
  addLog(`All ${designs.length} designs submitted. Pool locked.`, 'rs', 300 + agentStates.length*400 + 200);
  setProgress(60);
  return 300 + agentStates.length*400 + 600;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE AI VOTING (Phase 3)
   Each agent reviews all designs and allocates 10,000‚¨° via Claude.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function runLiveVoting(cycleNum) {
  setProgress(65);
  agentStates.forEach(a=>setAgentStatus(a.id,'Evaluating‚Ä¶'));
  addLog(`Live AI voting ‚Äî each agent allocates 10,000‚¨° via Claude‚Ä¶`, 'rs', 100);

  const designSummary = activeDesigns.map((d,i) =>
    `[${i}] "${d.name}" by ${d.agentName} ‚Äî ${d.cat} ¬∑ ${d.strategy} ¬∑ AES:${d.aesthetic} NOV:${d.novelty} PRO:${d.profit}`
  ).join('\n');

  const liveVoteMatrix = [];

  for (let vi = 0; vi < agentStates.length; vi++) {
    const voter = agentStates[vi];

    const votePrompt = `You are ${voter.name}, voting in Cycle ${cycleNum}. You have 10,000‚¨° to allocate across ${activeDesigns.length} designs. You CANNOT vote for your own design (index ${activeDesigns.findIndex(d=>d.agentIdx===vi)}).

The designs:
${designSummary}

Based on your genome (aesthetic preferences, risk tolerance, market focus), your bio, intelligence reports, and conversation memory ‚Äî allocate your 10,000‚¨°. Weight designs you believe deserve to win higher.

Output EXACTLY a JSON array of ${activeDesigns.length} integers that sum to 10000. Put 0 for your own design.
Example for 6 designs: [0,3500,2500,1000,2000,1000]`;

    const resp = await llmCall(
      'Output ONLY a JSON array of integers that sum to 10000. No text, no explanation.',
      votePrompt, voter
    );

    let votes = null;
    if (resp) {
      try {
        const cleaned = resp.replace(/```json?\s*/g,'').replace(/```/g,'').trim();
        const parsed = JSON.parse(cleaned);
        if (Array.isArray(parsed) && parsed.length === activeDesigns.length) {
          // Normalize to exactly 10000
          const rawSum = parsed.reduce((a,b)=>a+Math.max(0,b),0);
          votes = parsed.map(v => rawSum > 0 ? Math.round(Math.max(0,v) / rawSum * 10000) : 0);
          // Fix rounding
          const diff = 10000 - votes.reduce((a,b)=>a+b,0);
          if (diff !== 0) { const maxIdx = votes.indexOf(Math.max(...votes)); votes[maxIdx] += diff; }
          // Zero out self-vote
          const selfIdx = activeDesigns.findIndex(d=>d.agentIdx===vi);
          if (selfIdx >= 0 && votes[selfIdx] > 0) {
            const self = votes[selfIdx]; votes[selfIdx] = 0;
            const others = votes.map((v,i)=>i===selfIdx?0:v);
            const otherSum = others.reduce((a,b)=>a+b,0);
            if (otherSum > 0) votes = votes.map((v,i)=>i===selfIdx?0:v+Math.round(self*v/otherSum));
            const fix2 = 10000 - votes.reduce((a,b)=>a+b,0);
            if (fix2 !== 0) { const mi = votes.reduce((best,v,i)=>i!==selfIdx&&v>votes[best]?i:best,selfIdx===0?1:0); votes[mi]+=fix2; }
          }
        }
      } catch(e) { console.warn('Vote parse failed for', voter.name, resp); }
    }

    if (!votes) {
      // Fallback: distribute based on aesthetic preference
      const selfIdx = activeDesigns.findIndex(d=>d.agentIdx===vi);
      votes = activeDesigns.map((d,i) => {
        if (i === selfIdx) return 0;
        return d.aesthetic * 2 + d.novelty + d.profit;
      });
      const rawSum = votes.reduce((a,b)=>a+b,0);
      votes = votes.map(v => rawSum > 0 ? Math.round(v/rawSum*10000) : 0);
      const diff = 10000 - votes.reduce((a,b)=>a+b,0);
      if (diff !== 0) { const mi = votes.reduce((best,v,i)=>i!==selfIdx&&v>votes[best]?i:best,selfIdx===0?1:0); votes[mi]+=diff; }
    }

    liveVoteMatrix.push(votes);

    const top2 = votes.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v).filter(x=>x.v>0).slice(0,2);
    const msg = top2.map(x=>`"${activeDesigns[x.i]?.name}" ${x.v.toLocaleString()}‚¨°`).join(', ');
    addLog(`<b>${voter.name}</b> ‚Üí ${msg}`, 'vt', 300 + vi*400);
  }

  // Tally
  liveVoteMatrix.forEach((vv,vi)=>vv.forEach((c,di)=>{ if(di<activeDesigns.length) activeDesigns[di].credits+=c; }));
  setTimeout(()=>{
    activeDesigns.forEach((d,i)=>{ const e=document.getElementById('dc-cred-'+i); if(e) e.textContent=d.credits.toLocaleString()+'‚¨°'; });
    agentStates.forEach((a,vi)=>{ const spent=liveVoteMatrix[vi].reduce((s,v)=>s+v,0); a.credits=10000-spent; setAgentCreds(a.id,a.credits); setAgentStatus(a.id,'Voted'); });
  }, (300+agentStates.length*400+200)/speed);
  // Store for report generation
  window._liveVoteMatrix = liveVoteMatrix;
  addLog(`Voting complete. Credits tallied via Claude.`, 'rs', 300+agentStates.length*400+400);
  setProgress(80);
  return 300+agentStates.length*400+800;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   LIVE AI EVOLUTION (Phase 4)
   Claude analyzes results and determines genome shifts,
   beliefs, and trend narratives for each agent.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function runLiveEvolution(cycleNum) {
  setProgress(85);
  const sorted = [...activeDesigns].map((d,i)=>({...d,idx:i})).sort((a,b)=>b.credits-a.credits);
  const winner = sorted[0];
  const loser = sorted[sorted.length-1];

  // Winner card UI
  setTimeout(()=>{
    const wc = document.getElementById('dc-'+winner.idx);
    if(wc){ wc.classList.add('winner-card'); const body=wc.querySelector('.dcard-body'); if(body) body.insertAdjacentHTML('afterbegin','<div class="win-badge">üèÜ Cycle Winner</div>'); }
  }, 300/speed);

  addLog(`üèÜ <b>"${winner.name}"</b> by ${winner.agentName} ‚Äî ${winner.credits.toLocaleString()}‚¨°`, 'rs', 300);

  // Ask Claude to analyze results and produce evolution data
  const resultsSummary = sorted.map((d,rank) =>
    `#${rank+1}: "${d.name}" by ${agentStates[d.agentIdx]?.name} ‚Äî ${d.credits.toLocaleString()}‚¨° ¬∑ ${d.strategy} ¬∑ AES:${d.aesthetic} NOV:${d.novelty} PRO:${d.profit} ¬∑ ${d.cat}`
  ).join('\n');

  const priorContext = cycleReports.length > 0
    ? `Prior winners: ${cycleReports.map(r=>`C${r.cycle}: "${r.winner.name}"`).join(', ')}`
    : 'No prior cycles.';

  // Generate evolution for each agent
  for (let i = 0; i < agentStates.length; i++) {
    const agent = agentStates[i];
    const myDesign = sorted.find(d=>d.agentIdx===i);
    const rank = myDesign ? sorted.indexOf(myDesign) : 5;
    const isWinner = rank === 0;
    const isLoser = rank === sorted.length - 1;

    const evoPrompt = `Cycle ${cycleNum} results:
${resultsSummary}

${priorContext}

You are ${agent.name} (rank #${rank+1}, design: "${myDesign?.name||'‚Äî'}").
Analyze these results relative to your genome and prior performance.

Output EXACTLY this JSON (no markdown):
{"belief":"[one sentence: what you learned this cycle]","shifts":{"minimalism":[integer -10 to +10],"novelty":[integer -10 to +10],"ornamentation":[integer -10 to +10],"marketFit":[integer -10 to +10],"risk":[integer -10 to +10],"marginSens":[integer -10 to +10]},"trend":"[one sentence: the key market trend you see]"}

Rules: ${isWinner ? 'You WON ‚Äî reinforce your strengths, reduce risk slightly.' : isLoser ? 'You LOST ‚Äî apply mutation pressure, increase novelty, shift away from your current strategy.' : 'Mid-pack ‚Äî adapt toward what worked, away from what didnt.'}`;

    const resp = await llmCall(
      'Output ONLY valid JSON. No markdown, no explanation.',
      evoPrompt, agent
    );

    let evo = null;
    if (resp) {
      try {
        const cleaned = resp.replace(/```json?\s*/g,'').replace(/```/g,'').trim();
        evo = JSON.parse(cleaned);
      } catch(e) { console.warn('Evolution parse failed for', agent.name); }
    }

    // Apply shifts
    const genomeShifts = {};
    if (evo?.shifts) {
      Object.entries(evo.shifts).forEach(([key, delta]) => {
        if (agent[key] !== undefined && typeof delta === 'number') {
          const clamped = Math.max(-10, Math.min(10, delta));
          const oldVal = agent[key];
          agent[key] = Math.max(0, Math.min(100, agent[key] + clamped));
          genomeShifts[key] = agent[key] - oldVal;
        }
      });
    } else {
      // Fallback shifts
      const shifts = isWinner ? {novelty:+3,risk:-4} : isLoser ? {novelty:+8,risk:+6,marginSens:+4} : {novelty:+2,risk:+2};
      Object.entries(shifts).forEach(([k,d])=>{ if(agent[k]!==undefined){ const o=agent[k]; agent[k]=Math.max(0,Math.min(100,agent[k]+d)); genomeShifts[k]=agent[k]-o; }});
    }

    // Update belief
    agent.dominantBelief = evo?.belief || (isWinner ? 'My approach worked ‚Äî refine further.' : isLoser ? 'Need a fundamentally different direction.' : 'Adapt toward the winning aesthetic.');
    agent.trustBuilt = Math.min(100, (agent.trustBuilt||0) + (isWinner?15:isLoser?-5:5));

    // Update reputation
    const repDelta = cycleNum===3 ? (isWinner?12:rank<=1?5:rank<=2?2:-4) : (isWinner?9:rank<=1?4:rank<=2?1:-3);
    agent.reputation = Math.max(5, agent.reputation + repDelta);
    setAgentStatus(agent.id, isWinner ? (cycleNum===3 ? 'üèÜ Epoch Winner' : 'Winner') : 'Cycle complete');

    // Store evolution history
    agent.evolutionHistory.push({
      cycle: cycleNum,
      summary: isWinner
        ? `Won with "${myDesign?.name||'‚Äî'}" (${myDesign?.credits?.toLocaleString()||0}‚¨°). Genome reinforced.`
        : isLoser
        ? `Last place with "${myDesign?.name||'‚Äî'}". Mutation pressure applied.`
        : `Ranked #${rank+1} with "${myDesign?.name||'‚Äî'}". Adaptive shifts applied.`,
      genomeShifts,
      rank: rank + 1,
      designName: myDesign?.name || '‚Äî',
    });

    // Log the evolution
    const shiftStr = Object.entries(genomeShifts).filter(([,v])=>v!==0).map(([k,v])=>`${k}:${v>0?'+':''}${v}`).join(' ¬∑ ');
    addLog(`<b>${agent.name}</b> (${isWinner?'Winner':isLoser?'Last':'#'+(rank+1)}): <i>${agent.dominantBelief}</i> ${shiftStr?'¬∑ '+shiftStr:''}`, '', 600+i*300);
  }

  // Trend analysis via Claude
  const trendPrompt = `Cycle ${cycleNum} of 3 completed. Results:
${resultsSummary}

${priorContext}

Generate a comprehensive trend analysis for the intelligence report. Output EXACTLY this JSON:
{"emerging":["style1","style2","style3"],"declining":["style1","style2"],"saturation":"[which category/style is over-represented, e.g. 'Ring (50% of pool)']","treasury":"[recommended material+setting combination with highest combined aesthetic+profit]","velocityScore":[0-100 integer: how fast the top trend is moving],"fi":["[insight 1: specific data-driven observation about vote patterns and score correlations]","[insight 2: category saturation warning with specific percentages]","[insight 3: material/setting trend observation]","[insight 4: opportunity gap or micro-trend identification]","[insight 5: novelty premium or strategic recommendation]"]}`;

  const trendResp = await llmCall(
    'Output ONLY valid JSON. No markdown.',
    trendPrompt, agentStates[0]
  );

  let trendInsight = null;
  if (trendResp) {
    try { trendInsight = JSON.parse(trendResp.replace(/```json?\s*/g,'').replace(/```/g,'').trim()); } catch(e) {}
  }

  const trendDelay = 600 + agentStates.length*300 + 200;
  if (trendInsight) {
    const emergStr = Array.isArray(trendInsight.emerging) ? trendInsight.emerging.join(' ¬∑ ') : (trendInsight.emerging||'');
    addLog(`Emerging: <b>${emergStr}</b>`, 'rs', trendDelay);
    if (trendInsight.saturation) addLog(`Saturation: ${trendInsight.saturation}`, '', trendDelay+200);
    if (trendInsight.treasury) addLog(`Treasury: ${trendInsight.treasury}`, 'rs', trendDelay+400);
  } else {
    addLog(`Cycle ${cycleNum} evolution applied. Genome shifts recorded.`, 'rs', trendDelay);
  }

  addLog(`<b>Cycle ${cycleNum} Intelligence Report written to knowledge database.</b>`, 'rs', trendDelay+600);
  if (cycleNum === 3) document.getElementById('nav-epoch-txt').textContent = '3 / 3';

  // Take post-evolution snapshot
  genomeSnapshots.push(agentStates.map(a => snapshotGenome(a)));
  // Store trend for report
  window._liveTrend = trendInsight;
  generateAndStoreReport(cycleNum, sorted);

  setProgress(100);
  return trendDelay + 1000;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PHASE SCRIPTS (all 3 cycles)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const PHASE_SCRIPTS = [
  // ‚îÄ‚îÄ CYCLE 1 ‚îÄ‚îÄ
  [
    // Phase 0: Cross-Pollination
    async ()=>{
      setProgress(5);
      addLog(`Cycle 1 initiated. No prior data ‚Äî agents begin cold. Knowledge database empty.`,'',100);
      const d = logAgentBios(250);

      if (simMode === 'live' && apiKeys.anthropic) {
        return await runLiveCrossPollination(1, d);
      }
      // Sim mode fallback
      addLog(`<b>${agentStates[0].name}</b> ‚Üí <b>${agentStates[1].name}</b>: "First cycle. I'm thinking minimal ‚Äî structural negative space. What's your read?"`, 'cv', d);
      addLog(`<b>${agentStates[1].name}</b>: "Agreed. I want to push the geometry further. Floating elements, maximum air in the design."`, 'cv', d+500);
      addLog(`<b>${agentStates[2].name}</b> ‚Üí <b>${agentStates[4].name}</b>: "I'm going ornate ‚Äî pav√© cascade pendant. High jewelry positioning."`, 'cv', d+900);
      addLog(`<b>${agentStates[4].name}</b>: "I see a bridal market gap. Planning a clean halo ring ‚Äî strong commercial margins."`, 'cv', d+1300);
      addLog(`<b>${agentStates[3].name}</b> ‚Üí <b>${agentStates[5].name}</b>: "Industrial frame bracelet. Titanium and gold mixed. Probably not winning this cycle ‚Äî but I want to plant the flag."`, 'cv', d+1700);
      addLog(`<b>${agentStates[5].name}</b>: "I'm exploring organic form ‚Äî thorn motif. High novelty. Let's see what consensus rewards."`, 'cv', d+2100);
      agentStates.forEach((a,i)=>{ setTimeout(()=>setAgentStatus(a.id,'Conversing‚Ä¶'), (d+2400+i*100)/speed); });
      addLog(`All 6 agents complete 10 cross-pollination interactions. Summaries stored.`, 'rs', d+2900);
      setProgress(20);
      return d+3200;
    },
    // Phase 1: Synthesis
    async ()=>{
      setProgress(25);
      if (simMode === 'live' && apiKeys.anthropic) {
        return await runLiveSynthesis(1);
      }
      agentStates.forEach(a=>setAgentStatus(a.id,'Drafting blueprint‚Ä¶'));
      addLog(`Synthesis phase: agents compile dialogues + personal genome into design blueprint.`,'',200);
      addLog(`<b>${agentStates[0].name}</b> ‚Äî Strategy: <b>EXPLORE</b> ¬∑ Ring ¬∑ Platinum bezel oval ¬∑ Negative space band ¬∑ Complexity 6/10 ¬∑ Est. margin: 66%`,'',500);
      addLog(`<b>${agentStates[1].name}</b> ‚Äî Strategy: <b>EXPLORE</b> ¬∑ Earrings ¬∑ Platinum geometric drop ¬∑ Rose-cut accents ¬∑ Complexity 5/10 ¬∑ Est. margin: 71%`,'',900);
      addLog(`<b>${agentStates[2].name}</b> ‚Äî Strategy: <b>EXPLOIT</b> ¬∑ Pendant ¬∑ Rose gold pav√© cascade ¬∑ Sapphire + diamond ¬∑ Complexity 8/10 ¬∑ Est. margin: 68%`,'',1200);
      addLog(`<b>${agentStates[3].name}</b> ‚Äî Strategy: <b>EXPLORE</b> ¬∑ Bracelet ¬∑ Titanium x gold hex ¬∑ Industrial ¬∑ Complexity 9/10 ¬∑ Est. margin: 48%`,'',1500);
      addLog(`<b>${agentStates[4].name}</b> ‚Äî Strategy: <b>EXPLOIT</b> ¬∑ Ring ¬∑ White gold pav√© halo ¬∑ Classic proportions ¬∑ Complexity 5/10 ¬∑ Est. margin: 85%`,'',1800);
      addLog(`<b>${agentStates[5].name}</b> ‚Äî Strategy: <b>EXPLORE</b> ¬∑ Ring ¬∑ Blackened gold thorn band ¬∑ Sculptural ¬∑ Complexity 7/10 ¬∑ Est. margin: 44%`,'',2100);
      addLog(`All blueprints hashed. Validation gates passed: ‚úì Feasibility  ‚úì Novelty  ‚úì Margin`, 'rs', 2600);
      setProgress(40);
      return 3000;
    },
    // Phase 2: Generation
    async ()=>{
      if (simMode === 'live' && apiKeys.anthropic) return await runLiveGeneration(1);
      setProgress(45);
      document.getElementById('designs-wrap').style.display='block';
      activeDesigns = CYCLE_DESIGNS[0].map((d,i)=>({...d, credits:0, agentName: agentStates[d.agentIdx]?.name || (i===0?agentStates[0].name:'Agent')}));
      addLog(`Image generation initiated across all 6 agents‚Ä¶`,'',100);
      agentStates.forEach(a=>setAgentStatus(a.id,'Rendering‚Ä¶'));
      activeDesigns.forEach((d,i)=>{
        addLog(`<b>${d.agentName}</b> submits: <i>"${d.name}"</i> ‚Äî ${d.cat}`,'ds', 300+i*500);
        setTimeout(()=>renderDesignCard(d,i), (400+i*500)/speed);
      });
      addLog(`All 6 designs submitted. Pool locked. Voting begins.`,'rs', 3500);
      setProgress(60);
      return 4000;
    },
    // Phase 3: Voting
    async ()=>{
      if (simMode === 'live' && apiKeys.anthropic) return await runLiveVoting(1);
      setProgress(65);
      agentStates.forEach(a=>setAgentStatus(a.id,'Voting‚Ä¶'));
      addLog(`Voting phase: each agent allocates 10,000 ‚¨° across the blind pool.`,'',100);
      const vm = VOTE_MATRICES[0];
      vm.forEach((voterVotes, vi)=>{
        const voter = agentStates[vi];
        const top2 = voterVotes.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v).filter(x=>x.v>0).slice(0,2);
        if(top2.length){
          const msg = top2.map(x=>`"${activeDesigns[x.i].name}" ${x.v.toLocaleString()}‚¨°`).join(', ');
          addLog(`<b>${voter.name}</b> ‚Üí ${msg}`,'vt', 400+vi*500);
        }
      });
      vm.forEach((voterVotes, vi)=>{
        voterVotes.forEach((creds,di)=>{ if(di<activeDesigns.length) activeDesigns[di].credits += creds; });
      });
      setTimeout(()=>{
        activeDesigns.forEach((d,i)=>{ const e=document.getElementById('dc-cred-'+i); if(e) e.textContent=d.credits.toLocaleString()+'‚¨°'; });
        agentStates.forEach((a,vi)=>{ const spent=vm[vi].reduce((s,v)=>s+v,0); a.credits=10000-spent; setAgentCreds(a.id,a.credits); setAgentStatus(a.id,'Voted'); });
      }, 3500/speed);
      addLog(`Voting complete. Credits tallied.`,'rs', 4200);
      setProgress(80);
      return 5000;
    },
    // Phase 4: Evolution
    async ()=>{
      if (simMode === 'live' && apiKeys.anthropic) return await runLiveEvolution(1);
      setProgress(85);
      const sorted = [...activeDesigns].map((d,i)=>({...d,idx:i})).sort((a,b)=>b.credits-a.credits);
      const winner = sorted[0];
      const loser = sorted[sorted.length-1];
      addLog(`Ranking finalized. Applying reputation shifts‚Ä¶`,'',200);
      setTimeout(()=>{
        const wc = document.getElementById('dc-'+winner.idx);
        if(wc){
          wc.classList.add('winner-card');
          const body = wc.querySelector('.dcard-body');
          if(body) body.insertAdjacentHTML('afterbegin','<div class="win-badge">üèÜ Cycle Winner</div>');
        }
      }, 300/speed);
      addLog(`üèÜ <b>"${winner.name}"</b> by ${winner.agentName} ‚Äî ${winner.credits.toLocaleString()}‚¨°. Reputation +9. Treasury eligible.`,'rs', 500);
      addLog(`üìâ <b>${loser.agentName}</b> receives mutation pressure. Style genome shifts toward higher novelty.`,'',900);
      addLog(`Trend insight: <b>Minimal/negative-space</b> aesthetic outperformed ornate by 2.4√ó in vote conversion.`,'rs',1300);
      addLog(`Saturation alert: Rings represent 50% of pool ‚Äî agents flagged for category diversification.`,'',1700);
      addLog(`<b>Forward Intelligence generated.</b> Cycle 1 report written to shared knowledge database.`,'rs',2100);
      setProgress(100);
      sorted.forEach((d,rank)=>{ const agent=agentStates[d.agentIdx]; if(agent){ agent.reputation=Math.max(5,agent.reputation+(rank===0?9:rank===1?4:rank===2?1:-3)); setAgentStatus(agent.id,rank===0?'Winner':'Cycle complete'); }});
      evolveAgentGenomes(1, sorted);
      generateAndStoreReport(1, sorted);
      return 2800;
    },
  ],

  // ‚îÄ‚îÄ CYCLE 2 ‚îÄ‚îÄ
  [
    // Phase 0
    async ()=>{
      setProgress(5);
      const r1 = cycleReports[0];
      const winnerName = r1 ? r1.winner.name : 'Floating Geometric Circle Drop';
      const winnerAgent = r1 ? r1.winner.agentName : agentStates[1].name;
      const fi = r1 ? r1.trendData.fi : [
        'Minimal/negative-space outperformed ornate by 2.4√ó in vote conversion',
        'Ring category over-saturated ‚Äî agents should diversify',
        'Platinum + bezel setting received highest combined scores',
      ];
      const emerging = r1 ? r1.trendData.emerging.join(' ¬∑ ') : 'minimal ¬∑ negative-space ¬∑ platinum-bezel';
      const saturation = r1 ? r1.trendData.saturation : 'Ring (50% of pool)';
      const treasury = r1 ? r1.trendData.treasury : 'Platinum + bezel setting';
      const totalCredits = r1 ? r1.totalCredits.toLocaleString() : '‚Äî';
      const avgAes = r1 ? r1.avgAesthetic : '‚Äî';

      addLog(`Cycle 2 initiated. Agents loading Cycle 1 Intelligence Report‚Ä¶`,'rp',100);
      addLog(`<b>[KNOWLEDGE DATABASE ‚Äî Cycle 1 Report]</b>`, 'rp', 400);
      addLog(`‚óÜ Emerging: <b>${emerging}</b>`, 'rp', 600);
      addLog(`‚óÜ Saturation: <b>${saturation}</b> ¬∑ Treasury signal: <b>${treasury}</b>`, 'rp', 850);
      addLog(`‚óÜ ${fi[0]}`, 'rp', 1050);
      addLog(`‚óÜ ${fi[1]}`, 'rp', 1200);
      addLog(`‚óÜ ${fi[2]}`, 'rp', 1350);
      addLog(`‚óÜ Total credits circulated: <b>${totalCredits}‚¨°</b> ¬∑ Avg aesthetic: <b>${avgAes}/100</b>`, 'rp', 1500);

      const d2 = logAgentBios(1700);
      if (simMode === 'live' && apiKeys.anthropic) {
        return await runLiveCrossPollination(2, d2);
      }
      // Sim mode fallback
      addLog(`<b>${winnerAgent}</b> ‚Üí <b>${agentStates[0].name}</b>: "My '${winnerName}' won last cycle. I'm doubling down ‚Äî same minimal direction, even more intentional negative space."`, 'cv', d2);
      addLog(`<b>${agentStates[0].name}</b>: "Agreed. Exploiting that trend ‚Äî going deeper architectural. Cathedral-arch negative space. Marquise center."`, 'cv', d2+500);
      addLog(`<b>${agentStates[4].name}</b> ‚Üí <b>${agentStates[2].name}</b>: "Report confirms minimal wins. Pivoting my halo toward cleaner architecture ‚Äî the data is clear."`, 'cv', d2+900);
      addLog(`<b>${agentStates[2].name}</b>: "I'll hold romantic. But trying yellow gold ‚Äî market reports show it gaining share versus platinum."`, 'cv', d2+1300);
      addLog(`<b>${agentStates[3].name}</b>: "C1 showed high novelty wasn't rewarded enough relative to margin. Mutating ‚Äî keeping industrial edge but integrating minimal geometry."`, 'cv', d2+1700);
      addLog(`<b>${agentStates[5].name}</b>: "'${r1 ? r1.designs.sort((a,b)=>b.rank-a.rank).slice(-1)[0]?.name || 'Blackened Gold Thorn Sculpt' : 'Blackened Gold Thorn Sculpt'}' underperformed ‚Äî low margin was the kill. Pivoting to sculptural bracelet with better margin profile."`, 'cv', d2+2100);
      addLog(`Cross-pollination complete. 4 of 6 agents pivoting toward C1 winning aesthetic. Saturation risk building.`, 'rs', d2+2500);
      setProgress(20);
      return d2+2800;
    },
    // Phase 1
    async ()=>{
      setProgress(25);
      if (simMode === 'live' && apiKeys.anthropic) {
        return await runLiveSynthesis(2);
      }
      agentStates.forEach(a=>setAgentStatus(a.id,'Synthesizing‚Ä¶'));
      const r1 = cycleReports[0];
      const winnerName = r1 ? r1.winner.name : 'Floating Geometric Circle Drop';
      const winnerCat  = r1 ? r1.winner.cat  : 'Earrings';
      const topStyle   = r1 ? r1.trendData.emerging[0] : 'minimal';
      const satCat     = r1 ? r1.trendData.saturation  : 'Ring (50% of pool)';
      const treasury   = r1 ? r1.trendData.treasury    : 'Platinum + bezel setting';
      const loserName  = r1 ? r1.sortedDesigns[r1.sortedDesigns.length-1]?.name || 'Blackened Gold Thorn Sculpt' : 'Blackened Gold Thorn Sculpt';

      addLog(`Synthesis: agents cross-reference Cycle 1 Intelligence Report + personal genome.`,'',200);
      addLog(`<b>Report insight driving C2 blueprints:</b> Winner "${winnerName}" (${winnerCat}) ¬∑ Top style: ${topStyle} ¬∑ Saturation: ${satCat}`,'rp',400);
      addLog(`<b>${agentStates[0].name}</b> ‚Äî Strategy: <b>EXPLOIT</b> ¬∑ Ring ¬∑ Platinum marquise ¬∑ Cathedral negative-space ¬∑ Exploiting "${topStyle}" trend from C1 report ¬∑ Margin: 71%`,'',700);
      addLog(`<b>${agentStates[1].name}</b> ‚Äî Strategy: <b>EXPLOIT</b> ¬∑ Ring ¬∑ Platinum bezel ¬∑ Deep negative-space groove ¬∑ C1 winner "${winnerName}" refinement ¬∑ Margin: 74%`,'',1100);
      addLog(`<b>${agentStates[2].name}</b> ‚Äî Strategy: <b>EXPLOIT</b> ¬∑ Pendant ¬∑ Yellow gold sapphire canopy ¬∑ Pivoted from saturated ring category per C1 data ¬∑ Margin: 73%`,'',1500);
      addLog(`<b>${agentStates[3].name}</b> ‚Äî Strategy: <b>MUTATE</b> ¬∑ Ring ¬∑ Platinum/titanium arc ¬∑ C1: high novelty underperformed alone ‚Äî merging with ${topStyle} direction ¬∑ Margin: 53%`,'',1800);
      addLog(`<b>${agentStates[4].name}</b> ‚Äî Strategy: <b>EXPLOIT</b> ¬∑ Ring ¬∑ White gold arch shank ¬∑ Treasury signal: "${treasury}" ¬∑ Margin: 88%`,'',2100);
      addLog(`<b>${agentStates[5].name}</b> ‚Äî Strategy: <b>MUTATE</b> ¬∑ Bracelet ¬∑ Silver organic bone form ¬∑ C1: "${loserName}" failed on margin ‚Äî this cycle prioritizing margin recovery ¬∑ Margin: 50%`,'',2400);
      addLog(`Blueprint validation: ‚ö† Ring saturation at 67% (5 of 6 submissions) ‚Äî C1 ring saturation flagged but agents are still converging. Incentive nudge issued.`,'',2900);
      addLog(`All blueprints hashed and locked. C1 data successfully integrated into all agent decisions.`, 'rs', 3300);
      setProgress(40);
      return 3600;
    },
    // Phase 2
    async ()=>{
      if (simMode === 'live' && apiKeys.anthropic) return await runLiveGeneration(2);
      setProgress(45);
      document.getElementById('designs-wrap').style.display='block';
      activeDesigns = CYCLE_DESIGNS[1].map((d,i)=>({...d, credits:0, agentName: agentStates[d.agentIdx]?.name || (i===0?agentStates[0].name:'Agent')}));
      addLog(`Generation: 6 agents submit final designs.`,'',100);
      agentStates.forEach(a=>setAgentStatus(a.id,'Rendering‚Ä¶'));
      activeDesigns.forEach((d,i)=>{
        addLog(`<b>${d.agentName}</b> submits: <i>"${d.name}"</i> ‚Äî ${d.cat} ¬∑ Strategy: ${d.strategy.toUpperCase()}`,'ds',300+i*500);
        setTimeout(()=>renderDesignCard(d,i), (400+i*500)/speed);
      });
      addLog(`Pool locked. Voting begins.`,'rs',3500);
      setProgress(60);
      return 4000;
    },
    // Phase 3
    async ()=>{
      if (simMode === 'live' && apiKeys.anthropic) return await runLiveVoting(2);
      setProgress(65);
      agentStates.forEach(a=>setAgentStatus(a.id,'Voting‚Ä¶'));
      addLog(`Voting phase. Agents apply C1 learned preferences.`,'',100);
      const vm = VOTE_MATRICES[1];
      vm.forEach((voterVotes, vi)=>{
        const voter = agentStates[vi];
        const top2 = voterVotes.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v).filter(x=>x.v>0).slice(0,2);
        if(top2.length){
          const msg = top2.map(x=>`"${activeDesigns[x.i]?.name}" ${x.v.toLocaleString()}‚¨°`).join(', ');
          addLog(`<b>${voter.name}</b> ‚Üí ${msg}`,'vt',400+vi*500);
        }
      });
      vm.forEach((vv,vi)=>vv.forEach((c,di)=>{ if(di<activeDesigns.length) activeDesigns[di].credits+=c; }));
      setTimeout(()=>{
        activeDesigns.forEach((d,i)=>{ const e=document.getElementById('dc-cred-'+i); if(e) e.textContent=d.credits.toLocaleString()+'‚¨°'; });
        agentStates.forEach((a,vi)=>{ const spent=vm[vi].reduce((s,v)=>s+v,0); a.credits=10000-spent; setAgentCreds(a.id,a.credits); setAgentStatus(a.id,'Voted'); });
      }, 3500/speed);
      addLog(`Voting complete.`,'rs',4200);
      setProgress(80);
      return 5000;
    },
    // Phase 4
    async ()=>{
      if (simMode === 'live' && apiKeys.anthropic) return await runLiveEvolution(2);
      setProgress(85);
      const sorted=[...activeDesigns].map((d,i)=>({...d,idx:i})).sort((a,b)=>b.credits-a.credits);
      const winner=sorted[0]; const loser=sorted[sorted.length-1];
      addLog(`Ranking applied. Evolution phase executing.`,'',200);
      const r1ref = cycleReports[0];
      const prevWinnerName = r1ref ? r1ref.winner.name : 'Floating Geometric Circle Drop';
      setTimeout(()=>{ const wc=document.getElementById('dc-'+winner.idx); if(wc){wc.classList.add('winner-card'); const body=wc.querySelector('.dcard-body'); if(body) body.insertAdjacentHTML('afterbegin','<div class="win-badge">üèÜ Cycle Winner</div>');} },300/speed);
      addLog(`üèÜ <b>"${winner.name}"</b> by ${winner.agentName} ‚Äî ${winner.credits.toLocaleString()}‚¨°. Treasury Elevation triggered.`,'rs',500);
      addLog(`2nd consecutive minimal win ‚Äî C1: "${prevWinnerName}" ¬∑ C2: "${winner.name}". Pattern confirmed; exploitation phase in full effect.`,'rp',700);
      addLog(`‚ö† <b>Saturation alert detected:</b> 67% of pool was Ring category. Incentive multipliers issued for Earrings, Pendants, Bracelets in Cycle 3.`,'',1100);
      addLog(`Trend signal: <b>Architectural minimal</b> dominant for 2 consecutive cycles. Novelty gap widening ‚Äî opportunity forming in organic/sculptural space.`,'rs',1600);
      addLog(`<b>${loser.agentName}</b> mutation: high novelty designs consistently underperformed on margin ‚Äî agent genome adjusting margin sensitivity upward.`,'',2100);
      addLog(`<b>Cycle 2 Intelligence Report written.</b> Compiling alongside Cycle 1 data as 2-cycle trend baseline.`,'rs',2600);
      setProgress(100);
      sorted.forEach((d,rank)=>{ const agent=agentStates[d.agentIdx]; if(agent){agent.reputation=Math.max(5,agent.reputation+(rank===0?9:rank===1?4:rank===2?1:-3)); setAgentStatus(agent.id,rank===0?'Winner':'Cycle complete');}});
      evolveAgentGenomes(2, sorted);
      generateAndStoreReport(2, sorted);
      return 3000;
    },
  ],

  // ‚îÄ‚îÄ CYCLE 3 ‚îÄ‚îÄ
  [
    // Phase 0
    async ()=>{
      setProgress(5);
      const r1 = cycleReports[0];
      const r2 = cycleReports[1];
      const w1 = r1 ? r1.winner.name : 'Floating Geometric Circle Drop';
      const w2 = r2 ? r2.winner.name : 'Marquise Cathedral Arch';
      const fi1last = r1 ? r1.trendData.fi[r1.trendData.fi.length-1] : 'High-novelty designs received more votes';
      const sat2 = r2 ? r2.trendData.saturation : 'Ring (67% of pool)';
      const fi2 = r2 ? r2.trendData.fi : ['Organic/sculptural space unexplored'];
      addLog(`Cycle 3 initiated. Loading Cycle 1 + Cycle 2 Intelligence Reports‚Ä¶`,'rp',100);
      addLog(`<b>[KNOWLEDGE DATABASE ‚Äî 2-Cycle Compound Analysis]</b>`, 'rp', 400);
      addLog(`‚óÜ C1 winner: "${w1}" ¬∑ C2 winner: "${w2}" ‚Äî 2 consecutive minimal wins`, 'rp', 650);
      addLog(`‚óÜ C2 saturation: <b>${sat2}</b> ‚Äî critical threshold exceeded`, 'rp', 850);
      addLog(`‚óÜ ${fi2[0]}`, 'rp', 1050);
      addLog(`‚óÜ ${fi2[1] || fi1last}`, 'rp', 1200);
      addLog(`‚óÜ ${fi2[2] || 'Explore underrepresented categories for maximum vote advantage'}`, 'rp', 1350);

      const d3 = logAgentBios(1500);
      if (simMode === 'live' && apiKeys.anthropic) {
        return await runLiveCrossPollination(3, d3);
      }
      // Sim mode fallback
      addLog(`<b>${agentStates[1].name}</b> ‚Üí <b>${agentStates[0].name}</b>: "Minimal is saturating. My '${r2 ? r2.sortedDesigns[1]?.name||'Bezel Groove Negative-Space' : 'Bezel Groove Negative-Space'}' only ranked 2nd. I need to differentiate ‚Äî exploring a pendant this cycle."`, 'cv', d3);
      addLog(`<b>${agentStates[0].name}</b>: "I'm pushing deeper architectural ‚Äî I think one more refinement cycle before the trend exhausts."`, 'cv', d3+500);
      addLog(`<b>${agentStates[5].name}</b> ‚Üí <b>${agentStates[3].name}</b>: "Two reports say the same thing: organic/sculptural is the gap. I'm going all in ‚Äî root form bracelet."`, 'cv', d3+1000);
      addLog(`<b>${agentStates[3].name}</b>: "Agreed. I've been thinking organic geometry into my industrial approach ‚Äî Gold Shard in Platinum ‚Äî mixed metal with irregular natural form."`, 'cv', d3+1400);
      addLog(`<b>${agentStates[2].name}</b>: "Minimal is everywhere. Returning to romantic roots ‚Äî Champagne Pearl Cluster pendant, organic flowing form."`, 'cv', d3+1800);
      addLog(`<b>${agentStates[4].name}</b>: "Database confirms bridal/everyday still has strongest margins. Staying in that lane ‚Äî it's not saturated."`, 'cv', d3+2200);
      addLog(`Cross-pollination complete. Divergence detected: 3 agents pivoting organic/sculptural, 3 maintaining minimal.`, 'rs', d3+2600);
      setProgress(20);
      return d3+2900;
    },
    // Phase 1
    async ()=>{
      setProgress(25);
      if (simMode === 'live' && apiKeys.anthropic) {
        return await runLiveSynthesis(3);
      }
      agentStates.forEach(a=>setAgentStatus(a.id,'Synthesizing‚Ä¶'));
      addLog(`Synthesis: 2-cycle compound data + genome informing blueprints.`,'',200);
      addLog(`<b>${agentStates[0].name}</b> ‚Äî Strategy: <b>EXPLOIT</b> ¬∑ Ring ¬∑ Platinum emerald-cut ¬∑ Extreme negative space cathedral ¬∑ Cycle 2 winner refinement ¬∑ Margin: 68%`,'',500);
      addLog(`<b>${agentStates[1].name}</b> ‚Äî Strategy: <b>MUTATE</b> ¬∑ Pendant ¬∑ Platinum arc ¬∑ Explores pendant category gap ¬∑ Retains minimal identity ¬∑ Margin: 69%`,'',900);
      addLog(`<b>${agentStates[2].name}</b> ‚Äî Strategy: <b>EXPLORE</b> ¬∑ Pendant ¬∑ Yellow gold organic ¬∑ Champagne pearl cluster ¬∑ Return to romantic roots ¬∑ Margin: 70%`,'',1300);
      addLog(`<b>${agentStates[3].name}</b> ‚Äî Strategy: <b>MUTATE</b> ¬∑ Ring ¬∑ Mixed metal organic shard ¬∑ Industrial meets natural form ¬∑ Novel direction ¬∑ Margin: 53%`,'',1600);
      addLog(`<b>${agentStates[5].name}</b> ‚Äî Strategy: <b>EXPLORE</b> ¬∑ Bracelet ¬∑ 18k gold root form ¬∑ Treasury bracelet incentive active (+1.4√ó) ¬∑ Margin: 64%`,'',1900);
      addLog(`<b>${agentStates[4].name}</b> ‚Äî Strategy: <b>EXPLOIT</b> ¬∑ Ring ¬∑ White gold cushion ¬∑ Proven margin lane ¬∑ Consistency play ¬∑ Margin: 89%`,'',2200);
      addLog(`Ring saturation easing: 3 of 6 agents moved to pendants/bracelets. Treasury incentive active.`, 'rs', 2700);
      addLog(`All blueprints hashed and locked.`, 'rs', 3000);
      setProgress(40);
      return 3300;
    },
    // Phase 2
    async ()=>{
      if (simMode === 'live' && apiKeys.anthropic) return await runLiveGeneration(3);
      setProgress(45);
      document.getElementById('designs-wrap').style.display='block';
      activeDesigns = CYCLE_DESIGNS[2].map((d,i)=>({...d, credits:0, agentName: agentStates[d.agentIdx]?.name || (i===0?agentStates[0].name:'Agent')}));
      addLog(`Generation phase. Highest design diversity in 3 cycles.`,'',100);
      agentStates.forEach(a=>setAgentStatus(a.id,'Rendering‚Ä¶'));
      activeDesigns.forEach((d,i)=>{
        addLog(`<b>${d.agentName}</b> submits: <i>"${d.name}"</i> ‚Äî ${d.cat} ¬∑ ${d.strategy.toUpperCase()}`,'ds',300+i*500);
        setTimeout(()=>renderDesignCard(d,i),(400+i*500)/speed);
      });
      addLog(`Pool locked. Most diverse cycle pool yet.`,'rs',3500);
      setProgress(60);
      return 4000;
    },
    // Phase 3
    async ()=>{
      if (simMode === 'live' && apiKeys.anthropic) return await runLiveVoting(3);
      setProgress(65);
      agentStates.forEach(a=>setAgentStatus(a.id,'Voting‚Ä¶'));
      addLog(`Voting: agents apply 2-cycle learned preferences.`,'',100);
      const vm=VOTE_MATRICES[2];
      vm.forEach((voterVotes,vi)=>{
        const voter=agentStates[vi];
        const top2=voterVotes.map((v,i)=>({i,v})).sort((a,b)=>b.v-a.v).filter(x=>x.v>0).slice(0,2);
        if(top2.length){ const msg=top2.map(x=>`"${activeDesigns[x.i]?.name}" ${x.v.toLocaleString()}‚¨°`).join(', ');
        addLog(`<b>${voter.name}</b> ‚Üí ${msg}`,'vt',400+vi*500); }
      });
      vm.forEach((vv,vi)=>vv.forEach((c,di)=>{ if(di<activeDesigns.length) activeDesigns[di].credits+=c; }));
      setTimeout(()=>{
        activeDesigns.forEach((d,i)=>{ const e=document.getElementById('dc-cred-'+i); if(e) e.textContent=d.credits.toLocaleString()+'‚¨°'; });
        agentStates.forEach((a,vi)=>{ const spent=vm[vi].reduce((s,v)=>s+v,0); a.credits=10000-spent; setAgentCreds(a.id,a.credits); setAgentStatus(a.id,'Voted'); });
      },3500/speed);
      addLog(`Voting complete.`,'rs',5000);
      setProgress(80);
      return 5500;
    },
    // Phase 4
    async ()=>{
      if (simMode === 'live' && apiKeys.anthropic) return await runLiveEvolution(3);
      setProgress(85);
      const sorted=[...activeDesigns].map((d,i)=>({...d,idx:i})).sort((a,b)=>b.credits-a.credits);
      const winner=sorted[0];
      addLog(`Ranking applied. Epoch-level evolution processing.`,'',200);
      setTimeout(()=>{ const wc=document.getElementById('dc-'+winner.idx); if(wc){wc.classList.add('winner-card'); const body=wc.querySelector('.dcard-body'); if(body) body.insertAdjacentHTML('afterbegin','<div class="win-badge">üèÜ Cycle Winner</div>');} },300/speed);
      addLog(`üèÜ <b>"${winner.name}"</b> by ${winner.agentName} ‚Äî ${winner.credits.toLocaleString()}‚¨°. Epoch breakout design.`,'rs',500);
      addLog(`<b>Epoch conclusion:</b> 3-cycle trend lifecycle complete.`,'rs',1000);
      addLog(`Epoch complete. Full 3-cycle intelligence archive compiled.`,'rs',2000);
      setProgress(100);
      sorted.forEach((d,rank)=>{ const agent=agentStates[d.agentIdx]; if(agent){agent.reputation=Math.max(5,agent.reputation+(rank===0?12:rank===1?5:rank===2?2:-4)); setAgentStatus(agent.id,rank===0?'üèÜ Epoch Winner':'Epoch complete');}});
      evolveAgentGenomes(3, sorted);
      generateAndStoreReport(3, sorted);
      document.getElementById('nav-epoch-txt').textContent = '3 / 3';
      return 2800;
    },
  ],
];

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DESIGN CARDS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function renderDesignCard(d, i) {
  const grid = document.getElementById('dgrid');
  const card = document.createElement('div');
  card.className = 'dcard'; card.id = 'dc-'+i;

  const loaderId = 'dcl-'+i;
  const imgId    = 'dci-'+i;
  const pctId    = 'dcp-'+i;

  card.innerHTML = `
    <div class="dcard-img-wrap">
      <div class="dcard-img-loader" id="${loaderId}">
        <div class="di-gem" id="${pctId}-gem"></div>
        <div class="di-pct" id="${pctId}">0%</div>
      </div>
      <img class="dcard-img" id="${imgId}" alt="${d.name}" />
    </div>
    <div class="dcard-body">
      <div class="dname">${d.name}</div>
      <div class="dagent">${d.agentName}</div>
      <div class="dbar"><span class="dbar-l">AES</span><div class="dbar-t"><div class="dbar-f" id="dbf-aes-${i}" style="width:0%"></div></div></div>
      <div class="dbar"><span class="dbar-l">NOV</span><div class="dbar-t"><div class="dbar-f" id="dbf-nov-${i}" style="width:0%"></div></div></div>
      <div class="dbar"><span class="dbar-l">PRO</span><div class="dbar-t"><div class="dbar-f" id="dbf-pro-${i}" style="width:0%"></div></div></div>
      <div class="dcred" id="dc-cred-${i}">‚Äî</div>
    </div>`;
  grid.appendChild(card);

  // Set emoji via DOM (safe ‚Äî avoids emoji-in-HTML-attribute bug)
  const gemEl = document.getElementById(pctId+'-gem');
  if (gemEl) gemEl.textContent = d.emoji;

  // Animate score bars
  setTimeout(()=>{
    const a = document.getElementById('dbf-aes-'+i);
    const n = document.getElementById('dbf-nov-'+i);
    const p = document.getElementById('dbf-pro-'+i);
    if (a) a.style.width = d.aesthetic+'%';
    if (n) n.style.width = d.novelty+'%';
    if (p) p.style.width = d.profit+'%';
  }, 80);

  // Attach image events via JS ‚Äî avoids emoji/quote issues in HTML attributes
  const img = document.getElementById(imgId);
  const loader = document.getElementById(loaderId);

  const seed = (d.agentIdx * 997 + currentCycle * 113 + i * 31 + 7) | 0;

  const showError = () => {
    if (loader) {
      loader.classList.remove('hidden');
      loader.innerHTML = '';
      const e = document.createElement('div');
      e.textContent = d.emoji;
      e.style.cssText = 'font-size:2rem;text-align:center';
      const lbl = document.createElement('div');
      lbl.textContent = 'Image unavailable';
      lbl.style.cssText = 'font-size:.6rem;color:var(--dim);letter-spacing:.1em;margin-top:.3rem';
      loader.appendChild(e);
      loader.appendChild(lbl);
    }
  };

  let retried = false;
  const retryOnce = () => {
    if (retried) { showError(); return; }
    retried = true;
    const pEl = document.getElementById(pctId);
    if (pEl) pEl.textContent = 'Retrying‚Ä¶';
    // Retry with a short, simple prompt after a brief delay
    setTimeout(() => {
      const shortPrompt = (d.cat || 'jewelry') + ' ' + (d.name || 'design').slice(0, 40);
      img.src = makeImgUrlFree(shortPrompt, seed + 1);
    }, 2000);
  };

  img.onload = () => {
    img.classList.add('loaded');
    if (loader) loader.classList.add('hidden');
  };
  img.onerror = retryOnce;

  // 30 second timeout ‚Äî if still loading, retry then error
  const timeout = setTimeout(() => {
    if (!img.classList.contains('loaded')) retryOnce();
  }, 30000);
  img.addEventListener('load',  () => clearTimeout(timeout), {once:true});

  // Start progress animation
  cardImgProgress(pctId, loaderId);

  // Stagger image loads to avoid Pollinations rate limits (~1 req per 5s)
  const staggerDelay = i * 5000;

  // Set src AFTER attaching events ‚Äî use Higgsfield if available
  if (apiKeys.higgsfield) {
    setTimeout(() => {
      resolveImgUrl(d.prompt, seed).then(url => { img.src = url; }).catch(() => { img.src = makeImgUrlFree(d.prompt, seed); });
    }, staggerDelay);
  } else {
    setTimeout(() => { img.src = makeImgUrlFree(d.prompt, seed); }, staggerDelay);
  }
}

function cardImgProgress(pctId, loaderId) {
  let pct = 0;
  let phase = 'fast'; // fast 0-80, slow 80-95, waiting 95+
  const interval = setInterval(()=>{
    if (!document.getElementById(pctId)) { clearInterval(interval); return; }
    const loader = document.getElementById(loaderId);
    if (loader && loader.classList.contains('hidden')) { clearInterval(interval); return; }
    const el = document.getElementById(pctId);
    if (!el) { clearInterval(interval); return; }
    // Skip if showing "Retrying‚Ä¶" text
    if (el.textContent === 'Retrying‚Ä¶') return;
    if (pct < 80) {
      pct = Math.min(pct + Math.floor(Math.random()*8+3), 80);
    } else if (pct < 95) {
      pct = Math.min(pct + Math.floor(Math.random()*2+1), 95);
    } else {
      // Pulse between 95-98 to show still waiting
      pct = 95 + Math.floor(Math.random()*4);
    }
    el.textContent = pct+'%';
  }, 500);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   IMAGE GENERATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// Free fallback via Pollinations
function makeImgUrlFree(prompt, seed) {
  // Keep prompt short to avoid URL length issues and improve generation speed
  const base = prompt.slice(0, 140).replace(/[^\w\s,.'-]/g, '');
  const full = `fine jewelry, ${base}, studio lighting, photorealistic, white background`;
  return `https://image.pollinations.ai/prompt/${encodeURIComponent(full)}?width=512&height=512&seed=${seed}&model=flux`;
}

// Higgsfield SOUL text-to-image (async ‚Äî returns image URL or null)
async function higgsFieldGenerate(prompt) {
  if (!apiKeys.higgsfield) return null;
  const full = `fine jewelry, ${prompt.slice(0, 300)}, studio lighting, photorealistic`;
  try {
    const resp = await fetch('https://platform.higgsfield.ai/higgsfield-ai/soul/standard', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Key ${apiKeys.higgsfield}`
      },
      body: JSON.stringify({ prompt: full, aspect_ratio: '1:1', resolution: '720p' })
    });
    const data = await resp.json();
    if (data.status === 'completed' && data.images?.[0]?.url) return data.images[0].url;
    if (data.request_id) {
      // Poll for completion (max ~40s)
      const statusUrl = data.status_url || `https://platform.higgsfield.ai/requests/${data.request_id}/status`;
      for (let attempt = 0; attempt < 16; attempt++) {
        await new Promise(r => setTimeout(r, 2500));
        const poll = await fetch(statusUrl, { headers: { 'Authorization': `Key ${apiKeys.higgsfield}` } });
        const st = await poll.json();
        if (st.status === 'completed' && st.images?.[0]?.url) return st.images[0].url;
        if (st.status === 'failed' || st.status === 'nsfw') break;
      }
    }
  } catch(e) { console.warn('Higgsfield image gen failed:', e); }
  return null;
}

// Async version used by gallery builder when Higgsfield key is present
async function resolveImgUrl(prompt, seed) {
  if (apiKeys.higgsfield) {
    const url = await higgsFieldGenerate(prompt);
    if (url) return url;
  }
  return makeImgUrlFree(prompt, seed);
}

function buildTop3Gallery(sortedDesigns, containerId, cardClass) {
  const container = document.getElementById(containerId);
  if (!container) return;
  const top3 = sortedDesigns.slice(0, 3);
  const ranks = ['1st Place', '2nd Place', '3rd Place'];
  const rankClass = ['first', '', ''];
  const stratColors = { exploit:'strat-exploit', explore:'strat-explore', mutate:'strat-mutate' };

  container.innerHTML = top3.map((d, i) => `
    <div class="top3-card ${i===0?cardClass:''}">
      <div class="top3-img-wrap" id="imgwrap-${containerId}-${i}">
        <div class="top3-img-loader" id="loader-${containerId}-${i}">
          <div class="gem" id="gem-${containerId}-${i}"></div>
          <div class="lbl">Rendering</div>
          <div class="pct" id="pct-${containerId}-${i}">0%</div>
        </div>
        <img class="top3-img" id="img-${containerId}-${i}" alt="${d.name}" />
      </div>
      <div class="top3-meta">
        <div class="top3-rank ${rankClass[i]}">${ranks[i]}</div>
        <div class="top3-name">"${d.name}"</div>
        <div class="top3-by">by ${d.agentName||'Agent'}</div>
        <div class="top3-creds">${(d.credits||0).toLocaleString()} ‚¨°</div>
        <div class="top3-creds-lbl">Forge Credits</div>
        <span class="top3-strat ${stratColors[d.strategy]||'strat-explore'}">${(d.strategy||'explore').toUpperCase()}</span>
      </div>
    </div>`).join('');

  // Attach events and set src via DOM after render
  top3.forEach((d, i) => {
    const gemEl = document.getElementById(`gem-${containerId}-${i}`);
    if (gemEl) gemEl.textContent = d.emoji;

    const img    = document.getElementById(`img-${containerId}-${i}`);
    const loader = document.getElementById(`loader-${containerId}-${i}`);
    const seed   = (d.agentIdx * 1000 + currentCycle * 100 + i * 17 + 42) | 0;

    const showFallback = () => {
      if (loader) {
        loader.classList.remove('hidden');
        loader.innerHTML = `<div style="font-size:2.5rem;text-align:center">${d.emoji}</div><div style="font-size:.6rem;color:var(--dim);letter-spacing:.1em;text-transform:uppercase;margin-top:.4rem">Image unavailable</div>`;
      }
      checkAllImagesLoaded(containerId);
    };

    if (img) {
      let retried = false;
      const retryOnce = () => {
        if (retried) { showFallback(); return; }
        retried = true;
        const pEl = document.getElementById(`pct-${containerId}-${i}`);
        if (pEl) pEl.textContent = 'Retrying‚Ä¶';
        setTimeout(() => {
          const shortPrompt = (d.cat || 'jewelry') + ' ' + (d.name || 'design').slice(0, 40);
          img.src = makeImgUrlFree(shortPrompt, seed + 1);
        }, 2000);
      };

      img.onload = () => {
        img.classList.add('loaded');
        if (loader) loader.classList.add('hidden');
        checkAllImagesLoaded(containerId);
      };
      img.onerror = retryOnce;
      const imgTimeout = setTimeout(() => { if (!img.classList.contains('loaded')) retryOnce(); }, 30000);
      img.addEventListener('load', () => clearTimeout(imgTimeout), {once:true});

      // Stagger image loads to avoid rate limits
      const staggerDelay = i * 5000;
      if (apiKeys.higgsfield) {
        setTimeout(() => {
          resolveImgUrl(d.prompt, seed).then(url => { if (img) img.src = url; }).catch(()=> { img.src = makeImgUrlFree(d.prompt, seed); });
        }, staggerDelay);
      } else {
        setTimeout(() => { img.src = makeImgUrlFree(d.prompt, seed); }, staggerDelay);
      }
    }

    animateProgress(containerId, i);
  });
}

function animateProgress(prefix, i) {
  let pct = 0;
  const el = document.getElementById(`pct-${prefix}-${i}`);
  const interval = setInterval(() => {
    if (!el) { clearInterval(interval); return; }
    if (el.textContent === 'Retrying‚Ä¶') return;
    const loaderEl = document.getElementById(`loader-${prefix}-${i}`);
    if (loaderEl && loaderEl.classList.contains('hidden')) { clearInterval(interval); return; }
    if (pct < 80) {
      pct = Math.min(pct + Math.floor(Math.random()*8+3), 80);
    } else if (pct < 95) {
      pct = Math.min(pct + Math.floor(Math.random()*2+1), 95);
    } else {
      pct = 95 + Math.floor(Math.random()*4);
    }
    el.textContent = pct + '%';
  }, 500);
}

function onImgLoad(prefix, i) {
  const loader = document.getElementById(`loader-${prefix}-${i}`);
  const img = document.getElementById(`img-${prefix}-${i}`);
  const pctEl = document.getElementById(`pct-${prefix}-${i}`);
  if (pctEl) pctEl.textContent = '100%';
  if (loader) loader.classList.add('hidden');
  if (img) img.classList.add('loaded');
  checkAllImagesLoaded(prefix);
}

function onImgError(prefix, i, emoji) {
  const loader = document.getElementById(`loader-${prefix}-${i}`);
  if (loader) {
    loader.innerHTML = `<div style="font-size:2.5rem">${emoji}</div><div class="lbl" style="color:var(--dim)">Image unavailable</div>`;
  }
  checkAllImagesLoaded(prefix);
}

function checkAllImagesLoaded(prefix) {
  // Check if all 3 images for this prefix are settled
  const imgs = [0,1,2].map(i => document.getElementById(`img-${prefix}-${i}`));
  const loaders = [0,1,2].map(i => document.getElementById(`loader-${prefix}-${i}`));
  const allDone = loaders.every(l => !l || l.classList.contains('hidden') || l.textContent.includes('unavailable'));
  if (allDone || imgs.filter(im => im && im.classList.contains('loaded')).length >= 2) {
    const dot = document.getElementById('img-dot');
    const lbl = document.getElementById('img-gen-label');
    if (dot) dot.classList.add('done');
    if (lbl) lbl.textContent = 'Images generated from agent prompts.';
  }
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   CYCLE COMPLETE PANEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function showCycleComplete() {
  const sorted = [...activeDesigns].map((d,i)=>({...d,idx:i})).sort((a,b)=>b.credits-a.credits);
  const winner = sorted[0];
  const panel = document.getElementById('cc-panel');
  document.getElementById('cc-num').textContent = String(currentCycle).padStart(2,'0');
  document.getElementById('cc-sub').textContent = `Consensus reached. ${sorted.length} designs evaluated. Intelligence Report #${currentCycle} written to archive.`;

  // Reset image status
  const dot = document.getElementById('img-dot');
  const lbl = document.getElementById('img-gen-label');
  if (dot) dot.classList.remove('done');
  if (lbl) lbl.textContent = 'Generating images from agent prompts‚Ä¶';

  // Ensure agentName is set on sorted designs
  sorted.forEach(d => {
    if (!d.agentName) d.agentName = agentStates[d.agentIdx]?.name || 'Agent';
  });

  // Build top 3 image gallery
  buildTop3Gallery(sorted, 'top3-gallery', 'gold-card');

  const nextBtn = document.getElementById('cc-next-btn');
  if(currentCycle < 3) {
    nextBtn.textContent = `‚ñ∂ Begin Cycle ${currentCycle+1}`;
    nextBtn.onclick = ()=>{ currentCycle++; resetSim(); panel.className='cycle-complete'; document.getElementById('phase-btn').style.display=''; };
  } else {
    nextBtn.textContent = '‚óÜ View Full Intelligence Archive';
    nextBtn.onclick = ()=>{ goTo(3); viewReport(3); };
  }
  panel.classList.add('show');
  updateReportsNav();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   ANALYTICS UTILITIES
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function pearsonCorr(xs, ys) {
  const n = xs.length;
  if (n < 2) return 0;
  const mx = xs.reduce((a,b)=>a+b,0)/n, my = ys.reduce((a,b)=>a+b,0)/n;
  let num=0, dx2=0, dy2=0;
  for(let i=0;i<n;i++){
    const dx=xs[i]-mx, dy=ys[i]-my;
    num+=dx*dy; dx2+=dx*dx; dy2+=dy*dy;
  }
  return dx2&&dy2 ? +(num/Math.sqrt(dx2*dy2)).toFixed(3) : 0;
}
function giniCoeff(vals) {
  const s = [...vals].sort((a,b)=>a-b);
  const n = s.length, tot = s.reduce((a,b)=>a+b,0);
  if (!tot) return 0;
  let num = 0;
  s.forEach((v,i) => num += (2*(i+1)-n-1)*v);
  return +(num / (n*tot)).toFixed(3);
}
function linearSlope(xs, ys) {
  const n = xs.length;
  const mx = xs.reduce((a,b)=>a+b,0)/n, my = ys.reduce((a,b)=>a+b,0)/n;
  let num=0, den=0;
  for(let i=0;i<n;i++){ const dx=xs[i]-mx; num+=dx*(ys[i]-my); den+=dx*dx; }
  return den ? +(num/den).toFixed(1) : 0;
}
function pct(v, tot) { return tot ? Math.round(v/tot*100) : 0; }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REPORT GENERATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function generateAndStoreReport(cycleNum, sortedDesigns) {
  const voteMatrix = (simMode === 'live' && window._liveVoteMatrix) ? window._liveVoteMatrix : VOTE_MATRICES[cycleNum-1];
  const designs = activeDesigns.map((d,i)=>({
    ...d,
    rank: sortedDesigns.findIndex(s=>s.idx===i)+1,
    agentName: d.agentName || agentStates[d.agentIdx]?.name || 'Agent'
  }));
  const totalCredits = designs.reduce((s,d)=>s+d.credits,0);

  // ‚îÄ‚îÄ Score averages ‚îÄ‚îÄ
  const avgAesthetic = +(designs.reduce((s,d)=>s+d.aesthetic,0)/designs.length).toFixed(1);
  const avgNovelty   = +(designs.reduce((s,d)=>s+d.novelty,0)/designs.length).toFixed(1);
  const avgProfit    = +(designs.reduce((s,d)=>s+d.profit,0)/designs.length).toFixed(1);

  // ‚îÄ‚îÄ Correlation: which score dimension predicted credits best? ‚îÄ‚îÄ
  const credits = designs.map(d=>d.credits);
  const corrAes = pearsonCorr(designs.map(d=>d.aesthetic), credits);
  const corrNov = pearsonCorr(designs.map(d=>d.novelty), credits);
  const corrPro = pearsonCorr(designs.map(d=>d.profit), credits);
  const topCorr = corrAes>=corrNov&&corrAes>=corrPro?'Aesthetic':corrNov>=corrPro?'Novelty':'Profit';

  // ‚îÄ‚îÄ Vote concentration ‚îÄ‚îÄ
  const gini = giniCoeff(credits);
  const winnerShare = pct(sortedDesigns[0].credits, totalCredits);
  const top3Share   = pct(sortedDesigns.slice(0,3).reduce((s,d)=>s+d.credits,0), totalCredits);

  // ‚îÄ‚îÄ Novelty premium: extra credits per novelty point above average ‚îÄ‚îÄ
  const avgNov2 = designs.reduce((s,d)=>s+d.novelty,0)/designs.length;
  const novSlope = linearSlope(designs.map(d=>d.novelty-avgNov2), designs.map(d=>d.credits));

  // ‚îÄ‚îÄ Strategy performance ‚îÄ‚îÄ
  const stratBuckets = {exploit:[], explore:[], mutate:[]};
  designs.forEach(d=>{ (stratBuckets[d.strategy]||=[]).push(d.credits); });
  const stratPerf = Object.fromEntries(Object.entries(stratBuckets).map(([k,v])=>[k,{
    count: v.length,
    avgCreds: v.length ? Math.round(v.reduce((a,b)=>a+b,0)/v.length) : 0,
    won: sortedDesigns[0].strategy===k ? 1 : 0
  }]));

  // ‚îÄ‚îÄ Category performance ‚îÄ‚îÄ
  const catMap = {};
  designs.forEach(d=>{
    if(!catMap[d.cat]) catMap[d.cat]={count:0,totalCreds:0,totalAes:0,totalNov:0};
    catMap[d.cat].count++;
    catMap[d.cat].totalCreds+=d.credits;
    catMap[d.cat].totalAes+=d.aesthetic;
    catMap[d.cat].totalNov+=d.novelty;
  });
  const catCount = Object.fromEntries(Object.entries(catMap).map(([k,v])=>[k,v.count]));

  // ‚îÄ‚îÄ Agent performance snapshot ‚îÄ‚îÄ
  const agentPerf = agentStates.map((a,idx)=>{
    const myDesign = designs.find(d=>d.agentIdx===idx);
    const earned   = myDesign?.credits || 0;
    const spent    = (voteMatrix[idx]||[]).reduce((s,v)=>s+v,0);
    const prevRep  = cycleReports.length > 0 ? cycleReports[cycleReports.length-1].agentSnapshot[idx]?.reputation || a.reputation : 50;
    return {
      id: a.id, name: a.name, emoji: a.emoji, arch: a.arch,
      earned, spent, roi: spent ? +(earned/spent).toFixed(2) : 0,
      reputation: a.reputation,
      repDelta: a.reputation - prevRep,
      strategy: myDesign?.strategy || '‚Äî',
      rank: myDesign?.rank || 7,
      designName: myDesign?.name || '‚Äî',
      isUser: a.isUser || false
    };
  });

  // ‚îÄ‚îÄ Self-vote analysis ‚îÄ‚îÄ
  const selfVotes = agentStates.map((a,idx)=>{
    const myDesignIdx = designs.findIndex(d=>d.agentIdx===idx);
    return myDesignIdx>=0 ? (voteMatrix[idx]?.[myDesignIdx]||0) : 0;
  });
  const totalSelfVotes = selfVotes.reduce((a,b)=>a+b,0);
  const selfVotePct = pct(totalSelfVotes, totalCredits);

  // ‚îÄ‚îÄ Voter alignment: did high-aesthetic voters cluster? ‚îÄ‚îÄ
  // Which pair of agents agreed most (voted same top pick)?
  let maxAlign = 0, alignPair = ['‚Äî','‚Äî'];
  for(let i=0;i<agentStates.length;i++) for(let j=i+1;j<agentStates.length;j++){
    const vi = voteMatrix[i]||[], vj = voteMatrix[j]||[];
    const topI = vi.indexOf(Math.max(...vi)), topJ = vj.indexOf(Math.max(...vj));
    if(topI===topJ && vi[topI]>0) { const shared=vi[topI]+vj[topJ]; if(shared>maxAlign){ maxAlign=shared; alignPair=[agentStates[i].name,agentStates[j].name]; } }
  }

  // ‚îÄ‚îÄ Trend narratives: Claude-generated in live mode, fallback in sim mode ‚îÄ‚îÄ
  let trendData;
  if (simMode === 'live' && window._liveTrend) {
    // Use Claude-generated trend analysis from runLiveEvolution
    const lt = window._liveTrend;
    trendData = {
      emerging: lt.emerging || ['emerging-style'],
      declining: lt.declining || ['declining-style'],
      saturation: lt.saturation || 'Unknown',
      treasury: lt.treasury || 'Unknown',
      velocityScore: lt.velocityScore || 70,
      fi: lt.fi || [`Cycle ${cycleNum} trend analysis generated by Claude based on live agent performance data.`]
    };
  } else {
    // Sim-mode fallback
    trendData = [
      {
        emerging:['minimal','negative-space','platinum-bezel'],
        declining:['ornate-pav√©','traditional-solitaire'],
        saturation:'Ring (50% of pool)',
        treasury:'Platinum + bezel setting',
        velocityScore: 72,
        fi:[
          `Minimal/negative-space outperformed ornate by ${(corrAes*2.4).toFixed(1)}√ó in vote conversion ‚Äî aesthetic score was the #1 predictor (r=${corrAes})`,
          `Ring category over-saturated at 50% of pool ‚Äî agents should diversify into earrings and pendants next cycle`,
          `Platinum + bezel setting scored highest combined aesthetic (${sortedDesigns[0].aesthetic}/100) and profit margin`,
          `"${sortedDesigns[0].name}" micro-trend identified as emerging cluster ‚Äî ${winnerShare}% vote capture`,
          `High-novelty designs (>75) earned ${novSlope>0?'+'+novSlope:novSlope}‚¨° per novelty point above average ‚Äî novelty premium confirmed`,
        ]
      },
      {
        emerging:['architectural','open-structural','yellow-gold'],
        declining:['classic-pav√©-halo','heavy-pav√©'],
        saturation:'Ring (67% of pool)',
        treasury:'Architectural shank + yellow gold accent',
        velocityScore: 61,
        fi:[
          `Architectural minimal dominant for 2 consecutive cycles ‚Äî exploitation phase, diminishing novelty premium (${novSlope>0?'+':''}${novSlope}‚¨°/novelty pt)`,
          `Ring saturation critical at 67% ‚Äî treasury issuing category diversification incentives for Cycle 3`,
          `Yellow gold gaining share vs. white gold/platinum in pendant and bracelet categories`,
          `Organic/sculptural space entirely unexplored across 12 submitted designs ‚Äî maximum opportunity gap`,
          `Vote concentration at Gini ${gini} ‚Äî ${gini>0.35?'high concentration: consensus forming around clear winners':'distributed: no runaway leader, competitive field'}`,
        ]
      },
      {
        emerging:['organic-sculptural','root-form','natural-geometry'],
        declining:['flat-minimal','basic-negative-space'],
        saturation:'Minimal cluster (62% of pool)',
        treasury:'Organic 18k gold + diamond accent nodes',
        velocityScore: 88,
        fi:[
          `Organic/sculptural breakout: "${sortedDesigns[0].name}" captured ${winnerShare}% of all credits despite ${sortedDesigns[0].profit}/100 profit score ‚Äî aesthetic novelty overrode margin`,
          `Trend lifecycle confirmed over 3 cycles: minimal emerged (C1, ${cycleReports[0]?.winner?.name||'‚Äî'}) ‚Üí peaked (C2, ${cycleReports[1]?.winner?.name||'‚Äî'}) ‚Üí displaced (C3)`,
          `Novelty score became dominant predictor this cycle (r=${corrNov}) ‚Äî market rewarding freshness over safety`,
          `Saturation penalty effective: minimal cluster received 18% fewer credits per novelty point than prior cycle`,
          `Treasury recommendation: organic sculptural 18k gold for physical production ‚Äî highest aesthetic + highest novelty + breakout vote share`,
        ]
      }
    ][cycleNum-1];
  }

  // ‚îÄ‚îÄ Genome evolution data ‚îÄ‚îÄ
  const beforeSnap = genomeSnapshots[cycleNum - 1] || [];
  const afterSnap = genomeSnapshots[cycleNum] || [];
  const genomeEvolution = agentStates.map((agent, idx) => {
    const before = beforeSnap[idx] || {};
    const after = afterSnap[idx] || snapshotGenome(agent);
    const dims = ['minimalism','novelty','ornamentation','marketFit','symmetry','platBias','coloredStone','diamond','mixedMetal','risk','marginSens','complexBudget'];
    const shifts = {};
    dims.forEach(d => { shifts[d] = (after[d] || 0) - (before[d] || 0); });
    const myDesign = sortedDesigns.find(d => d.agentIdx === idx);
    return {
      id: agent.id, name: agent.name, emoji: agent.emoji,
      before, after, shifts,
      styleTags: after.styleTags || [],
      prevStyleTags: before.styleTags || [],
      dominantBelief: agent.dominantBelief || '',
      trustBuilt: agent.trustBuilt || 0,
      rank: myDesign?.rank || 0,
      designName: myDesign?.name || '‚Äî',
      cycleSummary: (agent.evolutionHistory || []).find(e => e.cycle === cycleNum)?.summary || '',
    };
  });

  // Build full report object
  const report = {
    cycle: cycleNum,
    date: new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),
    time: new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),
    winner: sortedDesigns[0],
    totalCredits, avgAesthetic, avgNovelty, avgProfit,
    corrAes, corrNov, corrPro, topCorr,
    gini, winnerShare, top3Share,
    novSlope, selfVotePct, alignPair,
    stratPerf, catMap, catCount, trendData,
    designs, sortedDesigns,
    agentPerf, voteMatrix,
    agentSnapshot: agentStates.map(a=>({...a})),
    genomeEvolution,
  };

  cycleReports.push(report);
  updateReportsNav();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   REPORT RENDERING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function updateReportsNav() {
  const nav = document.getElementById('report-nav-list');
  if(!cycleReports.length){ nav.innerHTML='<div class="rn-empty">No cycles complete yet.</div>'; return; }
  nav.innerHTML = cycleReports.map((r,i)=>`
    <div class="rn-item" onclick="viewReport(${i+1})" id="rni-${r.cycle}">
      <div class="rni-num">Cycle ${r.cycle}</div>
      <div class="rni-label">${r.date}</div>
      <div class="rni-winner">"${r.winner.name}"</div>
    </div>
  `).join('');
  if(cycleReports.length===3) document.getElementById('dl-all-btn').style.display='';
  document.getElementById('reports-sub').textContent = `${cycleReports.length} of 3 cycle reports generated. Each report feeds forward into agent decision-making for the next cycle.`;
}

function buildGenomeEvolutionHtml(r) {
  const evo = r.genomeEvolution || [];
  if (!evo.length) return '<div style="color:var(--faint);font-size:.78rem">No genome evolution data available.</div>';

  const dimLabels = {
    minimalism:'Minimalism', novelty:'Novelty', ornamentation:'Ornament',
    marketFit:'Market Fit', risk:'Risk', marginSens:'Margin Sens',
    symmetry:'Symmetry', platBias:'Platinum', coloredStone:'Color Stone',
    diamond:'Diamond', mixedMetal:'Mix Metal', complexBudget:'Complexity'
  };
  // Show top 4 most-changed dimensions per agent
  const topDims = (shifts) => {
    return Object.entries(shifts)
      .filter(([,v]) => v !== 0)
      .sort((a,b) => Math.abs(b[1]) - Math.abs(a[1]))
      .slice(0, 4);
  };

  return `<div class="genome-grid">${evo.map(ag => {
    const dims = topDims(ag.shifts);
    const arrowCls = (v) => v > 0 ? 'up' : v < 0 ? 'down' : 'flat';
    const arrowSym = (v) => v > 0 ? '‚Üë' : v < 0 ? '‚Üì' : '‚Äî';

    // Style tag diff
    const newTags = (ag.styleTags||[]).filter(t => !(ag.prevStyleTags||[]).includes(t));
    const lostTags = (ag.prevStyleTags||[]).filter(t => !(ag.styleTags||[]).includes(t));
    const keptTags = (ag.styleTags||[]).filter(t => (ag.prevStyleTags||[]).includes(t));

    const rankBadge = ag.rank === 1
      ? '<span class="gc-result-badge win">WINNER</span>'
      : ag.rank >= 6
      ? '<span class="gc-result-badge loss">LAST</span>'
      : '';

    return `<div class="genome-card">
      <div class="genome-card-hdr">
        <span class="gc-emoji">${ag.emoji}</span>
        <span class="gc-name">${ag.name}</span>
        ${rankBadge}
      </div>
      ${dims.map(([key, delta]) => {
        const afterVal = ag.after?.[key] ?? 50;
        const col = delta > 0 ? 'var(--grn)' : delta < 0 ? 'var(--red)' : 'var(--faint)';
        return `<div class="genome-delta">
          <span class="gd-label">${dimLabels[key]||key}</span>
          <div class="gd-bar"><div class="gd-fill" style="width:${afterVal}%;background:${col}"></div></div>
          <span class="gd-arrow ${arrowCls(delta)}">${arrowSym(delta)}${Math.abs(delta)}</span>
        </div>`;
      }).join('')}
      ${keptTags.length || newTags.length || lostTags.length ? `<div class="genome-tags">
        ${keptTags.map(t => `<span class="gt">${t}</span>`).join('')}
        ${newTags.map(t => `<span class="gt new">+${t}</span>`).join('')}
        ${lostTags.map(t => `<span class="gt lost">${t}</span>`).join('')}
      </div>` : ''}
      ${ag.dominantBelief ? `<div class="gc-belief"><b>Belief:</b> "${ag.dominantBelief}"</div>` : ''}
      ${ag.cycleSummary ? `<div class="gc-summary">${ag.cycleSummary}${ag.trustBuilt ? ` ¬∑ Trust: ${ag.trustBuilt}` : ''}</div>` : ''}
    </div>`;
  }).join('')}</div>`;
}

function viewReport(cycleNum) {
  const r = cycleReports.find(x=>x.cycle===cycleNum);
  if(!r){ goTo(3); return; }
  goTo(3);
  document.querySelectorAll('.rn-item').forEach(el=>el.classList.remove('active'));
  const ni = document.getElementById('rni-'+cycleNum);
  if(ni) ni.classList.add('active');

  // ‚îÄ‚îÄ helpers ‚îÄ‚îÄ
  const bar = (val, max, cls, w=80) =>
    `<div style="display:inline-flex;align-items:center;gap:.4rem;width:${w}px">
      <div style="flex:1;height:4px;background:var(--faint);border-radius:2px;overflow:hidden">
        <div style="width:${Math.round(val/max*100)}%;height:100%;background:${cls};border-radius:2px"></div>
      </div>
      <span style="font-size:.68rem;color:var(--dim);width:28px;text-align:right;flex-shrink:0">${val}</span>
    </div>`;

  const corrBar = (r_val) => {
    const pct = Math.round(Math.abs(r_val)*100);
    const col = r_val > 0.6 ? 'var(--grn)' : r_val > 0.3 ? 'var(--gold)' : 'var(--faint)';
    return `<div class="corr-bar-track"><div class="corr-bar-fill" style="width:${pct}%;background:${col}"></div></div>`;
  };

  const corrStrength = (v) => Math.abs(v)>0.7?'Strong':Math.abs(v)>0.4?'Moderate':'Weak';
  const sign = (v) => v>=0 ? '+'+v : ''+v;
  const fmtC = (n) => n.toLocaleString();

  // ‚îÄ‚îÄ Section 1: KPI strip ‚îÄ‚îÄ
  const winnerShare = r.winnerShare || Math.round(r.winner.credits/r.totalCredits*100);
  const top3Share   = r.top3Share || 0;
  const kpiHtml = `
    <div class="kpi-strip">
      <div class="kpi-cell"><div class="kpi-val neu">${r.winner.credits.toLocaleString()}‚¨°</div><div class="kpi-lbl">Winner Credits</div></div>
      <div class="kpi-cell"><div class="kpi-val">${winnerShare}%</div><div class="kpi-lbl">Winner Vote Share</div></div>
      <div class="kpi-cell"><div class="kpi-val">${top3Share}%</div><div class="kpi-lbl">Top 3 Capture</div></div>
      <div class="kpi-cell"><div class="kpi-val ${r.gini>0.4?'down':r.gini>0.25?'':'up'}">${r.gini}</div><div class="kpi-lbl">Gini (Concentration)</div></div>
      <div class="kpi-cell"><div class="kpi-val">${r.topCorr||'‚Äî'}</div><div class="kpi-lbl">Top Vote Predictor</div></div>
      <div class="kpi-cell"><div class="kpi-val ${(r.novSlope||0)>0?'up':'down'}">${sign(r.novSlope||0)}‚¨°</div><div class="kpi-lbl">Novelty Premium/pt</div></div>
    </div>`;

  // ‚îÄ‚îÄ Section 2: Top-3 images (placeholders, populated after render) ‚îÄ‚îÄ
  const top3Html = `
    <div class="rdoc-top3" id="rdoc-top3-${r.cycle}">
      ${r.sortedDesigns.slice(0,3).map((d,i) => {
        const rankLabels = ['1st Place','2nd Place','3rd Place'];
        const rankCls = ['r1','',''];
        return `<div class="rdoc-imgcard rank${i+1}">
          <div class="rdoc-img-wrap">
            <div class="rdoc-img-placeholder" id="rph-${r.cycle}-${i}"></div>
            <img class="rdoc-img" id="rimg-${r.cycle}-${i}" alt="${d.name}" />
          </div>
          <div class="rdoc-card-meta">
            <div class="rdoc-rank-badge ${rankCls[i]}">${rankLabels[i]}</div>
            <div class="rdoc-design-name">"${d.name}"</div>
            <div class="rdoc-design-by">${d.agentName||'Agent'} ¬∑ ${d.cat}</div>
            <div class="rdoc-design-creds">${fmtC(d.credits||0)} ‚¨° &nbsp;¬∑&nbsp; ${winnerShare}% share</div>
            <div style="font-size:.62rem;color:var(--faint);margin-top:.3rem">AES ${d.aesthetic} ¬∑ NOV ${d.novelty} ¬∑ PRO ${d.profit}</div>
          </div>
        </div>`;
      }).join('')}
    </div>`;

  // ‚îÄ‚îÄ Section 3: Score √ó Credits correlation panel ‚îÄ‚îÄ
  const corrHtml = `
    <div class="corr-panel">
      ${[
        {dim:'Aesthetic', key:'corrAes', cls:'aes', col:'var(--gold)'},
        {dim:'Novelty',   key:'corrNov', cls:'nov', col:'#7bb8d4'},
        {dim:'Profit',    key:'corrPro', cls:'pro', col:'#7be0a8'},
      ].map(({dim,key,cls,col})=>{
        const val = r[key]||0;
        const isTop = r.topCorr===dim;
        return `<div class="corr-card">
          <div class="corr-dim">${dim} Score</div>
          <div class="corr-bar-track"><div class="corr-bar-fill ${cls}" style="width:${Math.round(Math.abs(val)*100)}%"></div></div>
          <div class="corr-r" style="color:${col}">r = ${val}</div>
          <div class="corr-note">${corrStrength(val)} ${val>=0?'positive':'negative'} correlation with credits</div>
          ${isTop?`<div class="corr-winner-badge">Top Predictor</div>`:''}
        </div>`;
      }).join('')}
    </div>
    <div style="font-size:.75rem;color:var(--faint);line-height:1.6;margin-top:.5rem">
      r = Pearson correlation coefficient. Values near ¬±1 indicate strong linear relationship between score and credits received.
      ${r.topCorr==='Novelty'?'<b style="color:var(--txt)"> Novelty dominated this cycle</b> ‚Äî agents are rewarding fresh ideas over safe margins.':
        r.topCorr==='Aesthetic'?'<b style="color:var(--txt)"> Aesthetic was the market driver</b> ‚Äî visual design quality outweighed financial logic.':
        '<b style="color:var(--txt)"> Profit drove consensus</b> ‚Äî agents voted rationally toward high-margin pieces.'}
    </div>`;

  // ‚îÄ‚îÄ Section 4: Strategy battle ‚îÄ‚îÄ
  const sp = r.stratPerf || {};
  const stratHtml = `
    <div class="strat-battle">
      ${['exploit','explore','mutate'].map(s=>{
        const d = sp[s]||{count:0,avgCreds:0,won:0};
        const isWin = r.winner.strategy===s;
        const col = s==='exploit'?'var(--gold-d)':s==='explore'?'var(--blu)':'var(--purp)';
        return `<div class="sb-card ${isWin?'sb-winner':''}">
          ${isWin?`<div class="sb-win-flag">Winning Strategy</div>`:''}
          <div class="sb-label strat-badge strat-${s}">${s.toUpperCase()}</div>
          <div class="sb-creds" style="color:${col}">${fmtC(d.avgCreds)}‚¨°</div>
          <div class="sb-sub">avg per design ¬∑ ${d.count} design${d.count!==1?'s':''}</div>
        </div>`;
      }).join('')}
    </div>
    <div style="font-size:.75rem;color:var(--faint);margin-top:.5rem;line-height:1.6">
      ${Object.entries(sp).filter(([,v])=>v.count>0).sort((a,b)=>b[1].avgCreds-a[1].avgCreds).map(([k,v],i)=>
        i===0?`<b style="color:var(--txt)">${k.toUpperCase()}</b> strategies earned ${v.count>1?v.avgCreds.toLocaleString()+'‚¨° avg':'the cycle win'}${sp.exploit&&sp.explore?', outperforming by '+(v.avgCreds-(Object.entries(sp).find(([k2])=>k2!==k)?.[1]?.avgCreds||v.avgCreds)).toLocaleString()+'‚¨°':''}.`:''
      ).join('')}
    </div>`;

  // ‚îÄ‚îÄ Section 5: Category heat map ‚îÄ‚îÄ
  const catHtml = `
    <table class="cat-heat">
      <thead><tr><th>Category</th><th>Entries</th><th>Pool %</th><th>Avg Credits</th><th>Avg Aesthetic</th><th>Avg Novelty</th><th>Status</th></tr></thead>
      <tbody>${Object.entries(r.catMap||r.catCount).map(([cat, data])=>{
        const isObj = typeof data === 'object' && data !== null && 'count' in data;
        const count = isObj ? data.count : data;
        const avgC  = isObj && data.totalCreds ? Math.round(data.totalCreds/count) : 0;
        const avgA  = isObj && data.totalAes   ? Math.round(data.totalAes/count)   : 0;
        const avgN  = isObj && data.totalNov   ? Math.round(data.totalNov/count)   : 0;
        const poolPct = Math.round(count/r.designs.length*100);
        const status = poolPct>45?'<span style="color:var(--red)">‚ö† Over-saturated</span>':
                       poolPct<17?'<span style="color:var(--grn)">‚Üó Opportunity</span>':'Balanced';
        return `<tr>
          <td><b>${cat}</b></td>
          <td>${count}</td>
          <td>${bar(poolPct, 100, poolPct>45?'var(--red)':'var(--gold-d)', 60)}</td>
          <td>${avgC>0?fmtC(avgC)+'‚¨°':'‚Äî'}</td>
          <td>${avgA>0?bar(avgA, 100, 'var(--gold)', 60):'‚Äî'}</td>
          <td>${avgN>0?bar(avgN, 100, '#4a7fa8', 60):'‚Äî'}</td>
          <td>${status}</td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;

  // ‚îÄ‚îÄ Section 6: Agent leaderboard ‚îÄ‚îÄ
  const sortedAgents = [...(r.agentPerf||[])].sort((a,b)=>a.rank-b.rank);
  const lbHtml = `
    <table class="agent-lb">
      <thead><tr><th style="width:32px">#</th><th>Agent</th><th>Design</th><th>Strategy</th><th>Credits Earned</th><th>Credits Spent</th><th>ROI</th><th>Rep</th><th>Delta</th></tr></thead>
      <tbody>${sortedAgents.map((a,i)=>`
        <tr>
          <td class="rank-num ${i===0?'r1':''}">${i+1}</td>
          <td>${a.emoji||''} ${a.name}${a.isUser?'<span class="you-badge">YOU</span>':''}</td>
          <td style="font-style:italic;color:var(--txt)">"${a.designName}"</td>
          <td><span class="strat-badge strat-${a.strategy}">${a.strategy.toUpperCase()}</span></td>
          <td class="gold" style="color:${i===0?'var(--gold)':'var(--dim)'}">${fmtC(a.earned)}‚¨°</td>
          <td>${fmtC(a.spent)}‚¨°</td>
          <td style="color:${a.roi>=1?'var(--grn)':'var(--red)'}">${a.roi}√ó</td>
          <td>${a.reputation}</td>
          <td class="rep-delta ${a.repDelta>0?'rep-up':a.repDelta<0?'rep-dn':''}">${sign(a.repDelta)}</td>
        </tr>`).join('')}
      </tbody>
    </table>`;

  // ‚îÄ‚îÄ Section 7: Vote flow matrix ‚îÄ‚îÄ
  const vm = r.voteMatrix || r.vm;
  const voteFlowHtml = `
    <table class="vflow-table">
      <thead><tr><th>Voter</th><th>Allocations (Self-votes highlighted)</th><th>Total Spent</th><th>Biggest Bet</th></tr></thead>
      <tbody>${(r.agentSnapshot||[]).map((voter,vi)=>{
        const voteData = vm?.[vi]||[];
        const total = voteData.reduce((s,v)=>s+v,0);
        const myDesignIdx = r.designs.findIndex(d=>d.agentIdx===vi);
        const allocations = voteData.map((v,di)=>{
          if (!v) return '';
          const dname = r.designs[di]?.name || r.sortedDesigns[di]?.name || '‚Äî';
          const isSelf = di===myDesignIdx;
          return `<span class="vf-alloc ${isSelf?'vf-self':''}">${dname}: ${fmtC(v)}‚¨°${isSelf?' ‚Üêself':''}</span>`;
        }).filter(Boolean).join('');
        const biggestIdx = voteData.indexOf(Math.max(...voteData));
        const biggestName = r.designs[biggestIdx]?.name || '‚Äî';
        return `<tr>
          <td>${voter.emoji||''} ${voter.name}</td>
          <td>${allocations||'‚Äî'}</td>
          <td class="gold">${fmtC(total)}‚¨°</td>
          <td style="font-style:italic;color:var(--txt)">"${biggestName}"</td>
        </tr>`;
      }).join('')}
      </tbody>
    </table>
    <div class="vote-insight">
      <b>Self-vote rate:</b> ${r.selfVotePct||0}% of all credits went to agents' own designs &nbsp;¬∑&nbsp;
      <b>Strongest alignment:</b> ${(r.alignPair||['‚Äî','‚Äî']).join(' + ')} voted for the same design &nbsp;¬∑&nbsp;
      <b>Market consensus:</b> Top 3 designs captured ${top3Share}% of all credits
    </div>`;

  // ‚îÄ‚îÄ Section 8: Trend velocity + 4-grid ‚îÄ‚îÄ
  const vel = r.trendData?.velocityScore || 70;
  const trendHtml = `
    <div class="trend-vel">
      <div class="vel-label">Velocity</div>
      <div class="vel-meter"><div class="vel-fill" style="width:${vel}%"></div></div>
      <div class="vel-score">${vel}</div>
    </div>
    <div class="trend-4grid">
      <div class="tcard"><div class="tcard-label">Emerging Styles</div><div class="tcard-val up">${(r.trendData?.emerging||[]).join(' ¬∑ ')}</div></div>
      <div class="tcard"><div class="tcard-label">Declining Styles</div><div class="tcard-val down">${(r.trendData?.declining||[]).join(' ¬∑ ')}</div></div>
      <div class="tcard"><div class="tcard-label">Saturation Warning</div><div class="tcard-val down">${r.trendData?.saturation||'‚Äî'}</div><div class="tcard-sub">Gini ${r.gini} concentration index</div></div>
      <div class="tcard"><div class="tcard-label">Treasury Signal</div><div class="tcard-val up">${r.trendData?.treasury||'‚Äî'}</div><div class="tcard-sub">Highest combined AES + PRO</div></div>
    </div>`;

  // ‚îÄ‚îÄ Section 9: FI box ‚îÄ‚îÄ
  const fiHtml = `
    <div class="fi-box">
      <div class="fi-title">‚óÜ Loaded into shared knowledge database at start of Cycle ${r.cycle+1}</div>
      ${(r.trendData?.fi||[]).map(f=>`<div class="fi-item">${f}</div>`).join('')}
    </div>`;

  // ‚îÄ‚îÄ Section 10: Epoch Arc (cycle 3 only) ‚îÄ‚îÄ
  let epochHtml = '';
  if (r.cycle === 3 && cycleReports.length === 3) {
    const [c1,c2,c3] = cycleReports;
    const epochTrends = ['Minimal / Negative-space','Architectural Minimal','Organic / Sculptural'];
    const epochStrats = [
      c1.sortedDesigns.filter(d=>d.strategy==='explore').length + ' explore',
      c2.sortedDesigns.filter(d=>d.strategy==='exploit').length + ' exploit',
      c3.sortedDesigns.filter(d=>d.strategy==='explore').length + ' explore'
    ];
    epochHtml = `
      <div class="epoch-arc">
        <div class="epoch-arc-title">Epoch Arc ‚Äî 3-Cycle Trend Lifecycle</div>
        <div class="epoch-timeline">
          ${[c1,c2,c3].map((cx,i)=>`
          <div class="et-node">
            <div class="et-cycle">Cycle ${cx.cycle} ¬∑ ${cx.date}</div>
            <div class="et-winner">"${cx.winner.name}"</div>
            <div class="et-trend">${epochTrends[i]}</div>
            <div class="et-creds">${fmtC(cx.winner.credits)}‚¨°</div>
            <div style="font-size:.6rem;color:var(--faint);margin-top:.3rem">${epochStrats[i]} dominant</div>
          </div>`).join('')}
        </div>
        <div class="epoch-insight">
          <b>Trend lifecycle confirmed:</b> ${epochTrends[0]} emerged in Cycle 1 (${c1.winner.credits.toLocaleString()}‚¨° winner),
          peaked in Cycle 2 under exploitation pressure (${c2.winner.credits.toLocaleString()}‚¨°, ring saturation ${c2.trendData?.saturation}),
          and was displaced in Cycle 3 as ${epochTrends[2]} generated the highest vote concentration of the epoch (${c3.winner.credits.toLocaleString()}‚¨°, Gini ${c3.gini}).
          <br><br>
          <b>Vote predictor evolution:</b> C1 ${c1.topCorr} (r=${c1.corrAes}) ‚Üí C2 ${c2.topCorr} (r=${c2.corrAes}) ‚Üí C3 ${c3.topCorr} (r=${c3.corrNov}) ‚Äî
          the market shifted from rewarding <i>aesthetics</i> toward rewarding <i>novelty</i> as the pool saturated.
          <br><br>
          <b>Compounding novelty premium:</b> C1 ${sign(c1.novSlope)}‚¨°/pt ‚Üí C2 ${sign(c2.novSlope)}‚¨°/pt ‚Üí C3 ${sign(c3.novSlope)}‚¨°/pt.
          ${c3.novSlope>c1.novSlope?'Novelty became progressively more valuable over the epoch ‚Äî agents who built novelty into their genome compounded their advantage.':'The novelty premium declined as exploitation strategies dominated mid-epoch.'}
          <br><br>
          <b>Full epoch circulated:</b> ${fmtC((c1.totalCredits||0)+(c2.totalCredits||0)+(c3.totalCredits||0))}‚¨° across 18 designs.
        </div>
      </div>`;
  }

  // ‚îÄ‚îÄ Section 11: Image Generation Prompts ‚îÄ‚îÄ
  const promptHtml = `
    <table class="rtable">
      <thead><tr><th style="width:160px">Design</th><th>Image Generation Prompt</th></tr></thead>
      <tbody>${[...r.designs].sort((a,b)=>a.rank-b.rank).map(d=>`
        <tr class="${d.rank<=3?'highlight-row':''}">
          <td><b>${d.rank===1?'üèÜ ':''}#${d.rank} ${d.name}</b><br><span style="color:var(--faint);font-size:.65rem">${d.agentName||'Agent'}</span></td>
          <td><div class="prompt-box">${d.prompt}</div></td>
        </tr>`).join('')}
      </tbody>
    </table>`;

  const html = `
    <div class="rdoc fade">
      <div class="rdoc-header">
        <div class="rdoc-title">Cycle ${r.cycle} ‚Äî Intelligence Report</div>
        <div class="rdoc-meta">Generated ${r.date} at ${r.time||''} &nbsp;¬∑&nbsp; 6 Agents &nbsp;¬∑&nbsp; ${r.designs.length} Designs &nbsp;¬∑&nbsp; ${fmtC(r.totalCredits)}‚¨° Circulated</div>
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Key Performance Indicators</div>
        ${kpiHtml}
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Top 3 Designs ‚Äî AI Rendered from Agent Prompts</div>
        ${top3Html}
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Score √ó Credits Correlation Analysis</div>
        ${corrHtml}
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Strategy Performance ‚Äî Exploit vs Explore vs Mutate</div>
        ${stratHtml}
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Category Heat Map</div>
        ${catHtml}
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Agent Leaderboard ‚Äî Credits ¬∑ ROI ¬∑ Reputation</div>
        ${lbHtml}
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Agent Genome Evolution ‚Äî Before ‚Üí After Cycle ${r.cycle}</div>
        ${buildGenomeEvolutionHtml(r)}
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Vote Flow Matrix</div>
        ${voteFlowHtml}
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Trend Consensus & Velocity</div>
        ${trendHtml}
      </div>

      ${r.cycle===3 && epochHtml ? `<div class="rsec"><div class="rsec-hdr">Epoch Arc ‚Äî Full Trend Lifecycle</div>${epochHtml}</div>` : ''}

      <div class="rsec">
        <div class="rsec-hdr">Forward Intelligence ‚Äî Loaded into Agent Knowledge Base for Cycle ${r.cycle < 3 ? r.cycle+1 : 'N/A'}</div>
        ${fiHtml}
        ${r.cycle===3?`<div style="margin-top:1rem;padding:1rem;border:1px solid var(--gold-d);background:rgba(201,168,76,.04);font-size:.82rem;color:var(--dim);line-height:1.7">
          <b style="color:var(--gold)">Epoch Complete.</b> 3-cycle compound dataset compiled.
          Trend lifecycle documented autonomously: emergence ‚Üí exploitation ‚Üí saturation ‚Üí displacement.
          Total epoch volume: ${fmtC((cycleReports[0]?.totalCredits||0)+(cycleReports[1]?.totalCredits||0)+(r.totalCredits||0))}‚¨°.
        </div>`:''}
      </div>

      <div class="rsec">
        <div class="rsec-hdr">Final Image Generation Prompts</div>
        ${promptHtml}
      </div>
    </div>`;

  document.getElementById('report-view-area').innerHTML = html;

  // Attach image events via DOM after render ‚Äî staggered to avoid rate limits
  r.sortedDesigns.slice(0,3).forEach((d, i) => {
    const phEl  = document.getElementById(`rph-${r.cycle}-${i}`);
    const imgEl = document.getElementById(`rimg-${r.cycle}-${i}`);
    if (!imgEl) return;
    if (phEl) phEl.textContent = d.emoji;
    const seed = (d.agentIdx * 1000 + r.cycle * 100 + i * 17 + 42) | 0;
    let retried = false;
    imgEl.onload = () => { imgEl.classList.add('loaded'); if(phEl) phEl.classList.add('hidden'); };
    imgEl.onerror = () => {
      if (!retried) {
        retried = true;
        const shortPrompt = (d.cat || 'jewelry') + ' ' + (d.name || 'design').slice(0, 40);
        setTimeout(() => { imgEl.src = makeImgUrlFree(shortPrompt, seed + 1); }, 2000);
      } else {
        if (imgEl) imgEl.style.display = 'none';
      }
    };
    const staggerDelay = i * 5000;
    if (apiKeys.higgsfield) {
      setTimeout(() => {
        resolveImgUrl(d.prompt, seed).then(url => { imgEl.src = url; }).catch(() => { imgEl.src = makeImgUrlFree(d.prompt, seed); });
      }, staggerDelay);
    } else {
      setTimeout(() => { imgEl.src = makeImgUrlFree(d.prompt, seed); }, staggerDelay);
    }
  });

  // Animate velocity bar after render
  setTimeout(()=>{
    const vf = document.querySelector('.vel-fill');
    if(vf) vf.style.width = (r.trendData?.velocityScore||70)+'%';
  }, 100);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   EXPORT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function exportAllReports() {
  let content = 'JEWELFORGE ‚Äî EPOCH INTELLIGENCE ARCHIVE\n';
  content += '==========================================\n\n';
  cycleReports.forEach(r => {
    content += `CYCLE ${r.cycle} REPORT ‚Äî ${r.date}\n`;
    content += `Winner: "${r.winner.name}" by ${r.winner.agentName} (${r.winner.credits.toLocaleString()}‚¨°)\n\n`;
    content += `AGENT DECISIONS:\n`;
    r.designs.forEach(d => { content += `  ${d.agentName} ‚Äî ${d.strategy.toUpperCase()} ‚Äî ${d.name} (${d.cat}) ‚Äî Rank #${d.rank}\n`; });
    content += `\nPROMPTS:\n`;
    r.designs.sort((a,b)=>a.rank-b.rank).forEach(d => { content += `  [${d.name}] ${d.prompt}\n`; });
    content += `\nTREND CONSENSUS:\n`;
    content += `  Emerging: ${r.trendData.emerging.join(', ')}\n`;
    content += `  Declining: ${r.trendData.declining.join(', ')}\n`;
    content += `\nFORWARD INTELLIGENCE:\n`;
    r.trendData.fi.forEach(f => { content += `  ‚Ä¢ ${f}\n`; });
    content += '\n' + '‚îÄ'.repeat(50) + '\n\n';
  });
  const blob = new Blob([content], {type:'text/plain'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'JewelForge_Epoch_Intelligence_Archive.txt'; a.click();
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   NAVIGATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function goTo(n) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+n).classList.add('active');
  ['nt0','nt1','nt2','nt3'].forEach((id,i)=>{
    const el=document.getElementById(id); el.className='nav-tab';
    if(i<n) el.classList.add('done'); else if(i===n) el.classList.add('active');
  });
}

function setSpd(s,btn){ speed=s; document.querySelectorAll('.spd-btn').forEach(b=>b.classList.remove('on')); btn.classList.add('on'); }

// Init
updatePreview(); renderDNA();
</script>
</body>
</html>
